<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu ƒê√°nh Gi√° Hi·ªán Tr·∫°ng L·ªëp</title>
    <style>
        /* Reset CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 15px; }
        .container { max-width: 750px; margin: 0 auto; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; }
        .form-section { padding: 15px; }
        .print-section {
            background: white; width: 148mm; /* Chi·ªÅu r·ªông A5 */
            height: 205mm; /* ƒê·ªß kh√¥ng gian ƒë·ªÉ ch·ªØ to h∆°n, s·∫Ω ph·ª• thu·ªôc v√†o c√†i ƒë·∫∑t in c·ªßa tr√¨nh duy·ªát */
            margin: 0 auto; padding: 7mm; /* Gi·ªØ padding ƒë·ªÉ n·ªôi dung kh√¥ng qu√° s√°t m√©p */
            font-size: 11px; /* TƒÇNG FONT T·ªîNG TH·ªÇ */
            line-height: 1.25; /* TƒÉng line-height ƒë·ªÉ d·ªÖ ƒë·ªçc */
            overflow: hidden;
        }
        .header { display: flex; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .logo { width: 65px; height: 65px; background: transparent; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 26px; margin-right: 15px; }
        .company-info { flex: 1; }
        .company-name { font-size: 17px; font-weight: bold; color: #4472C4; margin-bottom: 3px; }
        .company-details { font-size: 10.5px; color: #666; line-height: 1.15; }
        .qr-code { width: 45px; height: 45px; background: transparent; display: flex; align-items: center; justify-content: center; color: white; font-size: 9px; }
        .title { text-align: center; font-size: 15px; font-weight: bold; background: #4472C4; color: white; padding: 6px; margin-bottom: 10px; }
        .tread-depth-section { display: flex; margin-bottom: 12px; }
        .depth-legend { flex: 1; margin-right: 20px; }
        .legend-title { font-weight: bold; margin-bottom: 8px; font-size: 12px; }
        .legend-items { display: flex; flex-wrap: wrap; gap: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; }
        .shape { width: 16px; height: 11px; border: 1px solid; }
        .green-square { border-color: #00B050; background: #00B050; }
        .yellow-triangle { width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-bottom: 13px solid #FFC000; }
        .red-circle { border-color: #C5504B; border-radius: 50%; background: #C5504B; }
        .tire-positions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; margin-bottom: 5px; }
        .position { text-align: center; font-size: 11px; }
        .position-label { font-weight: bold; margin-bottom: 3px; }
        .position-shapes { display: flex; justify-content: center; gap: 2px; }
        .recommendations { flex: 1; border: 1px solid #ccc; padding: 8px; }
        .rec-title { font-weight: bold; margin-bottom: 8px; font-size: 12px; }
        .rec-item { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; font-size: 10.5px; }
        .checkbox { width: 13px; height: 13px; border: 1px solid #333; }
        .car-diagram { text-align: center; margin: 12px 0; position: relative; width: 190px; height: 285px; margin-left: auto; margin-right: auto;} /* Set explicit size for the container */
        .car-diagram img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; } /* Make the image fill the container */
        .car-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible; } /* Overlay SVG on top of the image */
        /* TƒÉng k√≠ch th∆∞·ªõc font cho c√°c th√¥ng s·ªë l·ªëp tr√™n SVG */
        .tire-measurements text { font-size: 8px; } /* Font cho mm v√† kg/cm2 */
        .tire-measurements rect { stroke-width: 0.6; }
        .tire-measurements g[transform*="translate"] rect { width: 48px; height: 20px; }
        .tire-measurements g[transform*="translate"] text { font-size: 8px; } /* Font cho gi√° tr·ªã mm */
        .tire-measurements g[transform*="translate"] rect[fill="#4472C4"] { height: 16px; }
        .tire-measurements g[transform*="translate"] text[fill="white"] { font-size: 7px; } /* Font cho gi√° tr·ªã kg/cm2 */
        #tire-size-box { stroke-width: 1.1; }
        #tire-size-text { font-size: 10px; font-weight: bold; fill: red; } /* Font cho Size L·ªëp */

        /* CSS cho DOT v√† Hi·ªáu l·ªëp */
        .tire-dot-brand text { font-size: 6.5px; fill: #555; } /* Font cho DOT v√† Hi·ªáu */
        .tire-dot-brand rect { fill: #f0f0f0; stroke: #aaa; stroke-width: 0.5; }
        /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ c·ªßa nh√£n DOT v√† Hi·ªáu l·ªëp */
        .tire-dot-brand-fl { transform: translate(-50px, 85px); } /* V·ªã tr√≠ cho FL */
        .tire-dot-brand-fr { transform: translate(160px, 85px); } /* V·ªã tr√≠ cho FR */
        .tire-dot-brand-rl { transform: translate(-50px, 185px); } /* V·ªã tr√≠ cho RL */
        .tire-dot-brand-rr { transform: translate(160px, 185px); } /* V·ªã tr√≠ cho RR */
        .tire-dot-brand-spare { transform: translate(56px, 230px); } /* V·ªã tr√≠ cho l·ªëp d·ª± ph√≤ng */


        .note-section { margin-top: 10px; font-size: 11px; } /* Font cho L∆∞u √Ω v√† Hi·ªán tr·∫°ng l·ªëp */
        .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 12px; } /* Font cho th√¥ng tin chung cu·ªëi phi·∫øu */
        .info-item { border-bottom: 1px dotted #333; padding-bottom: 2px; }
        .controls { padding: 20px; background: #f8f9fa; border-top: 1px solid #ddd; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .control-group input, .control-group select, .control-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .tire-inputs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; }
        .tire-input-group { border: 1px solid #ddd; padding: 5px; border-radius: 4px; background: white; }
        .tire-input-group h4 { margin-bottom: 10px; text-align: center; color: #4472C4; }
        .depth-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .depth-inputs input { width: 100px; padding: 4px; font-size: 12px; text-align: center; }
        .pressure-input { width: 100%; width: 130px; padding: 4px; text-align: center; }
        
        /* Inputs for DOT and Brand */
        .dot-brand-inputs { display: flex; gap: 5px; margin-top: 5px; }
        .dot-brand-inputs input { width: calc(50% - 5px); padding: 4px; font-size: 12px; text-align: center; }

        .buttons { display: flex; gap: 10px; justify-content: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #4472C4; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:hover { opacity: 0.8; }

        /* CSS cho ch·∫ø ƒë·ªô in */
        @media print {
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            .container { box-shadow: none; max-width: none; }
            .form-section, .controls { display: none; }
            .print-section {
                width: 148mm; height: 205mm; /* ƒê·∫£m b·∫£o chi·ªÅu cao n√†y ƒë·ªÉ v·ª´a 1 trang A5 (210mm - 5mm l·ªÅ t·ªïng c·ªông) */
                margin: 0; padding: 7mm; /* Gi·ªØ padding ƒë·ªÉ n·ªôi dung kh√¥ng qu√° s√°t m√©p */
                page-break-inside: avoid; font-size: 11px; /* √Åp d·ª•ng font size cho in */
                line-height: 1.25;
            }
            /* ƒê·∫£m b·∫£o c√°c ph·∫ßn t·ª≠ SVG v√† ·∫£nh ƒë∆∞·ª£c in ƒë√∫ng k√≠ch th∆∞·ªõc */
            .car-diagram {
                width: 190px !important; height: 285px !important;
            }
            .car-diagram img {
                width: 100% !important; height: 100% !important;
            }
            .car-svg {
                width: 100% !important; height: 100% !important;
            }
            /* ƒê·∫£m b·∫£o c√°c font size ƒë∆∞·ª£c √°p d·ª•ng khi in */
            .tire-measurements text {
                font-size: 8px !important;
            }
            .tire-measurements rect {
                stroke-width: 0.6 !important;
            }
            .tire-measurements g[transform*="translate"] rect {
                width: 48px !important; height: 20px !important;
            }
            .tire-measurements g[transform*="translate"] text {
                font-size: 8px !important;
            }
            .tire-measurements g[transform*="translate"] rect[fill="#4472C4"] {
                height: 16px !important;
            }
            .tire-measurements g[transform*="translate"] text[fill="white"] {
                font-size: 7px !important;
            }

            /* Print-specific styles for DOT and Brand */
            .tire-dot-brand text { font-size: 6.5px !important; fill: #555 !important; }
            .tire-dot-brand rect { fill: #f0f0f0 !important; stroke: #aaa !important; stroke-width: 0.5 !important; }
            .tire-dot-brand-fl { transform: translate(-50px, 85px) !important; }
            .tire-dot-brand-fr { transform: translate(160px, 85px) !important; }
            .tire-dot-brand-rl { transform: translate(-50px, 185px) !important; }
            .tire-dot-brand-rr { transform: translate(160px, 185px) !important; }
            .tire-dot-brand-spare { transform: translate(56px, 230px) !important; }

            #tire-size-box {
                stroke-width: 1.1 !important;
            }
            #tire-size-text {
                font-size: 10px !important; font-weight: bold !important;
            }
            .logo {
                width: 65px !important; height: 65px !important; font-size: 26px !important;
            }
            .qr-code {
                width: 45px !important; height: 45px !important; font-size: 9px !important;
            }
            .company-name {
                font-size: 17px !important;
            }
            .company-details {
                font-size: 10.5px !important;
            }
            .title {
                font-size: 15px !important;
            }
            .legend-title {
                font-size: 12px !important;
            }
            .legend-item {
                font-size: 11px !important;
            }
            .shape {
                width: 16px !important; height: 11px !important;
            }
            .yellow-triangle {
                border-left: 9px solid transparent !important; border-right: 9px solid transparent !important;
                border-bottom: 13px solid #FFC000 !important;
            }
            .position {
                font-size: 11px !important;
            }
            .rec-title {
                font-size: 12px !important;
            }
            .rec-item {
                font-size: 10.5px !important;
            }
            .checkbox {
                width: 13px !important; height: 13px !important;
            }
            .note-section {
                font-size: 11px !important;
            }
            .info-section {
                font-size: 12px !important;
            }
            /* ƒê·∫£m b·∫£o l·ªÅ trang in ƒë∆∞·ª£c ƒë·∫∑t t·ªëi thi·ªÉu */
            @page {
                size: A5 portrait; /* ƒê·∫£m b·∫£o k√≠ch th∆∞·ªõc A5 v√† h∆∞·ªõng d·ªçc */
                margin: 3mm; /* L·ªÅ ƒë·ªÅu 3mm cho t·∫•t c·∫£ c√°c c·∫°nh */
            }
            /* CSS cho QR code */
            #qrcode-container {
                /* ƒê·∫£m b·∫£o container n√†y c√≥ position relative ƒë·ªÉ ƒë·ªãnh v·ªã QR code b√™n trong */
                position: relative;
                width: 30mm; /* ƒêi·ªÅu ch·ªânh chi·ªÅu r·ªông theo khung ƒë·ªè c·ªßa b·∫°n */
                height: 25mm; /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao theo khung ƒë·ªè c·ªßa b·∫°n */
                display: flex; /* C√≥ th·ªÉ b·ªè d√≤ng n√†y n·∫øu kh√¥ng c·∫ßn cƒÉn ch·ªânh flex */
                justify-content: flex-end; /* C√≥ th·ªÉ b·ªè d√≤ng n√†y n·∫øu kh√¥ng c·∫ßn cƒÉn ch·ªânh flex */
            }

            #qr-code-display {
                width: 100%; /* Chi·ªÅu r·ªông b·∫±ng v·ªõi container */
                height: 100%; /* Chi·ªÅu cao b·∫±ng v·ªõi container */
                object-fit: contain; /* ƒê·∫£m b·∫£o h√¨nh ·∫£nh kh√¥ng b·ªã m√©o v√† n·∫±m g·ªçn trong container */
            }
        }
        .hidden { display: none; }
    </style>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="form-section">
            <h2 style="text-align: center; color: #4472C4; margin-bottom: 15px; font-size: 16px;">PHI·∫æU ƒê√ÅNH GI√Å HI·ªÜN TR·∫†NG L·ªêP</h2>
            
            <form id="tireEvaluationForm" action="https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec" method="POST">
                <input type="hidden" name="formType" value="PhieuDanhGiaLop">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="control-group">
                        <label for="tireOverallConditionInput">Hi·ªán tr·∫°ng l·ªëp:</label>
                        <input type="text" id="tireOverallConditionInput" name="tireOverallCondition" placeholder="Nh·∫≠p hi·ªán tr·∫°ng l·ªëp v√† b√°o gi√° l·ªëp n·∫øu c√≥">
                    </div>
                    <div class="control-group">
                        <label for="inspectionDateInput">Ng√†y:</label>
                        <input type="date" id="inspectionDateInput" name="inspectionDate" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="control-group">
                        <label for="licensePlateInput">Bi·ªÉn s·ªë xe:</label>
                        <input type="text" id="licensePlateInput" name="licensePlate" placeholder="Nh·∫≠p bi·ªÉn s·ªë xe">
                    </div>
                    <div class="control-group">
                        <label for="technicianInput">K·ªπ thu·∫≠t vi√™n:</label>
                        <input type="text" id="technicianInput" name="technician" placeholder="T√™n k·ªπ thu·∫≠t vi√™n">
                    </div>
                </div>

                <div class="control-group">
                    <label for="phoneNumberInput">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="phoneNumberInput" name="phoneNumber" placeholder="S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá">
                </div>

                <div class="control-group">
                    <label for="branchSelect">Chi nh√°nh:</label>
                    <select id="branchSelect" name="chiNhanh" class="info-input" required>
                        <option value="">-- Ch·ªçn chi nh√°nh --</option>
                        <option value="Chi Nh√°nh 1 - B√¨nh Ph∆∞·ªõc">Chi Nh√°nh 1 - B√¨nh Ph∆∞·ªõc</option>
                        <option value="Chi Nh√°nh 2 - ƒê·ªìng Xo√†i">Chi Nh√°nh 2 - ƒê·ªìng Xo√†i</option>
                        <option value="Chi Nh√°nh 3 - B√¨nh D∆∞∆°ng">Chi Nh√°nh 3 - B√¨nh D∆∞∆°ng</option>
                    </select>
                </div>
                <h3 style="margin: 15px 0 10px 0; color: #4472C4; font-size: 12px;">Th√¥ng s·ªë l·ªëp xe:</h3>
                <div class="control-group" style="margin-bottom: 15px;">
                    <label for="tireSizeInput">Size l·ªëp:</label>
                    <input type="text" id="tireSizeInput" name="tireSize" placeholder="Nh·∫≠p size l·ªëp (v√≠ d·ª•: 205/55R16)">
                </div>
                
                <div class="tire-inputs">
                    <div class="tire-input-group">
                        <h4>1: FL (Tr∆∞·ªõc tr√°i)</h4>
                        <div class="depth-inputs">
                            <input type="number" id="fl-inner" name="fl_inner_depth" placeholder="Trong (mm)" step="0.1">
                            <input type="number" id="fl-outer" name="fl_outer_depth" placeholder="Ngo√†i (mm)" step="0.1">
                        </div>
                        <input type="number" class="pressure-input" id="fl-pressure" name="fl_pressure" placeholder="√Åp su·∫•t (kg/cm¬≤)" step="0.1">
                        <div class="dot-brand-inputs">
                            <input type="text" id="fl-dot" name="fl_dot" placeholder="DOT" maxlength="4">
                            <input type="text" id="fl-brand" name="fl_brand" placeholder="Hi·ªáu l·ªëp">
                        </div>
                    </div>

                    <div class="tire-input-group">
                        <h4>2: FR (Tr∆∞·ªõc ph·∫£i)</h4>
                        <div class="depth-inputs">
                            <input type="number" id="fr-inner" name="fr_inner_depth" placeholder="Trong (mm)" step="0.1">
                            <input type="number" id="fr-outer" name="fr_outer_depth" placeholder="Ngo√†i (mm)" step="0.1">
                        </div>
                        <input type="number" class="pressure-input" id="fr-pressure" name="fr_pressure" placeholder="√Åp su·∫•t (kg/cm¬≤)" step="0.1">
                        <div class="dot-brand-inputs">
                            <input type="text" id="fr-dot" name="fr_dot" placeholder="DOT" maxlength="4">
                            <input type="text" id="fr-brand" name="fr_brand" placeholder="Hi·ªáu l·ªëp">
                        </div>
                    </div>

                    <div class="tire-input-group">
                        <h4>3: RL (Sau tr√°i)</h4>
                        <div class="depth-inputs">
                            <input type="number" id="rl-inner" name="rl_inner_depth" placeholder="Trong (mm)" step="0.1">
                            <input type="number" id="rl-outer" name="rl_outer_depth" placeholder="Ngo√†i (mm)" step="0.1">
                        </div>
                        <input type="number" class="pressure-input" id="rl-pressure" name="rl_pressure" placeholder="√Åp su·∫•t (kg/cm¬≤)" step="0.1">
                        <div class="dot-brand-inputs">
                            <input type="text" id="rl-dot" name="rl_dot" placeholder="DOT" maxlength="4">
                            <input type="text" id="rl-brand" name="rl_brand" placeholder="Hi·ªáu l·ªëp">
                        </div>
                    </div>

                    <div class="tire-input-group">
                        <h4>4: RR (Sau ph·∫£i)</h4>
                        <div class="depth-inputs">
                            <input type="number" id="rr-inner" name="rr_inner_depth" placeholder="Trong (mm)" step="0.1">
                            <input type="number" id="rr-outer" name="rr_outer_depth" placeholder="Ngo√†i (mm)" step="0.1">
                        </div>
                        <input type="number" class="pressure-input" id="rr-pressure" name="rr_pressure" placeholder="√Åp su·∫•t (kg/cm¬≤)" step="0.1">
                        <div class="dot-brand-inputs">
                            <input type="text" id="rr-dot" name="rr_dot" placeholder="DOT" maxlength="4">
                            <input type="text" id="rr-brand" name="rr_brand" placeholder="Hi·ªáu l·ªëp">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>L·ªëp d·ª± ph√≤ng:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <input type="number" id="spare-depth" name="spare_depth" placeholder="ƒê·ªô s√¢u (mm)" step="0.1">
                        <input type="number" id="spare-pressure" name="spare_pressure" placeholder="√Åp su·∫•t (kg/cm¬≤)" step="0.1">
                    </div>
                    <div class="dot-brand-inputs">
                        <input type="text" id="spare-dot" name="spare_dot" placeholder="DOT" maxlength="4">
                        <input type="text" id="spare-brand" name="spare_brand" placeholder="Hi·ªáu l·ªëp">
                    </div>
                    <label style="margin-top: 8px; display: block; font-size: 10px;">Khuy·∫øn c√°o l·ªëp d·ª± ph√≤ng:</label>
                    <div class="recommendation-checkboxes" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 9px;">
                        <label><input type="checkbox" name="rec_canchinhthuoclai" data-rec-id="can-chinh-thuoc-lai"> C·∫ßn ch·ªânh th∆∞·ªõc l√°i</label>
                        <label><input type="checkbox" name="rec_canbangdong" data-rec-id="can-bang-dong"> C√¢n b·∫±ng ƒë·ªông</label>
                        <label><input type="checkbox" name="rec_daolop" data-rec-id="dao-lop"> ƒê·∫£o l·ªëp</label>
                        <label><input type="checkbox" name="rec_thaythe" data-rec-id="thay-the"> Thay th·∫ø</label>
                    </div>
                </div>

                <h3 style="margin: 15px 0 10px 0; color: #4472C4; font-size: 12px;">Th√¥ng s·ªë B·ªë Th·∫Øng:</h3>
                <div class="control-group">
                    <label for="frontBrakePadInput">B·ªë th·∫Øng tr∆∞·ªõc (%):</label>
                    <input type="number" id="frontBrakePadInput" name="front_brake_pad" placeholder="Nh·∫≠p ƒë·ªô d√†y b·ªë th·∫Øng tr∆∞·ªõc (%)" step="0.1">
                </div>
                <div class="control-group">
                    <label for="rearBrakePadInput">B·ªë th·∫Øng sau (%):</label>
                    <input type="number" id="rearBrakePadInput" name="rear_brake_pad" placeholder="Nh·∫≠p ƒë·ªô d√†y b·ªë th·∫Øng sau (%)" step="0.1">
                </div>
                <div class="control-group">
                    <label for="brakeRecommendationInput">Khuy·∫øn c√°o b·ªë th·∫Øng:</label>
                    <textarea id="brakeRecommendationInput" name="brake_recommendation" placeholder="Nh·∫≠p khuy·∫øn c√°o v·ªÅ b·ªë th·∫Øng"></textarea>
                </div>
                </form>
        </div>

        <div class="controls">
            <div class="buttons">
                <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/tracuu.html'">üìÑ Tra c·ª©u th√¥ng tin xe</button>
                <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra'">üìÑ Phi·∫øu Ki·ªÉm Tra Xe</button>
                <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">üìÑ Phi·∫øu Ki·ªÉm G·∫ßm</button>
                <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/baoduong.html'">üìÑ Phi·∫øu B·∫£o D∆∞·ª°ng</button>
                <button class="btn btn-primary" id="updatePreviewBtn">C·∫≠p nh·∫≠t xem tr∆∞·ªõc</button>
                <button class="btn btn-success" id="submitFormBtn">üì§ G·ª≠i Th√¥ng Tin</button>
                <button class="btn btn-info" id="printFormBtn" style="background-color: #17a2b8; color: white;">üñ®Ô∏è In Phi·∫øu</button>
        <button class="btn btn-danger" id="clearFormBtn" style="background-color: #dc3545; color: white;">üóëÔ∏è X√≥a D·ªØ Li·ªáu ƒê√£ Nh·∫≠p</button>
            </div>
        </div>

        <div class="print-section" id="printSection">
            <div class="header">
                <div class="logo"><img src="Logopl.png" alt="Logo Phi Long" style="height: 50px;"></div>
                <div class="company-info">
                    <div class="company-name">L·ªêP XE PHI LONG B√åNH D∆Ø∆†NG </div>
                    <div class="company-details">
                        H·ªÜ TH·ªêNG L·∫ÆP XE - S·ª¨A CH·ªÆA - CHƒÇM S√ìC √î T√î CAO C·∫§P<br>
                        www.philongauto.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Email: info@philongauto.com<br>
                        0866.478.777 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CSKH: 0866.478.777 - FAX: 0866 478 777
                    </div>
                </div>
            </div>

            <div class="title">PHI·∫æU ƒê√ÅNH GI√Å HI·ªÜN TR·∫†NG L·ªêP</div>

            <div class="tread-depth-section">
                <div class="depth-legend">
                    <div class="legend-title">ƒê·ªô s√¢u gai l·ªëp</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="shape green-square"></div>
                            <span>>4mm</span>
                        </div>
                        <div class="legend-item">
                            <div class="shape yellow-triangle"></div>
                            <span>3-4mm</span>
                        </div>
                        <div class="legend-item">
                            <div class="shape red-circle"></div>
                            <span>1,6 - 3mm</span>
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <div class="tire-positions">
                            <div class="position">
                                <div class="position-label">1: FL</div>
                                <div class="position-shapes" id="fl-shapes">
                                </div>
                            </div>
                            <div class="position">
                                <div class="position-label">2: FR</div>
                                <div class="position-shapes" id="fr-shapes">
                                </div>
                            </div>
                            <div class="position">
                                <div class="position-label">3: RL</div>
                                <div class="position-shapes" id="rl-shapes">
                                </div>
                            </div>
                            <div class="position">
                                <div class="position-label">4: RR</div>
                                <div class="position-shapes" id="rr-shapes">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recommendations">
                    <div class="rec-title">Khuy·∫øn c√°o</div>
                    <div class="rec-item">
                        <div class="checkbox" id="rec-1"></div>
                        <span>C·∫ßn ch·ªânh th∆∞·ªõc l√°i</span>
                    </div>
                    <div class="rec-item">
                        <div class="checkbox" id="rec-2"></div>
                        <span>C√¢n b·∫±ng ƒë·ªông</span>
                    </div>
                    <div class="rec-item">
                        <div class="checkbox" id="rec-3"></div>
                        <span>ƒê·∫£o l·ªëp</span>
                    </div>
                    <div class="rec-item">
                        <div class="checkbox" id="rec-4"></div>
                        <span>Thay th·∫ø</span>
                    </div>
                </div>
            </div>

            <div class="car-diagram">
                <img src="sodooto.png" alt="Car Diagram">
                <svg class="car-svg" viewBox="0 0 160 240">
                    <g id="tire-measurements">
                        <g transform="translate(-50,45)">
                            <rect width="50" height="30" fill="white" stroke="#4472C4"/>
                            <text x="24" y="8" text-anchor="middle" fill="#4472C4">mm</text>
                            <text x="24" y="17" text-anchor="middle" fill="#4472C4" id="fl-display">0/0</text>
                        </g>
                        <g transform="translate(-50, 65)">
                            <rect width="50" height="16" fill="#4472C4"/>
                            <text x="24" y="11" text-anchor="middle" fill="white" id="fl-pressure-display-text">0</text>
                        </g>
                        <g class="tire-dot-brand tire-dot-brand-fl">
                            <rect x="0" y="0" width="50" height="20"/>
                            <text x="25" y="8" text-anchor="middle" id="fl-dot-display">DOT: </text>
                            <text x="25" y="16.5" text-anchor="middle" id="fl-brand-display"></text>
                        </g>
                        
                        <g transform="translate(160, 40)">
                            <rect width="50" height="25" fill="white" stroke="#4472C4"/>
                            <text x="24" y="8" text-anchor="middle" fill="#4472C4">mm</text>
                            <text x="24" y="17" text-anchor="middle" fill="#4472C4" id="fr-display">0/0</text>
                        </g>
                        <g transform="translate(160, 65)">
                            <rect width="50" height="16" fill="#4472C4"/>
                            <text x="24" y="11" text-anchor="middle" fill="white" id="fr-pressure-display-text">0</text>
                        </g>
                        <g class="tire-dot-brand tire-dot-brand-fr">
                            <rect x="0" y="0" width="50" height="20"/>
                            <text x="25" y="8" text-anchor="middle" id="fr-dot-display">DOT: </text>
                            <text x="25" y="16.5" text-anchor="middle" id="fr-brand-display"></text>
                        </g>
                        
                        <g transform="translate(-50, 140)">
                            <rect width="50" height="25" fill="white" stroke="#4472C4"/>
                            <text x="24" y="8" text-anchor="middle" fill="#4472C4">mm</text>
                            <text x="24" y="17" text-anchor="middle" fill="#4472C4" id="rl-display">0/0</text>
                        </g>
                        <g transform="translate(-50, 165)">
                            <rect width="50" height="16" fill="#4472C4"/>
                            <text x="24" y="11" text-anchor="middle" fill="white" id="rl-pressure-display-text">0</text>
                        </g>
                        <g class="tire-dot-brand tire-dot-brand-rl">
                            <rect x="0" y="0" width="50" height="20"/>
                            <text x="25" y="8" text-anchor="middle" id="rl-dot-display">DOT: </text>
                            <text x="25" y="16.5" text-anchor="middle" id="rl-brand-display"></text>
                        </g>
                        
                        <g transform="translate(160, 140)">
                            <rect width="50" height="25" fill="white" stroke="#4472C4"/>
                            <text x="24" y="8" text-anchor="middle" fill="#4472C4">mm</text>
                            <text x="24" y="17" text-anchor="middle" fill="#4472C4" id="rr-display">0/0</text>
                        </g>
                        <g transform="translate(160, 165)">
                            <rect width="50" height="16" fill="#4472C4"/>
                            <text x="24" y="11" text-anchor="middle" fill="white" id="rr-pressure-display-text">0</text>
                        </g>
                        <g class="tire-dot-brand tire-dot-brand-rr">
                            <rect x="0" y="0" width="50" height="20"/>
                            <text x="25" y="8" text-anchor="middle" id="rr-dot-display">DOT: </text>
                            <text x="25" y="16.5" text-anchor="middle" id="rr-brand-display"></text>
                        </g>
                        
                        <g transform="translate(56, 195)">
                            <rect width="48" height="18" fill="white" stroke="#4472C4"/>
                            <text x="24" y="7" text-anchor="middle" fill="#4472C4">mm</text>
                            <text x="24" y="15" text-anchor="middle" fill="#4472C4" id="spare-display">0</text>
                        </g>
                        <g transform="translate(56, 215)">
                            <rect width="48" height="14" fill="#4472C4"/>
                            <text x="24" y="9" text-anchor="middle" fill="white" id="spare-pressure-display-text">0</text>
                        </g>
                        <g class="tire-dot-brand tire-dot-brand-spare">
                            <rect x="0" y="0" width="48" height="18"/>
                            <text x="24" y="7" text-anchor="middle" id="spare-dot-display">DOT: </text>
                            <text x="24" y="15" text-anchor="middle" id="spare-brand-display"></text>
                        </g>
                    </g>
                    
                    <text x="160" y="95" text-anchor="start" font-size="6" fill="#4472C4" transform="rotate(90, 160, 95)">√Åp su·∫•t khuy·∫øn c√°o</text>
                    <text x="160" y="195" text-anchor="start" font-size="6" fill="#4472C4" transform="rotate(90, 160, 195)">√Åp su·∫•t khuy·∫øn c√°o</text>

                    <rect x="55" y="100" width="50" height="20" fill="none" stroke="red" id="tire-size-box"/>
                    <text x="80" y="112" text-anchor="middle" alignment-baseline="middle" id="tire-size-text">Size L·ªëp</text>
                </svg>
            </div>

            <div class="note-section">
                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px;">
                    <div class="checkbox" id="note-checkbox-spare"></div>
                    <span style="font-weight: bold;">L∆ØU √ù: Ki·ªÉm tra & b∆°m l·ªëp d·ª± ph√≤ng</span>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <span style="font-weight: bold;">HI·ªÜN TR·∫†NG L·ªêP:</span>
                    <span style="border-bottom: 1px dotted #333; display: inline-block; min-width: 200px; margin-left: 5px;" id="condition-display"></span>
                </div>

                <div id="brake-pad-section" style="margin-bottom: 8px;">
                    <span style="font-weight: bold;">B·ªê TH·∫ÆNG TR∆Ø·ªöC:</span>
                    <span style="border-bottom: 1px dotted #333; display: inline-block; min-width: 50px; margin-left: 5px;" id="front-brake-pad-display"></span> %
                    <span style="font-weight: bold; margin-left: 15px;">B·ªê TH·∫ÆNG SAU:</span>
                    <span style="border-bottom: 1px dotted #333; display: inline-block; min-width: 50px; margin-left: 5px;" id="rear-brake-pad-display"></span> %
                    <div style="margin-top: 5px;">
                        <span style="font-weight: bold;">KHUY·∫æN C√ÅO B·ªê TH·∫ÆNG:</span>
                        <span style="border-bottom: 1px dotted #333; display: inline-block; min-width: 200px; margin-left: 5px;" id="brake-recommendation-display"></span>
                    </div>
                </div>
                </div>

            <div class="info-section" style="position: relative;">
                <div>
                    <div class="info-item" style="margin-bottom: 8px;">
                        <span style="font-weight: bold;">NG√ÄY:</span>
                        <span id="date-display" style="margin-left: 10px;"></span>
                        <span style="font-weight: bold; margin-left: 20px;">STT:</span>
                    </div>
                    <div class="info-item" style="margin-bottom: 8px;">
                        <span style="font-weight: bold;">BI·ªÇN S·ªê XE:</span>
                        <span id="plate-display" style="margin-left: 10px;"></span>
                    </div>
                    <div class="info-item">
                        <span style="font-weight: bold;">K·ª∏ THU·∫¨T VI√äN:</span>
                        <span id="tech-display" style="margin-left: 10px;"></span>
                    </div>
                     <div class="info-item">
                        <span style="font-weight: bold;">CHI NH√ÅNH:</span>
                        <span id="branch-display" style="margin-left: 10px;"></span>
                    </div>
                </div>
                <div>
                    <div class="info-item">
                        <span style="font-weight: bold;">S·ªë ƒëi·ªán tho·∫°i:</span>
                        <span id="phone-display" style="margin-left: 10px;"></span>
                    </div>
                    <div id="qrcode-container" style="margin-top: 10px; display: flex; justify-content: flex-end;">
                        <img id="qr-code-display" src="" alt="QR Code">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants for Local Storage keys
        const FORM_DATA_TIRE_KEY = 'phieuDanhGiaLop_formData'; // Unique key for this form

        // Global flag for submission status
        let hasSubmitted = false;

        // Constants for branch locations
        const branchLocations = [
            { name: 'Chi Nh√°nh 1 - B√¨nh Ph∆∞·ªõc', lat: 11.5145974, lon: 106.8931262 },
            { name: 'Chi Nh√°nh 2 - ƒê·ªìng Xo√†i', lat: 11.537788, lon: 106.905191 },
            { name: 'Chi Nh√°nh 3 - B√¨nh D∆∞∆°ng', lat: 11.004401, lon: 106.6719367 }
        ];
        const GEOLOCATION_ERROR_RADIUS = 100; // meters

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u instance QR Code
        let qrcodeInstance = null;

        // --- Utility Functions ---

        /**
         * Calculates the distance between two geographical points using the Haversine formula.
         * @param {number} lat1 - Latitude of point 1 in degrees.
         * @param {number} lon1 - Longitude of point 1 in degrees.
         * @param {number} lat2 - Latitude of point 2 in degrees.
         * @param {number} lon2 - Longitude of point 2 in degrees.
         * @returns {number} Distance in meters.
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const œÜ1 = lat1 * Math.PI / 180; // œÜ, Œª in radians
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // in metres
            return d;
        }

        /**
         * Determines the closest branch based on current geolocation and automatically selects it.
         */
        function getClosestBranch() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        let closestBranch = null;
                        let minDistance = Infinity;

                        branchLocations.forEach(branch => {
                            const distance = getDistance(userLat, userLon, branch.lat, branch.lon);
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestBranch = branch;
                            }
                        });

                        const branchSelect = document.getElementById('branchSelect');
                        if (closestBranch && minDistance <= GEOLOCATION_ERROR_RADIUS) { // Within 100 meters
                            branchSelect.value = closestBranch.name;
                            console.log(`T·ª± ƒë·ªông ch·ªçn chi nh√°nh: ${closestBranch.name} (kho·∫£ng c√°ch: ${minDistance.toFixed(2)}m)`);
                        } else if (closestBranch) {
                            console.log(`Chi nh√°nh g·∫ßn nh·∫•t (${closestBranch.name}) ·ªü ngo√†i b√°n k√≠nh cho ph√©p (${minDistance.toFixed(2)}m > ${GEOLOCATION_ERROR_RADIUS}m). Kh√¥ng t·ª± ƒë·ªông ch·ªçn.`);
                        } else {
                            console.log('Kh√¥ng t√¨m th·∫•y chi nh√°nh n√†o g·∫ßn nh·∫•t.');
                        }
                        saveFormDataToLocalStorage(); // Save after potentially setting branch
                        updatePreview();
                    },
                    (error) => {
                        console.warn(`L·ªói khi l·∫•y v·ªã tr√≠: ${error.message}`);
                        // Handle errors like permission denied (error.code === 1)
                        // Or position unavailable (error.code === 2)
                        // Or timeout (error.code === 3)
                        alert('Kh√¥ng th·ªÉ t·ª± ƒë·ªông x√°c ƒë·ªãnh chi nh√°nh. Vui l√≤ng ch·ªçn th·ªß c√¥ng. L·ªói: ' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.');
                alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã. Vui l√≤ng ch·ªçn chi nh√°nh th·ªß c√¥ng.');
            }
        }


        /**
         * Determines the shape (color) based on tire tread depth.
         * @param {number} depth - Tire tread depth (mm).
         * @returns {string} Corresponding CSS class name for the shape.
         */
        function getDepthShape(depth) {
            if (depth > 4) return 'green-square'; // Good tire
            else if (depth >= 3) return 'yellow-triangle'; // Caution tire
            else if (depth >= 1.6) return 'red-circle'; // Replacement needed (1.6 - 3mm)
            else return 'red-circle'; // Below 1.6mm is also red (critical)
        }

        /**
         * Updates the visual tire tread depth shapes for each tire position.
         * @param {string} position - Tire position (e.g., 'fl', 'fr', 'rl', 'rr').
         * @param {number} innerDepth - Inner tire tread depth.
         * @param {number} outerDepth - Outer tire tread depth.
         */
        function updateTireShapes(position, innerDepth, outerDepth) {
            const shapesContainer = document.getElementById(position + '-shapes');
            if (!shapesContainer) return;

            shapesContainer.innerHTML = ''; // Clear existing shapes

            // Create and append shape for inner depth
            const innerShape = document.createElement('div');
            innerShape.className = 'shape ' + getDepthShape(innerDepth);
            if (getDepthShape(innerDepth) === 'yellow-triangle') {
                innerShape.style.width = '0'; innerShape.style.height = '0';
                innerShape.style.borderLeft = '8px solid transparent';
                innerShape.style.borderRight = '8px solid transparent';
                innerShape.style.borderBottom = '12px solid #FFC000';
            } else {
                innerShape.style = ''; // Reset inline style if not a yellow-triangle
            }
            shapesContainer.appendChild(innerShape);

            // Create and append shape for outer depth
            const outerShape = document.createElement('div');
            outerShape.className = 'shape ' + getDepthShape(outerDepth);
            if (getDepthShape(outerDepth) === 'yellow-triangle') {
                outerShape.style.width = '0'; outerShape.style.height = '0';
                outerShape.style.borderLeft = '8px solid transparent';
                outerShape.style.borderRight = '8px solid transparent';
                outerShape.style.borderBottom = '12px solid #FFC000';
            } else {
                outerShape.style = ''; // Reset inline style if not a yellow-triangle
            }
            shapesContainer.appendChild(outerShape);
        }

        /**
         * Updates recommendations based on input data and automatic logic.
         */
        function updateRecommendations() {
            const recommendationsMap = {
                'can-chinh-thuoc-lai': 'rec-1',
                'can-bang-dong': 'rec-2',
                'dao-lop': 'rec-3',
                'thay-the': 'rec-4'
            };

            // Reset all visual recommendation checkboxes
            Object.values(recommendationsMap).forEach(id => {
                const recCheckbox = document.getElementById(id);
                if (recCheckbox) recCheckbox.style.background = 'white';
            });

            // Process manually checked recommendations from control section
            document.querySelectorAll('.recommendation-checkboxes input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const recId = checkbox.dataset.recId;
                    const displayCheckbox = document.getElementById(recommendationsMap[recId]);
                    if (displayCheckbox) displayCheckbox.style.background = '#4472C4';
                }
            });

            // Automatic recommendation logic based on tire depths
            const positions = ['fl', 'fr', 'rl', 'rr'];
            let needsReplacement = false;
            let needsRotation = false;

            positions.forEach(pos => {
                const inner = parseFloat(document.getElementById(pos + '-inner').value) || 0;
                const outer = parseFloat(document.getElementById(pos + '-outer').value) || 0;
                
                // If tread depth is below 1.6mm (legal limit), needs replacement
                if (inner < 1.6 || outer < 1.6) {
                    needsReplacement = true;
                }
                // Example logic for rotation: if difference between inner and outer is greater than 1mm
                if (Math.abs(inner - outer) > 1) { 
                    needsRotation = true;
                }
            });

            // Apply automatic recommendations if not already manually checked
            if (needsReplacement) {
                const rec4 = document.getElementById('rec-4');
                if (rec4) rec4.style.background = '#4472C4'; // Mark "Thay th·∫ø"
            }
            if (needsRotation) {
                const rec3 = document.getElementById('rec-3');
                if (rec3) rec3.style.background = '#4472C4'; // Mark "ƒê·∫£o l·ªëp"
            }
        }

        /**
         * Updates the print preview section with current data from the form.
         */
        function updatePreview() {
            // Update basic info
            document.getElementById('condition-display').textContent = document.getElementById('tireOverallConditionInput').value;
            document.getElementById('date-display').textContent = document.getElementById('inspectionDateInput').value;
            document.getElementById('plate-display').textContent = document.getElementById('licensePlateInput').value;
            document.getElementById('tech-display').textContent = document.getElementById('technicianInput').value;
            document.getElementById('phone-display').textContent = document.getElementById('phoneNumberInput').value;
            document.getElementById('branch-display').textContent = document.getElementById('branchSelect').value; // Update branch display

            // Update Tire Size on SVG
            document.getElementById('tire-size-text').textContent = document.getElementById('tireSizeInput').value || 'Size L·ªëp';

            // Update tire measurements and shapes on the car diagram
            const positions = ['fl', 'fr', 'rl', 'rr'];
            positions.forEach(pos => {
                const inner = parseFloat(document.getElementById(pos + '-inner').value) || 0;
                const outer = parseFloat(document.getElementById(pos + '-outer').value) || 0;
                const pressure = parseFloat(document.getElementById(pos + '-pressure').value) || 0;
                const dot = document.getElementById(pos + '-dot').value || '';
                const brand = document.getElementById(pos + '-brand').value || '';

                // Update tread depth display (e.g., "3.5/3.2")
                document.getElementById(pos + '-display').textContent = inner.toFixed(1) + '/' + outer.toFixed(1); 
                // Update tire pressure display
                document.getElementById(pos + '-pressure-display-text').textContent = pressure.toFixed(1);
                // Update DOT and Brand display
                document.getElementById(pos + '-dot-display').textContent = 'DOT: ' + dot;
                document.getElementById(pos + '-brand-display').textContent = brand;
                // Update colored shapes indicating tread depth
                updateTireShapes(pos, inner, outer);
            });

            // Update spare tire measurements
            const spareDepth = parseFloat(document.getElementById('spare-depth').value) || 0;
            const sparePressure = parseFloat(document.getElementById('spare-pressure').value) || 0;
            const spareDot = document.getElementById('spare-dot').value || '';
            const spareBrand = document.getElementById('spare-brand').value || '';
            document.getElementById('spare-display').textContent = spareDepth.toFixed(1); 
            document.getElementById('spare-pressure-display-text').textContent = sparePressure.toFixed(1);
            document.getElementById('spare-dot-display').textContent = 'DOT: ' + spareDot;
            document.getElementById('spare-brand-display').textContent = spareBrand;

            // Update Brake Pad measurements
            const frontBrakePad = parseFloat(document.getElementById('frontBrakePadInput').value) || 0;
            const rearBrakePad = parseFloat(document.getElementById('rearBrakePadInput').value) || 0;
            const brakeRecommendation = document.getElementById('brakeRecommendationInput').value || '';

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã B·ªë Th·∫Øng v·ªõi ƒë∆°n v·ªã %
            document.getElementById('front-brake-pad-display').textContent = frontBrakePad.toFixed(1);
            document.getElementById('rear-brake-pad-display').textContent = rearBrakePad.toFixed(1);
            document.getElementById('brake-recommendation-display').textContent = brakeRecommendation;

            // Generate and update QR Code
            generateQRCode();

            // Update recommendations (including new checkbox logic)
            updateRecommendations();
        }

        // --- Local Storage Functions ---

        function saveFormDataToLocalStorage() {
            const form = document.getElementById('tireEvaluationForm');
            if (!form) return;

            const formData = {};
            const inputs = form.querySelectorAll('input:not([readonly]), textarea, select');
            inputs.forEach(input => {
                if (input.name) {
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked;
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value;
                        }
                    } else {
                        formData[input.name] = input.value;
                    }
                }
            });
            localStorage.setItem(FORM_DATA_TIRE_KEY, JSON.stringify(formData));
            // console.log('Form data saved to localStorage:', formData);
        }

        function loadFormDataFromLocalStorage() {
            const savedData = localStorage.getItem(FORM_DATA_TIRE_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData);
            const form = document.getElementById('tireEvaluationForm');
            if (!form) return;
            for (const name in formData) {
                const elements = form.querySelectorAll(`[name="${name}"]`);
                if (elements.length > 0) {
                    elements.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = formData[name];
                        } else if (input.type === 'radio') {
                            if (input.value === formData[name]) {
                                input.checked = true;
                            }
                        } else {
                            input.value = formData[name];
                        }
                    });
                }
            }
            // console.log('Form data loaded from localStorage:', formData);
            updatePreview(); // Update visual preview after loading data
        }

        // Helper function to collect form data for submission (enhanced for checkboxes/radios)
        function collectFormDataAsUrlEncoded(formElement) {
            const formData = new FormData(formElement);
            const params = new URLSearchParams();

            params.append('formType', formElement.querySelector('[name="formType"]').value);

            // Append all form data entries
            for (const pair of formData.entries()) {
                params.append(pair[0], pair[1]);
            }

            // Manually add unchecked checkboxes and unselected radio groups to ensure their absence is recorded
            formElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked && !params.has(checkbox.name)) {
                    params.append(checkbox.name, ''); 
                }
            });
            const radioGroupNames = new Set();
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroupNames.add(radio.name));
            radioGroupNames.forEach(groupName => {
                const checkedRadioInGroup = formElement.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (!checkedRadioInGroup && !params.has(groupName)) {
                    params.append(groupName, '');
                }
            });
            return params.toString();
        }

        // --- QR Code Generation Function ---
        function generateQRCode() {
            const licensePlate = document.getElementById('licensePlateInput').value;
            const inspectionDate = document.getElementById('inspectionDateInput').value;
            const technician = document.getElementById('technicianInput').value;
            const branch = document.getElementById('branchSelect').value;
            const tireSize = document.getElementById('tireSizeInput').value;
            const overallCondition = document.getElementById('tireOverallConditionInput').value;

            // Thu th·∫≠p d·ªØ li·ªáu b·ªë th·∫Øng
            const frontBrakePad = document.getElementById('frontBrakePadInput').value;
            const rearBrakePad = document.getElementById('rearBrakePadInput').value;
            const brakeRecommendation = document.getElementById('brakeRecommendationInput').value;

            // L·∫•y d·ªØ li·ªáu l·ªëp chi ti·∫øt
            const tireData = {};
            const positions = ['fl', 'fr', 'rl', 'rr'];
            positions.forEach(pos => {
                tireData[pos] = {
                    inner_depth: document.getElementById(pos + '-inner').value,
                    outer_depth: document.getElementById(pos + '-outer').value,
                    pressure: document.getElementById(pos + '-pressure').value,
                    dot: document.getElementById(pos + '-dot').value,
                    brand: document.getElementById(pos + '-brand').value
                };
            });
            const spareData = {
                depth: document.getElementById('spare-depth').value,
                pressure: document.getElementById('spare-pressure').value,
                dot: document.getElementById('spare-dot').value,
                brand: document.getElementById('spare-brand').value
            };

            // L·∫•y c√°c khuy·∫øn c√°o ƒë√£ ch·ªçn
            const recommendations = [];
            document.querySelectorAll('.recommendation-checkboxes input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    recommendations.push(checkbox.dataset.recId);
                }
            });

            // T·∫°o m·ªôt chu·ªói d·ªØ li·ªáu JSON ho·∫∑c URL ƒë·ªÉ m√£ h√≥a v√†o QR Code
            const qrData = {
                bien_so: licensePlate,
                ngay: inspectionDate,
                ky_thuat_vien: technician,
                chi_nhanh: branch,
                size_lop: tireSize,
                hien_trang_lop: overallCondition,
                bo_thang_truoc: frontBrakePad,
                bo_thang_sau: rearBrakePad,
                khuyen_cao_bo_thang: brakeRecommendation,
                lop: tireData,
                lop_du_phong: spareData,
                khuyen_cao: recommendations
            };

            // Convert object to a readable string (e.g., JSON string or URL parameters)
            const qrText = JSON.stringify(qrData); // Using JSON string for comprehensive data

            const qrCodeElement = document.getElementById('qrcode-container');
            let qrCodeImage = document.getElementById('qr-code-display'); // L·∫•y l·∫°i tham chi·∫øu ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√∫ng

            // X√≥a QR code c≈© n·∫øu c√≥
            if (qrcodeInstance) {
                qrcodeInstance.clear();
                // qrcode.js c√≥ th·ªÉ th√™m m·ªôt canvas ho·∫∑c img m·ªõi v√†o container,
                // n√™n t·ªët nh·∫•t l√† l√†m s·∫°ch container v√† t·∫°o l·∫°i img element
                qrCodeElement.innerHTML = '';
                qrCodeImage = document.createElement('img');
                qrCodeImage.id = 'qr-code-display';
                qrCodeElement.appendChild(qrCodeImage);
            }

            // T·∫°o QR code m·ªõi
            qrcodeInstance = new QRCode(qrCodeElement, {
                text: qrText,
                width: 150,  // K√≠ch th∆∞·ªõc mong mu·ªën khi t·∫°o
                height: 150, // K√≠ch th∆∞·ªõc mong mu·ªën khi t·∫°o
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H // Higher error correction
            });

            // N·∫øu qrcode.js t·∫°o ra canvas, b·∫°n c·∫ßn chuy·ªÉn n√≥ th√†nh h√¨nh ·∫£nh.
            // Tuy nhi√™n, v·ªõi `qrcode.js` v√† render mode m·∫∑c ƒë·ªãnh, n√≥ th∆∞·ªùng t·∫°o ra `img` tag ch·ª©a data URL.
            // N·∫øu b·∫°n g·∫∑p v·∫•n ƒë·ªÅ, c√≥ th·ªÉ th√™m m·ªôt setTimeout nh·ªè ho·∫∑c ƒë·∫£m b·∫£o logic chuy·ªÉn ƒë·ªïi canvas.
            // V·ªõi thi·∫øt l·∫≠p hi·ªán t·∫°i, CSS `#qr-code-display` s·∫Ω ki·ªÉm so√°t k√≠ch th∆∞·ªõc cu·ªëi c√πng.
        }


        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', function() {
            // Set initial date
            document.getElementById('inspectionDateInput').value = new Date().toISOString().split('T')[0];

            loadFormDataFromLocalStorage(); // Load saved data on page load
            updatePreview(); // Initial update of the preview section
            getClosestBranch(); // Attempt to get and set closest branch on load
            
            const form = document.getElementById('tireEvaluationForm');
            if (form) {
                // Save data to local storage on any input change
                form.addEventListener('input', saveFormDataToLocalStorage);
                form.addEventListener('change', saveFormDataToLocalStorage); // For checkboxes, radio buttons, select
            }

            // Submit button logic
            const submitFormBtn = document.getElementById('submitFormBtn');
            if (submitFormBtn) {
                submitFormBtn.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent default form submission
                    const formElement = document.getElementById('tireEvaluationForm');
                    const scriptURL = formElement.action; // Get URL from form's action attribute

                    if (!formElement.checkValidity()) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc tr∆∞·ªõc khi g·ª≠i!');
                        formElement.reportValidity(); 
                        return;
                    }

                    submitFormBtn.disabled = true;
                    submitFormBtn.textContent = 'ƒêang g·ª≠i...';

                    const urlEncodedData = collectFormDataAsUrlEncoded(formElement);

                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData
                    })
                    .then(response => response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || 'L·ªói t·ª´ m√°y ch·ªß kh√¥ng x√°c ƒë·ªãnh.');
                        }
                        return data;
                    }))
                    .then(data => {
                        if (data.result === 'success') {
                            alert('‚úÖ G·ª≠i th√¥ng tin th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ in phi·∫øu.');
                            console.log('D·ªØ li·ªáu ƒë√£ g·ª≠i:', data.row);
                            hasSubmitted = true; // Set flag to true
                            // Data is NOT cleared here, so user can inspect and print
                        } else {
                            alert('‚ùå Kh√¥ng g·ª≠i ƒë∆∞·ª£c: ' + (data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ Apps Script.'));
                            console.error('L·ªói t·ª´ Apps Script:', data.message);
                        }
                    })
                    .catch(error => {
                        alert('‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i. Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                        console.error('L·ªói Fetch ho·∫∑c ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá:', error);
                    })
                    .finally(() => {
                        submitFormBtn.disabled = false;
                        submitFormBtn.textContent = 'üì§ G·ª≠i Th√¥ng Tin';
                    
      // === TH√äM M·ªöI: N√∫t x√≥a form ===
      const clearFormBtn = document.getElementById('clearFormBtn');
      if (clearFormBtn) {
        clearFormBtn.addEventListener('click', function() {
          if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) {
            localStorage.removeItem(FORM_DATA_TIRE_KEY);
            const formElement = document.getElementById('tireEvaluationForm');
            formElement.reset();
            document.getElementById('inspectionDateInput').value = new Date().toISOString().split('T')[0];
            updatePreview();
            alert('üóëÔ∏è D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.');
          }
        });
      }
});
                });
            }

            // Print button logic
            const printFormBtn = document.getElementById('printFormBtn');
            if (printFormBtn) {
                printFormBtn.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent default print behavior
                    const formElement = document.getElementById('tireEvaluationForm');

                    if (!hasSubmitted) {
                        alert('Vui l√≤ng nh·∫•n "G·ª≠i Th√¥ng Tin" tr∆∞·ªõc khi in phi·∫øu!');
                    } else {
                        // Re-fetch current data to ensure preview is fully up-to-date right before print
                        updatePreview(); 
                        
                        // Call native print dialog
                        window.print();
                        
                        // Clear data and reset form AFTER printing is initiated
                        localStorage.removeItem(FORM_DATA_TIRE_KEY); 
                        formElement.reset(); 
                        document.getElementById('inspectionDateInput').value = new Date().toISOString().split('T')[0]; // Reset date
                        updatePreview(); // Reset preview to blank state for new form
                        hasSubmitted = false; // Reset flag for new submission
                    }
                });
            }

            // Update Preview button (optional, as input/change events also trigger updatePreview)
            const updatePreviewBtn = document.getElementById('updatePreviewBtn');
            if (updatePreviewBtn) {
                updatePreviewBtn.addEventListener('click', updatePreview);
            }
        });
    </script>
</body>
</html>
