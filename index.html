<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Kiểm Tra Xe - PHI LONG AUTO</title>
    <style>
        /* Reset và cấu hình cơ bản */
        * {
            margin: 0; padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif; font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 230mm;
            margin: 0 auto; background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .form-content {
            padding: 15mm;
        }

        /* Header Section */
        .header {
            display: flex; justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .header-left h1 {
            font-size: 24px; font-weight: bold;
            font-style: italic;
            margin-bottom: 5px;
        }

        .form-number {
            font-size: 16px; font-weight: bold;
        }

        .header-right {
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
        }

        .logo {
            text-align: right;
        }

        .logo img {
            height: 80px;
            object-fit: contain;
            margin-top: 0px;
        }

        /* Customer Info Section */
        .customer-info {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .info-group {
            margin-bottom: 8px; display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-group label {
            font-weight: bold; margin-right: 5px;
            white-space: nowrap;
        }

        .info-group .info-input {
            border: none; border-bottom: 1px dotted #000;
            flex-grow: 1;
            padding: 0 5px;
            font-size: 12px;
            min-width: 50px;
        }
        .info-group .info-input.name-input { min-width: 150px; }
        .info-group .info-input.phone-email-input { min-width: 90px; }
        .info-group .info-input.datetime-input { min-width: 130px; }
        .info-group .info-input.car-type-input { min-width: 150px; }
        .info-group .info-input.license-km-input { min-width: 90px; }

        .info-group input[type="checkbox"] {
            width: 15px; height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .info-group input[type="radio"] {
            width: 15px; height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .info-group.inline-fields {
            align-items: flex-start; display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .info-group.inline-fields > div {
            display: flex; align-items: center;
        }
        .info-group.inline-fields label {
            margin-right: 5px;
        }
        .info-group.inline-fields .info-input {
            flex-shrink: 1;
        }


        /* Main Content Section */
        .main-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px; margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Tire Section */
        .tire-section {
            display: flex; flex-direction: column;
            align-items: center;
            position: relative;
            justify-content: flex-start;
            max-width: 280px;
            flex-shrink: 0;
        }

        .tire-diagram-container {
            position: relative; width: 120px;
            height: 170px;
            display: flex; justify-content: center;
            align-items: flex-start;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .tire-diagram {
            position: relative; width: 100%;
            height: 100%;
            border: none;
            background: none;
            z-index: 0;
            flex-shrink: 0;
        }

        .tire-diagram img {
            width: 100%; height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            object-fit: contain;
            object-position: center;
        }

        /* Khung nhập liệu cho từng lốp */
        .tire-position {
            position: absolute; background: white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            font-size: 11px;
            color: Black;
            padding: 3px 5px; box-sizing: border-box;
            z-index: 1;
            width: 85px;
            height: auto;
            line-height: 1.1;
            border: 1px solid #000;
        }

        .tire-front-left { top: 20px; left: -85px; }
        .tire-front-right { top: 20px; left: 120px; }
        .tire-rear-left { top: 115px; left: -85px; }
        .tire-rear-right { top: 115px; left: 120px; }
        .tire-spare { bottom: -10px; left: 50%; transform: translateX(-50%); width: 85px; }


        .tire-input-group {
            display: flex; align-items: center;
            margin-bottom: 1px;
            width: 100%;
            justify-content: space-between;
        }
        .tire-input-group:last-child {
            margin-bottom: 0;
        }

        .tire-input-group label {
            font-size: 9px; white-space: nowrap;
            margin-right: 2px;
        }

        .pressure-input, .thickness-input {
            background: white; border: 1px solid #ccc;
            width: 35px;
            height: 15px;
            text-align: center;
            font-size: 8px;
            padding: 0 1px;
        }
        .tire-position small {
            font-size: 7px; margin-left: 1px;
        }

        /* Phần "Size lốp khuyến cáo" và "Lưu ý" */
        .tire-size-recommendation {
            width: 100%; margin-bottom: 10px;
        }

        .tire-size-recommendation label {
            font-weight: bold; margin-bottom: 5px;
            white-space: nowrap;
        }
        .tire-size-recommendation input {
            border: none; border-bottom: 1px dotted #000;
            width: 100%;
            text-align: left;
            min-width: 120px;
            font-size: 11px;
        }

        .recommendation {
            font-size: 11px; width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-top: 0;
        }

        .recommendation label {
            margin-bottom: 5px;
        }

        .recommendation textarea {
            width: 100%; flex-grow: 1;
            border: 1px dotted #000;
            padding: 5px;
            resize: vertical;
            font-size: 11px;
            min-height: 50px;
        }
        .recommendation1 textarea {
            width: 100%;
            padding: 8px;
            font-size: 14px; border: 1px solid #ccc;
            border-radius: 6px;
            resize: vertical;
        }
        .recommendation1 label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }

        /* Safety Check Section */
        .safety-check {
            border: 1px solid #000; padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
        }

        .safety-title {
            background: #003366; color: white;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            margin: -10px -10px 10px -10px;
        }

        .safety-grid {
            display: grid;
            grid-template-columns: 2.5fr 1fr 1fr 1fr; gap: 5px;
            font-size: 11px;
            flex-grow: 1;
        }

        .safety-header {
            font-weight: bold; text-align: center;
            padding: 3px;
            background: #f0f0f0;
        }
        .safety-grid .safety-header:nth-child(2),
        .safety-grid .safety-header:nth-child(3),
        .safety-grid .safety-header:nth-child(4) {
            text-align: center; display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px 0;
        }

        .safety-item {
            display: contents;
        }

        .item-name {
            padding: 3px; border-bottom: 1px dotted #ccc;
            text-align: left;
            font-weight: bold;
        }

        .checkbox-cell {
            text-align: center; padding: 3px;
            border-bottom: 1px dotted #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Styles for custom checkboxes (on screen) */
        .checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #000;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Màu nền cho các checkbox trên giao diện */
        .safety-grid .checkbox-cell:nth-of-type(4n+2) .checkbox { /* TỐT - XANH LÁ */
            background-color: #d4edda;
        }

        .safety-grid .checkbox-cell:nth-of-type(4n+3) .checkbox { /* LƯU Ý - VÀNG */
            background-color: #fff3cd;
        }

        .safety-grid .checkbox-cell:nth-of-type(4n+4) .checkbox { /* THAY - ĐỎ */
            background-color: #f8d7da;
        }

        /* Dấu "✓" khi checkbox được chọn */
        .checkbox:checked::after {
            content: '✓';
            font-size: 14px;
            color: #333;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        .checkbox:checked {
            outline: none;
        }


        /* Detailed Check Table */
        .detailed-check {
            margin-top: 15px; width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
        }

        .detailed-check th,
        .detailed-check td {
            border: 1px solid #000; padding: 5px;
            text-align: center;
            font-size: 11px;
        }

        .detailed-check th {
            background: #003366; color: white;
            font-weight: bold;
        }

        .detailed-check .stt { width: 30px; }
        .detailed-check .hang-muc {
            width: 120px; text-align: left;
            font-weight: bold;
        }
        .detailed-check .dien-giai { width: 180px; }
        .detailed-check .sl { width: 50px; }
        .detailed-check .don-gia, .detailed-check .thanh-tien { width: 90px; }
        .detailed-check .xac-nhan { width: 60px; }

        .detailed-check input[type="text"] {
            width: 100%; border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }
        .detailed-check input[type="number"] {
            width: 100%; border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }

        .detailed-check input[type="text"].hang-muc-input {
            text-align: left; font-weight: bold;
        }

        .detailed-check input[type="checkbox"] {
            width: 15px; height: 15px;
            margin: 0 auto;
            display: block;
        }

        .total-row {
            background: #ccc; font-weight: bold;
        }

        /* Signature Section */
        .signature-section {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 20px;
            padding-top: 15px;
        }

        .signature-box { text-align: center; }

        .signature-title {
            font-weight: bold; margin-bottom: 30px;
        }

        .signature-input {
            border: none; border-bottom: 1px dotted #000;
            width: 100%;
            text-align: center;
            padding: 2px 0;
            font-size: 12px;
            margin-top: -20px;
        }

        .signature-line {
            border-bottom: 1px solid #000; margin-bottom: 5px;
            height: 1px;
        }

        .signature-subtitle {
            font-size: 10px; font-style: italic;
        }

        /* Footer */
        .footer {
            margin-top: 15px; font-size: 9px;
            line-height: 1.2;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        /* Buttons */
        .button-group {
            display: flex; justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tire-form-button, .print-button, .clear-button {
            padding: 8px 12px;
            border: none; border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .print-button {
            background: #007bff; color: white;
        }

        .print-button:hover { background: #0056b3; }

        .clear-button {
            background: #dc3545; color: white;
        }
        .clear-button:hover { background: #c82333; }

        .tire-form-button {
            background: #28a745; color: white;
        }
        .tire-form-button:hover { background: #218838; }

        /* Print Styles */
        @media print {
            .button-group { display: none; }

            body {
                margin: 0; padding: 0;
                background: white;
                font-size: 10px; /* Base font size for print */
                font-weight: 500;
            }

            .container {
                max-width: none; box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .form-content {
                padding: 4mm 5mm; /* Reduced overall padding */
                width: 210mm;
                /* height: 297mm; */ /* REMOVED fixed height to allow content to flow naturally */
                box-sizing: border-box;
                /* overflow: hidden; */ /* REMOVED overflow hidden for print */
                /* page-break-after: always; */ /* REMOVED this, let content naturally fit */
            }

            .header { margin-bottom: 2mm; padding-bottom: 2mm; }
            .header h1 { font-size: 16px; }
            .form-number { font-size: 12px; }
            .logo {
                max-width: 80px; /* Slightly smaller logo */
                max-height: 50px;
                text-align: right;
            }
            .logo img {
                max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin-left: auto;
                object-position: right;
            }

            .customer-info { margin-bottom: 2mm; gap: 8px; }
            .info-group { margin-bottom: 3px; font-size: 10.5px; }
            .info-group label { font-size: 10.5px; }
            .info-group .info-input { font-size: 10.5px; min-width: 55px; } /* Min-width adjusted */
            .info-group .info-input.name-input { min-width: 100px; }
            .info-group .info-input.phone-email-input { min-width: 70px; }
            .info-group .info-input.datetime-input { min-width: 100px; }
            .info-group .info-input.car-type-input { min-width: 100px; }
            .info-group .info-input.license-km-input { min-width: 70px; }
            .info-group.inline-fields > div { margin-right: 4px; }


            .main-content {
                display: flex; /* Ensure flexbox */
                justify-content: space-between;
                align-items: flex-start;
                gap: 3mm; /* Reduced gap between columns */
                margin-bottom: 3mm; /* Reduced margin */
                flex-wrap: nowrap; /* Prevent wrapping columns on print */
            }

            .tire-section {
                flex-shrink: 0;
                width: 40%; /* Reduced width of tire section to give more space to safety check */
                padding-right: 3mm; /* Small padding to separate from safety check */
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .tire-diagram-container {
                width: 130px !important; /* Smaller diagram */
                height: 150px !important;
                margin-left: auto !important;
                margin-right: auto !important;
                padding-bottom: 4px !important; margin-bottom: 4px !important;
                border-bottom: 1px dashed #ccc;
            }

            .tire-diagram {
                width: 100% !important; height: 100% !important;
            }

            .tire-position {
                font-size: 9px !important;
                padding: 2px 4px !important;
                width: 70px !important;
                line-height: 1.1 !important;
                border-radius: 4px !important;
            }

            /* Adjusted positions relative to the NEW smaller diagram size */
            .tire-front-left { top: 15px !important; left: -60px !important; }
            .tire-front-right { top: 15px !important; left: 125px !important; } /* (130px diagram width - 5px for visual balance) */
            .tire-rear-left { top: 90px !important; left: -60px !important; }
            .tire-rear-right { top: 90px !important; left: 125px !important; }
            .tire-spare { bottom: -15px !important; left: 50% !important; transform: translateX(-50%) !important; width: 60px !important; }

            .tire-input-group label {
                font-size: 8.5px !important;
            }
            .pressure-input, .thickness-input {
                width: 30px !important;
                height: 13px !important;
                font-size: 10px !important;
                padding: 0;
            }
            .tire-position small {
                font-size: 7.5px !important;
            }

            .tire-size-recommendation {
                position: static !important;
                margin-top: 3mm; /* Space below diagram */
                width: 100%; /* Ensure it fits in its column */
            }
            .tire-size-recommendation label { margin-bottom: 1px; font-size: 10.5px; }
            .tire-size-recommendation input { min-width: 70px; font-size: 10.5px; }

            .recommendation { font-size: 10.5px; margin-top: 3mm; }
            .recommendation textarea { min-height: 30px; height: 30px; font-size: 10.5px; width: 100%; padding: 2mm; }


            .safety-check {
                flex-grow: 1; /* Allow it to take remaining width */
                padding: 3mm; /* Reduced padding */
                height: auto; /* Let content define height */
            }
            .safety-title { padding: 2mm; font-size: 10.5px; margin: -3mm -3mm 2mm -3mm; }
            .safety-grid {
                flex-grow: 1; /* Allow it to take remaining height */
                height: auto;
                font-size: 9px; /* Smaller font for safety check items */
                gap: 0.5mm;
                grid-template-columns: 1fr 8mm 8mm 8mm; /* Smaller checkbox columns */
            }
            .item-name {
                padding: 0.5mm 1mm; /* Reduced padding */
                font-size: 9.5px; /* Fine-tuned font size */
                line-height: 1.1; /* Reduced line height */
            }
            .checkbox-cell {
                padding: 0.5mm 0; /* Reduced vertical padding */
            }
            .checkbox {
                width: 10px; height: 10px;
            }

            /* Bổ sung để hiển thị màu checkbox khi in và dấu "✓" */
            .safety-grid .checkbox-cell:nth-of-type(4n+2) .checkbox {
                background-color: #d4edda !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .safety-grid .checkbox-cell:nth-of-type(4n+3) .checkbox {
                background-color: #fff3cd !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .safety-grid .checkbox-cell:nth-of-type(4n+4) .checkbox {
                background-color: #f8d7da !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .checkbox:checked::after {
                font-size: 8px !important;
            }

            .detailed-check { margin-top: 3mm; font-size: 9.5px; } /* Reduced margin and font */
            .detailed-check th, .detailed-check td { padding: 0.5mm 1mm; font-size: 9.5px; } /* Reduced padding and font */
            .detailed-check input[type="text"], .detailed-check input[type="number"] { font-size: 10.5px; padding: 0; height: 1.1em; } /* Further condensed height */
            .detailed-check input[type="checkbox"] {
                width: 11px; height: 11px;
                border-radius: 2px;
            }
            .detailed-check input[type="checkbox"]:checked::after {
                font-size: 9px !important;
            }
            .detailed-check input[type="checkbox"]:checked {
                background-color: #f0f0f0 !important;
            }
            .detailed-check .hang-muc {
                font-weight: bold; font-size: 10.5px;
            }
            .detailed-check input[type="text"].hang-muc-input {
                font-weight: bold; font-size: 10.5px;
            }

            .recommendation1 { margin-top: 3mm; } /* Reduced margin-top */
            .recommendation1 label { margin-bottom: 1mm; font-size: 10.5px; }
            /*.recommendation1 textarea { padding: 2mm; font-size: 10.5px; min-height: 18mm; height: 18mm; } Significantly reduced height */
            .recommendation1 textarea {
        width: 100%; padding: 2mm; font-size: 10.5px;
        /* Loại bỏ min-height và height cố định để textarea tự động co giãn */
        height: auto !important; /* Đảm bảo chiều cao tự động co giãn */
        min-height: unset !important; /* Bỏ giới hạn chiều cao tối thiểu */
        overflow: visible !important; /* Đảm bảo nội dung không bị ẩn */
        white-space: pre-wrap; /* Giữ ngắt dòng và tự động ngắt khi cần */
        word-wrap: break-word; /* Đảm bảo các từ dài sẽ ngắt dòng */
            }

            .signature-section { margin-top: 3mm; padding-top: 2mm; gap: 15mm; } /* Reduced margins/gap */
            .signature-title { margin-bottom: 7mm; font-size: 10.5px; }
            .signature-input { font-size: 10.5px; margin-top: -3mm; }
            .signature-subtitle { font-size: 8.5px; }

            /* Đảm bảo không ngắt trang bên trong các khối này */
            .main-content, .detailed-check, .signature-section, .recommendation1 { page-break-inside: avoid; }

            .form-content input:not([readonly]),
            .form-content textarea {
                font-weight: bold !important;
            }
            .detailed-check .thanh-tien-input,
            #grand-total,
            .info-group input[type="radio"]:checked + label {
                font-weight: bold !important; font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button class="tire-form-button print-button" id="printButton">🖨️ In Phiếu Kiểm Tra</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/tracuu.html'">📄 Tra cứu thông tin xe </button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieu_kiem_tra_lop.html'">📄 Phiếu Kiểm Tra Lốp</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">📄 Phiếu Kiểm Gầm</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieunhandichvu.html'">📄 Phiếu Dịch Vụ </button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/baoduong.html'">📄 Phiếu Bảo Dưỡng </button>
            <button class="tire-form-button" id="submitToSheet">📤 Gửi Thông Tin</button>
            <button class="tire-form-button clear-button" id="clearFormButton">🗑️ Xóa Form</button>
        </div>
        <div class="form-content">
            <form id="inspectionFormXe" action="https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec" method="POST">
                <input type="hidden" name="formType" value="PhieuKiemTraXe">

                <div class="header">
                    <div class="header-left">
                        <h1>PHIẾU KIỂM TRA XE</h1>
                        <div class="form-number">№ <span id="receiptNumber"></span> / <span id="currentMonth"></span></div>
                    </div>
                    <div class="header-right">
                        <div class="logo">
                            <img src="https://longvt89.github.io/phieukiemtra/logophilong.jpg" alt="Logo Phi Long Auto" style="height: 90px;">
                        </div>
                    </div>
                </div>

                <div class="customer-info">
                    <div class="customer-left">
                        <div class="info-group">
                            <label for="customerName">Họ tên:</label>
                            <input type="text" id="customerName" name="hoten" class="info-input name-input" required>
                        </div>
                        <div class="info-group inline-fields">
                            <div>
                                <label for="customerPhone">Điện thoại:</label>
                                <input type="tel" id="customerPhone" name="dienthoai" class="info-input phone-email-input" required>
                            </div>
                            <div>
                                <label for="customerEmail">E-mail:</label>
                                <input type="email" id="customerEmail" name="email" class="info-input phone-email-input">
                            </div>
                        </div>
                        <div class="info-group">
                            <label for="receivedDateTime">Ngày giờ nhận xe:</label>
                            <input type="datetime-local" id="receivedDateTime" name="nhanxe" class="info-input datetime-input" required>
                        </div>
                        <div class="info-group">
                            <label>Kiểm tra an toàn (Có/Không):</label>
                            <label><input type="radio" name="kiemTraAnToan" value="Có"> Có</label>
                            <label><input type="radio" name="kiemTraAnToan" value="Không"> Không</label>
                        </div>
                    </div>
                    <div class="customer-right">
                        <div class="info-group">
                            <label for="carType">Loại & kiểu xe:</label>
                            <input type="text" id="carType" name="loaixe" class="info-input car-type-input" required>
                        </div>
                        <div class="info-group inline-fields">
                            <div>
                                <label for="licensePlate">Biển số:</label>
                                <input type="text" id="licensePlate" name="bienso" class="info-input license-km-input" required>
                            </div>
                            <div>
                                <label for="kilometer">Kilô-mét:</label>
                                <input type="text" id="kilometer" name="sokm" class="info-input license-km-input" required>
                            </div>
                        </div>
                        <div class="info-group">
                            <label for="deliveryDateTime">Ngày gửi giao xe:</label>
                            <input type="datetime-local" id="deliveryDateTime" name="giaoxe" class="info-input datetime-input">
                        </div>
                        <div class="info-group">
                            <label for="branchSelect">Chi nhánh:</label>
                            <select id="branchSelect" name="chiNhanh" class="info-input" required>
                                <option value="">-- Chọn chi nhánh --</option>
                                <option value="Chi Nhánh 1 - Bình Phước">Chi Nhánh 1 - Bình Phước</option>
                                <option value="Chi Nhánh 2 - Đồng Xoài">Chi Nhánh 2 - Đồng Xoài</option>
                                <option value="Chi Nhánh 3 - Bình Dương">Chi Nhánh 3 - Bình Dương</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="tire-section">
                        <div class="tire-diagram-container">
                            <div class="tire-diagram">
                                <img src="sodooto.png" alt="Sơ đồ ô tô" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;">
                            </div>

                            <div class="tire-position tire-front-left">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_FL" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_FL" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-front-right">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_FR" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_FR" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-rear-left">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_RL" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_RL" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-rear-right">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_RR" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_RR" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-spare">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_Spare" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_Spare" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                        </div>

                        <div class="tire-size-recommendation">
                            <label for="tireSize">Size lốp khuyến cáo:</label>
                            <input type="text" id="tireSize" name="sizeLopKhuyenCao" placeholder="Nhập size lốp">
                        </div>
                        <div class="recommendation">
                            <label for="notes">Lưu ý:</label>
                            <textarea id="notes" name="ghiChuChung" placeholder="Ghi chú các lưu ý cần thiết"></textarea>
                        </div>
                    </div>

                    <div class="safety-check">
                        <div class="safety-title">
                            HẠNG MỤC KIỂM TRA AN TOÀN
                        </div>
                        <div class="safety-grid">
                            <div class="safety-header">HẠNG MỤC</div>
                            <div class="safety-header">TỐT</div>
                            <div class="safety-header">LƯU Ý</div>
                            <div class="safety-header">THAY</div>

                            <div class="safety-item">
                                <div class="item-name">Lốp</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_Lop_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_Lop_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_Lop_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Gạt mưa</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_GatMua_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_GatMua_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_GatMua_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Nước rửa kính</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocRuaKinh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocRuaKinh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocRuaKinh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Má phanh</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_MaPhanh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_MaPhanh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_MaPhanh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Đĩa phanh</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DiaPhanh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DiaPhanh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DiaPhanh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Dầu phanh</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauPhanh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauPhanh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauPhanh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Dầu động cơ</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauDongCo_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauDongCo_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauDongCo_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Lọc dầu động cơ</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocDauDongCo_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocDauDongCo_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocDauDongCo_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Nước làm mát</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocLamMat_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocLamMat_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocLamMat_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Ắc quy</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_AcQuy_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_AcQuy_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_AcQuy_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Lọc gió động cơ</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDongCo_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDongCo_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDongCo_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Lọc gió điều hòa</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDieuHoa_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDieuHoa_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDieuHoa_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Thước lái</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_ThuocLai_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_ThuocLai_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_ThuocLai_Thay" value="on"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="detailed-check">
                    <thead>
                        <tr>
                            <th class="stt">STT</th>
                            <th class="hang-muc">HẠNG MỤC</th>
                            <th class="dien-giai">DIỄN GIẢI</th>
                            <th class="sl">SL</th>
                            <th class="don-gia">ĐƠN GIÁ</th>
                            <th class="thanh-tien">THÀNH TIỀN</th>
                            <th class="xac-nhan">XÁC NHẬN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>01</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_1" value="Lốp"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_1"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_1" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_1" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_1" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_1" value="on"></td>
                        </tr>
                        <tr>
                            <td>02</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_2" value="Van"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_2"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_2" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_2" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_2" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_2" value="on"></td>
                        </tr>
                        <tr>
                            <td>03</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_3" value="Cân bằng động"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_3"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_3" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_3" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_3" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_3" value="on"></td>
                        </tr>
                        <tr>
                            <td>04</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_4" value="Cân chỉnh thước lái"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_4"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_4" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_4" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_4" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_4" value="on"></td>
                        </tr>
                        <tr>
                            <td>05</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_5" value="Phanh"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_5"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_5" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_5" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_5" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_5" value="on"></td>
                        </tr>
                        <tr>
                            <td>06</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_6" value="Gạt mưa"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_6"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_6" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_6" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_6" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_6" value="on"></td>
                        </tr>
                        <tr>
                            <td>07</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_7" value="Nước rửa kính"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_7"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_7" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_7" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_7" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_7" value="on"></td>
                        </tr>
                        <tr>
                            <td>08</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_8" value="Dầu động cơ"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_8"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_8" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_8" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_8" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_8" value="on"></td>
                        </tr>
                        <tr>
                            <td>09</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_9" value="Lọc dầu động cơ"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_9"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_9" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_9" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_9" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_9" value="on"></td>
                        </tr>
                        <tr>
                            <td>10</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_10" value="Lọc gió động cơ"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_10"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_10" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_10" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_10" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_10" value="on"></td>
                        </tr>
                        <tr>
                            <td>11</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_11" value="Lọc gió điều hòa"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_11"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_11" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_11" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_11" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_11" value="on"></td>
                        </tr>
                        <tr>
                            <td>12</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_12"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_12"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_12" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_12" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_12" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_12" value="on"></td>
                        </tr>
                        <tr>
                            <td>13</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_13"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_13"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_13" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_13" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_13" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_13" value="on"></td>
                        </tr>
                        <tr>
                            <td>14</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_14"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_14"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_14" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_14" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_14" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_14" value="on"></td>
                        </tr>
                        <tr>
                            <td>15</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_15"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_15"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_15" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_15" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_15" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_15" value="on"></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="5">TỔNG CỘNG</td>
                            <td><input type="text" id="grand-total" name="tongCong" readonly style="font-weight: bold;"></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

                <div class="footer"></div>
                <div class="recommendation1">
                    <label for="recommendationNotes"> Khuyến cáo :</label>
                    <textarea id="recommendationNotes" name="khuyenCao" placeholder="Ghi chú các khuyến cáo cần thiết"></textarea>
                </div>
                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">Đại lý</div>
                        <input type="text" list="nguoiPhuTrachList" class="signature-input" name="daiLyPhuTrach" placeholder="Chọn hoặc nhập tên">
                        <datalist id="nguoiPhuTrachList">
                            <option value="Cao Thanh Duy">
                            <option value="Trần Ngọc Hào">
                            <option value="Nguyễn Phước Hiếu">
                            <option value="Nguyễn Trung Kiên">
                        </datalist>
                        <div class="signature-subtitle">(Ký tên)</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Khách hàng</div>
                        <input type="text" class="signature-input" name="khachHangKyTen" placeholder="Ký tên">
                        <div class="signature-subtitle">(Ký tên)</div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Constants for Local Storage keys
        const RECEIPT_NUMBER_KEY = 'phieuKiemTraXe_receiptNumber';
        const LAST_MONTH_KEY = 'phieuKiemTraXe_lastMonth';
        const FORM_DATA_KEY = 'phieuKiemTraXe_formData';

        // Constants for branch locations
        const branchLocations = [
            { name: 'Chi Nhánh 1 - Bình Phước', lat: 11.5145974, lon: 106.8931262 },
            { name: 'Chi Nhánh 2 - Đồng Xoài', lat: 11.537788, lon: 106.905191 },
            { name: 'Chi Nhánh 3 - Bình Dương', lat: 11.004401, lon: 106.6719367 }
        ];
        const GEOLOCATION_ERROR_RADIUS = 100; // meters

        // --- Utility Functions ---

        /**
         * Calculates the distance between two geographical points using the Haversine formula.
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c;
            return d;
        }

        /**
         * Determines the closest branch based on current geolocation and automatically selects it.
         */
        function getClosestBranch() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        let closestBranch = null;
                        let minDistance = Infinity;

                        branchLocations.forEach(branch => {
                            const distance = getDistance(userLat, userLon, branch.lat, branch.lon);
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestBranch = branch;
                            }
                        });

                        const branchSelect = document.getElementById('branchSelect');
                        if (closestBranch && minDistance <= GEOLOCATION_ERROR_RADIUS) {
                            branchSelect.value = closestBranch.name;
                            console.log(`Tự động chọn chi nhánh: ${closestBranch.name} (khoảng cách: ${minDistance.toFixed(2)}m)`);
                        } else {
                            console.log('Không tìm thấy chi nhánh nào gần nhất hoặc khoảng cách quá xa.');
                        }
                        saveFormData();
                    },
                    (error) => {
                        console.warn(`Lỗi khi lấy vị trí: ${error.message}`);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('Trình duyệt không hỗ trợ Geolocation.');
            }
        }


        function calculateRowTotal(inputElement) {
            const row = inputElement.closest('tr');
            const quantity = parseFloat(row.querySelector('.sl-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.don-gia-input').value) || 0;
            const total = quantity * unitPrice;
            row.querySelector('.thanh-tien-input').value = total.toLocaleString('vi-VN');
            updateGrandTotal();
            saveFormData();
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.thanh-tien-input').forEach(input => {
                const value = parseFloat(input.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
                grandTotal += value;
            });
            document.getElementById('grand-total').value = grandTotal.toLocaleString('vi-VN');
        }

        function getCurrentDateTimeLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        }

        function resetFormAndLocalStorage() {
            const formElement = document.getElementById('inspectionFormXe');
            const receivedDateTimeInput = document.getElementById('receivedDateTime');

            localStorage.removeItem(FORM_DATA_KEY);
            formElement.reset();
            initializeReceiptNumber();
            receivedDateTimeInput.value = getCurrentDateTimeLocal();
            updateGrandTotal();
            hasSubmitted = false;
            alert('Form đã được xóa và reset thành công!');
        }

        // --- Receipt Number Management ---

        function initializeReceiptNumber() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            let lastStoredMonth = null;
            let lastStoredYear = null;
            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;

                    if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                        receiptNumber = 1;
                        localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                        localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                    }
                } catch (e) {
                    console.error("Lỗi khi đọc dữ liệu tháng từ localStorage:", e);
                    receiptNumber = 1;
                    localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                    localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                }
            } else {
                receiptNumber = 1;
                localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
            }

            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        function incrementReceiptNumberOnPrint() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;
                } catch (e) {
                    console.error("Lỗi khi đọc dữ liệu tháng từ localStorage:", e);
                }
            }

            if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                receiptNumber = 1;
            } else {
                receiptNumber++;
            }

            localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
            localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));

            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // --- Local Storage for Form Data ---

        function saveFormData() {
            const form = document.getElementById('inspectionFormXe');
            if (!form) return;

            const formData = {};
            const inputs = form.querySelectorAll('input:not([readonly]), textarea, select');
            inputs.forEach(input => {
                if (input.name) {
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked;
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value;
                        }
                    } else {
                        formData[input.name] = input.value;
                    }
                }
            });
            localStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData);
            const form = document.getElementById('inspectionFormXe');
            if (!form) return;
            for (const name in formData) {
                const elements = form.querySelectorAll(`[name="${name}"]`);
                if (elements.length > 0) {
                    elements.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = formData[name];
                        } else if (input.type === 'radio') {
                            if (input.value === formData[name]) {
                                input.checked = true;
                            }
                        } else {
                            input.value = formData[name];
                        }
                    });
                }
            }
            updateGrandTotal();
        }

        // --- Form Submission & Print Logic ---
        let hasSubmitted = false;

        document.addEventListener('DOMContentLoaded', () => {
            initializeReceiptNumber();

            const receivedDateTimeInput = document.getElementById('receivedDateTime');
            receivedDateTimeInput.value = getCurrentDateTimeLocal();

            loadFormData();
            getClosestBranch();

            const form = document.getElementById('inspectionFormXe');
            if (form) {
                form.addEventListener('input', saveFormData);
                form.addEventListener('change', saveFormData);
            }

            const submitButton = document.getElementById('submitToSheet');
            if (submitButton) {
                submitButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    const scriptURL = form.action;

                    if (!form.checkValidity()) {
                        alert('Vui lòng điền đầy đủ các trường bắt buộc trước khi gửi!');
                        form.reportValidity();
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = 'Đang gửi...';

                    const urlEncodedData = collectFormDataAsUrlEncoded(form);

                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData
                    })
                    .then(response => response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || 'Lỗi từ máy chủ không xác định.');
                        }
                        return data;
                    }))
                    .then(data => {
                        if (data.result === 'success') {
                            alert('✅ Gửi thông tin thành công! Bạn có thể in phiếu.');
                            console.log('Dữ liệu đã gửi:', data.row);
                            hasSubmitted = true;
                        } else {
                            alert('❌ Không gửi được: ' + (data.message || 'Lỗi không xác định từ Apps Script.'));
                            console.error('Lỗi từ Apps Script:', data.message);
                        }
                    })
                    .catch(error => {
                        alert('❌ Có lỗi xảy ra khi gửi. Vui lòng kiểm tra console (F12) để biết chi tiết.');
                        console.error('Lỗi Fetch hoặc phản hồi không hợp lệ:', error);
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = '📤 Gửi Thông Tin';
                    });
                });
            }

            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (!hasSubmitted) {
                        alert('Vui lòng nhấn "Gửi Thông Tin" trước khi in phiếu!');
                        return;
                    }

                    incrementReceiptNumberOnPrint();
                    alert('Vui lòng đảm bảo bạn đã chọn "Đồ họa nền" (Background graphics) hoặc "In màu nền" trong cài đặt in của trình duyệt để phiếu được in đúng màu.');
                    window.print();
                });
            }

            const clearFormButton = document.getElementById('clearFormButton');
            if (clearFormButton) {
                clearFormButton.addEventListener('click', () => {
                    if (confirm('Bạn có chắc chắn muốn xóa toàn bộ thông tin trên form không? (Chỉ xóa sau khi đã in thành công)')) {
                        resetFormAndLocalStorage();
                    }
                });
            }
        });

        function collectFormDataAsUrlEncoded(formElement) {
            const formData = new FormData(formElement);
            const params = new URLSearchParams();

            params.append('formType', formElement.querySelector('[name="formType"]').value);
            params.append('receiptNumber', document.getElementById('receiptNumber')?.textContent || '');
            params.append('currentMonthYear', document.getElementById('currentMonth')?.textContent || '');

            for (const pair of formData.entries()) {
                params.append(pair[0], pair[1]);
            }

            formElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked && !params.has(checkbox.name)) {
                    params.append(checkbox.name, '');
                }
            });
            const radioGroupNames = new Set();
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroupNames.add(radio.name));
            radioGroupNames.forEach(groupName => {
                const checkedRadioInGroup = formElement.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (!checkedRadioInGroup && !params.has(groupName)) {
                    params.append(groupName, '');
                }
            });
            return params.toString();
        }
    </script>
</body>
</html>

