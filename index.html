<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Kiểm Tra Xe - PHI LONG AUTO</title>
    <style>
	    .logo {text-align: right;}
		.logo img {height: 90px; object-fit: contain; }
	    .logo img {
    		height: 90px;
    		margin-top: 10px;   /* đẩy logo xuống */
    			/* hoặc margin-bottom: 10px; để đẩy lên */
	    }
	    .header-right {
   		display: flex;
    		align-items: center;  /* canh giữa chiều dọc */
   		justify-content: flex-end;  /* đẩy logo sát phải */ 
	    }

        /* Reset và cấu hình cơ bản */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 230mm; /* Đã tăng kích thước A4 theo chiều ngang để chứa đủ các nút */
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .form-content {
            padding: 15mm; /* Khoảng cách lề trong phiếu */
        }

        /* Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 5px;
        }

        .form-number {
            font-size: 16px;
            font-weight: bold;
        }

        .header-right {
            text-align: right;
        }

        .logo {
            width: 80px;
            height: 60px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
        }

        /* Customer Info Section */
        .customer-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .info-group {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-group label {
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }

        .info-group .info-input {
            border: none;
            border-bottom: 1px dotted #000;
            flex-grow: 1;
            padding: 0 5px;
            font-size: 12px;
            min-width: 50px;
        }
        .info-group .info-input.name-input { min-width: 150px; }
        .info-group .info-input.phone-email-input { min-width: 90px; }
        .info-group .info-input.datetime-input { min-width: 130px; }
        .info-group .info-input.car-type-input { min-width: 150px; }
        .info-group .info-input.license-km-input { min-width: 90px; }

        .info-group input[type="checkbox"] {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .info-group input[type="radio"] { /* Added style for radio buttons */
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .info-group.inline-fields {
            align-items: flex-start;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .info-group.inline-fields > div {
            display: flex;
            align-items: center;
        }
        .info-group.inline-fields label {
            margin-right: 5px;
        }
        .info-group.inline-fields .info-input {
            flex-shrink: 1;
        }


        /* Main Content Section */
        /* ĐIỀU CHỈNH LẦN NÀY: Dùng flexbox để kiểm soát tốt hơn bố cục màn hình */
        .main-content {
            display: flex; /* Thay đổi từ grid sang flex */
            justify-content: space-between; /* Đẩy hai cột sang hai bên */
            align-items: flex-start; /* Căn chỉnh các mục từ trên xuống */
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Cho phép các mục xuống dòng trên màn hình nhỏ */
        }

        /* Tire Section */
        /* ĐIỀU CHỈNH LẦN NÀY: Giới hạn chiều rộng tối đa cho khối sơ đồ xe */
        .tire-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            justify-content: flex-start;
            max-width: 280px; /* Giới hạn chiều rộng tối đa cho khối này */
            flex-shrink: 0; /* Ngăn không cho khối này bị co lại quá mức nếu có quá nhiều nội dung */
        }

        /* ĐIỀU CHỈNH LẦN NÀY: Thu nhỏ KÍCH THƯỚC tổng thể của SƠ ĐỒ LỐP trên màn hình */
        .tire-diagram-container {
            position: relative;
            width: 120px; /* Đã giảm từ 140px xuống 120px */
            height: 170px; /* Đã giảm từ 200px xuống 170px */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .tire-diagram {
            position: relative;
            width: 100%;
            height: 100%;
            border: none;
            background: none;
            z-index: 0;
            flex-shrink: 0;
        }

        .tire-diagram img {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            object-fit: contain;
            object-position: center;
        }

        /* Khung nhập liệu cho từng lốp - điều chỉnh kích thước và font */
        .tire-position {
            position: absolute;
            background: white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            font-size: 11px;
            color: Black;
            padding: 3px 5px;
            box-sizing: border-box;
            z-index: 1;
            width: 85px;
            height: auto;
            line-height: 1.1;
            border: 1px solid #000;
        }

        /* ĐIỀU CHỈNH LẦN NÀY: Tinh chỉnh vị trí các ô nhập liệu Áp suất/Độ dày để khớp với hình ảnh đã thu nhỏ */
        .tire-front-left { top: 20px; left: -85px; } /* Điều chỉnh vị trí */
        .tire-front-right { top: 20px; left: 120px; } /* Điều chỉnh vị trí */
        .tire-rear-left { top: 115px; left: -85px; } /* Điều chỉnh vị trí */
        .tire-rear-right { top: 115px; left: 120px; } /* Điều chỉnh vị trí */
        .tire-spare { bottom: -10px; left: 50%; transform: translateX(-50%); width: 85px; }


        .tire-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 1px;
            width: 100%;
            justify-content: space-between;
        }
        .tire-input-group:last-child {
            margin-bottom: 0;
        }

        .tire-input-group label {
            font-size: 9px;
            white-space: nowrap;
            margin-right: 2px;
        }

        .pressure-input, .thickness-input {
            background: white;
            border: 1px solid #ccc;
            width: 35px;
            height: 15px;
            text-align: center;
            font-size: 8px;
            padding: 0 1px;
        }
        .tire-position small {
            font-size: 7px;
            margin-left: 1px;
        }

        /* Phần "Size lốp khuyến cáo" và "Lưu ý" */
        .tire-size-recommendation {
            width: 100%;
            margin-bottom: 10px;
        }

        .tire-size-recommendation label {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        .tire-size-recommendation input {
            border: none;
            border-bottom: 1px dotted #000;
            width: 100%;
            text-align: left;
            min-width: 120px;
            font-size: 11px;
        }

        .recommendation {
            font-size: 11px;
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-top: 0;
        }

        .recommendation label {
            margin-bottom: 5px;
        }

        .recommendation textarea {
            width: 100%;
            flex-grow: 1;
            border: 1px dotted #000;
            padding: 5px;
            resize: vertical;
            font-size: 11px;
            min-height: 50px;
        }

        /* Safety Check Section */
        .safety-check {
            border: 1px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-grow: 1; /* Cho phép khối này giãn nở để chiếm không gian còn lại */
        }

        .safety-title {
            background: #003366;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            margin: -10px -10px 10px -10px;
        }

        .safety-grid {
            display: grid;
            /* Cột này chỉ ảnh hưởng đến màn hình hiển thị, không ảnh hưởng bản in */
            grid-template-columns: 2.5fr 1fr 1fr 1fr;
            gap: 5px;
            font-size: 11px;
            flex-grow: 1;
        }

        .safety-header {
            font-weight: bold;
            text-align: center;
            padding: 3px;
            background: #f0f0f0;
        }
        .safety-grid .safety-header:nth-child(2),
        .safety-grid .safety-header:nth-child(3),
        .safety-grid .safety-header:nth-child(4) {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px 0;
        }

        .safety-item {
            display: contents;
        }

        .item-name {
            padding: 3px;
            border-bottom: 1px dotted #ccc;
            text-align: left;
            font-weight: bold;
        }

        .checkbox-cell {
            text-align: center;
            padding: 3px;
            border-bottom: 1px dotted #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox {
            width: 15px;
            height: 15px;
            border: 1px solid #000;
            cursor: pointer;
            margin: 0;
        }

        /* Detailed Check Table */
        .detailed-check {
            margin-top: 15px;
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
        }

        .detailed-check th,
        .detailed-check td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 11px;
        }

        .detailed-check th {
            background: #003366;
            color: white;
            font-weight: bold;
        }

        .detailed-check .stt { width: 30px; }
        .detailed-check .hang-muc {
            width: 120px;
            text-align: left;
            font-weight: bold;
        }
        .detailed-check .dien-giai { width: 180px; }
        .detailed-check .sl { width: 50px; }
        .detailed-check .don-gia, .detailed-check .thanh-tien { width: 90px; }
        .detailed-check .xac-nhan { width: 60px; }

        .detailed-check input[type="text"] {
            width: 100%;
            border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }
        /* Make numeric inputs for quantity/unit price use type="number" */
        .detailed-check input[type="number"] {
            width: 100%;
            border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }

        .detailed-check input[type="text"].hang-muc-input {
            text-align: left;
            font-weight: bold;
        }

        .detailed-check input[type="checkbox"] {
            width: 15px;
            height: 15px;
            margin: 0 auto;
            display: block;
        }

        .total-row {
            background: #ccc;
            font-weight: bold;
        }

        /* Signature Section */
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 20px;
            padding-top: 15px;
        }

        .signature-box { text-align: center; }

        .signature-title {
            font-weight: bold;
            margin-bottom: 30px;
        }

        .signature-input {
            border: none;
            border-bottom: 1px dotted #000;
            width: 100%;
            text-align: center;
            padding: 2px 0;
            font-size: 12px;
            margin-top: -20px;
        }

        .signature-line {
            border-bottom: 1px solid #000;
            margin-bottom: 5px;
            height: 1px;
        }

        .signature-subtitle {
            font-size: 10px;
            font-style: italic;
        }

        /* Footer */
        .footer {
            margin-top: 15px;
            font-size: 9px;
            line-height: 1.2;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        /* Buttons */
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            gap: 10px; /* Điều chỉnh khoảng cách giữa các nút */
            margin-bottom: 20px;
        }

        .tire-form-button, .print-button, .clear-button {
            padding: 8px 12px; /* Giảm padding để nút nhỏ gọn hơn */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px; /* Giảm font size */
            white-space: nowrap; /* Ngăn văn bản trong nút xuống dòng */
            flex-shrink: 0; /* Đảm bảo nút không bị co lại quá mức */
        }

        .print-button {
            background: #007bff;
            color: white;
        }

        .print-button:hover { background: #0056b3; }

        .clear-button { /* New style for clear button */
            background: #dc3545;
            color: white;
        }
        .clear-button:hover { background: #c82333; }

        .tire-form-button {
            background: #28a745;
            color: white;
        }
        .tire-form-button:hover { background: #218838; }

        /* Print Styles */
        @media print {
            .button-group { display: none; } /* Ẩn nút khi in */

            body {
                margin: 0;
                padding: 0;
                background: white;
                font-size: 11px;
                font-weight: 500;
            }

            .container {
                max-width: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .form-content {
                padding: 8mm;
                width: 210mm;
                height: 297mm;
                box-sizing: border-box;
                overflow: hidden;
            }

            .header { margin-bottom: 8px; padding-bottom: 5px; }
            .header h1 { font-size: 18px; }
            .form-number { font-size: 14px; }
            .logo { width: 60px; height: 45px; font-size: 8px; }

            .customer-info { margin-bottom: 8px; gap: 10px; }
            .info-group { margin-bottom: 6px; font-size: 14px; }
            .info-group .info-input { font-size: 14px; min-width: 40px; }
            .info-group .info-input.name-input { min-width: 120px; }
            .info-group .info-input.phone-email-input { min-width: 90px; }
            .info-group .info-input.datetime-input { min-width: 100px; }
            .info-group .info-input.car-type-input { min-width: 100px; }
            .info-group .info-input.license-km-input { min-width: 90px; }
            .info-group.inline-fields { justify-content: flex-start; }
            .info-group.inline-fields > div { margin-right: 5px; }
            .info-group.inline-fields label { margin-right: 2px; }

            /* Điều chỉnh: main-content để cân bằng hơn giữa 2 cột, giảm không gian cho bảng kiểm tra an toàn */
            .main-content {
                grid-template-columns: 1fr 1fr; /* Đã đổi từ 0.7fr 1.3fr thành 1fr 1fr để cân bằng */
                gap: 5px;
                margin-bottom: 8px;
            }

            /* Điều chỉnh KÍCH THƯỚC VÀ VỊ TRÍ tổng thể của SƠ ĐỒ LỐP khi in */
            .tire-diagram-container {
                width: 180px !important; /* Thu nhỏ chiều rộng ảnh sơ đồ khi in */
                height: 210px !important; /* Thu nhỏ chiều cao ảnh sơ đồ khi in */
                margin-left: 50px !important; /* Căn giữa trong khoảng không gian cột */
                margin-right: auto !important; /* Căn giữa trong khoảng không gian cột */
                transform: none !important; /* Reset transform scale */
                padding-bottom: 5px !important;
                margin-bottom: 5px !important;
            }

            .tire-diagram {
                width: 100% !important;
                height: 100% !important;
            }

            /* Khung nhập liệu cho từng lốp - điều chỉnh kích thước và font khi in */
            .tire-position {
                font-size: 10px !important; /* TĂNG FONT CỠ CHỮ CƠ BẢN KHI IN */
                padding: 5px 6px !important; /* TĂNG PADDING KHI IN */
                width: 80px !important; /* TĂNG CHIỀU RỘNG CỐ ĐỊNH CHO Ô NHẬP KHI IN */
                height: auto !important;
                line-height: 1 !important; /* TĂNG LINE-HEIGHT KHI IN */
                border-radius: 6px !important;
            }

            /* Vị trí ô nhập liệu khi in (tương đối với sơ đồ đã thu nhỏ và căn giữa) */
            /* Cần tinh chỉnh lại các giá trị này để khớp đúng trên sơ đồ đã điều chỉnh */
            /* DI CHUYỂN CÁC Ô SÁT BÁNH XE HƠN, VÀ ĐIỀU CHỈNH LẠI DO THAY ĐỔI KÍCH THƯỚC Ô */
            .tire-front-left { top: 25px !important; left: -50px !important; } /* Đã điều chỉnh */
            .tire-front-right { top: 25px !important; left: 150px !important; } /* Đã điều chỉnh */
            .tire-rear-left { top: 110px !important; left: -50px !important; } /* Đã điều chỉnh */
            .tire-rear-right { top: 110px !important; left: 150px !important; } /* Đã điều chỉnh */
            .tire-spare { bottom: -30px !important; left: 50% !important; transform: translateX(-50%) !important; width: 60px !important; } /* Tăng width khi in - bootom thay đổi vị trí */

            .tire-input-group label {
                font-size: 9px !important; /* TĂNG FONT LABEL KHI IN */
                margin-right: 1px !important;
                font-weight: bold !important;
                font-family: Arial, Helvetica, sans-serif !important;
            }
            .pressure-input, .thickness-input {
                width: 35px !important; /* TĂNG WIDTH INPUT KHI IN */
                height: 16px !important; /* TĂNG HEIGHT INPUT KHI IN */
                font-size: 14px !important; /* TĂNG FONT INPUT KHI IN */
                padding: 2px 2px !important;
            }
            .tire-position small {
                font-size: 9px !important; /* TĂNG FONT ĐƠN VỊ KHI IN */
                margin-left: 1px !important;
            }

            .tire-section > .tire-size-recommendation {
                margin-top: 7px !important;
            }
            .tire-size-recommendation label { margin-bottom: 1px; font-size: 14px; }
            .tire-size-recommendation input { min-width: 70px; font-size: 12px; }
			.tire-size-recommendation {position: absolute !important; top: 150px !important; left: 230px !important; }

            .recommendation { font-size: 14px; height: 60px; margin-top: 5px; }
            .recommendation textarea { min-height: 90px; height: 90px; font-size: 13px; width: 200%; padding: 4px; box-sizing: border-box; }

            .safety-check { padding: 5px; height: auto; flex-grow: 0; }
            /* ĐIỀU CHỈNH: safety-grid để thu hẹp cột "Hạng Mục" và cố định các cột checkbox. */
            .safety-grid {
                flex-grow: 0;
                height: auto;
                font-size: 9px;
                gap: 2px;
                /* Cột Hạng Mục (1fr) sẽ chiếm phần còn lại, 3 cột checkbox có chiều rộng cố định */
                grid-template-columns: 1fr 12mm 12mm 12mm;
            }
            .safety-title { padding: 3px; font-size: 11px; margin: -5px -5px 5px -5px; }
            .checkbox { width: 12px; height: 12px; }
            .item-name {
                padding: 1px;
                font-size: 9px;
                /* ĐIỀU CHỈNH: In đậm chữ trong cột "Hạng Mục" của bảng kiểm tra an toàn khi in */
                font-weight: bold;
                font-size: 13px;
            }

            .detailed-check { margin-top: 8px; font-size: 9px; }
            .detailed-check th, .detailed-check td { padding: 2px; font-size: 9px; }
            .detailed-check input[type="text"], .detailed-check input[type="number"] { font-size: 9px; }
            .detailed-check input[type="checkbox"] { width: 12px; height: 12px; }

            .detailed-check .hang-muc {
                /* ĐIỀU CHỈNH: In đậm chữ trong cột "Hạng Mục" của bảng chi tiết khi in */
                font-weight: bold;
                font-size: 13px;
            }
            .detailed-check input[type="text"].hang-muc-input {
                /* ĐIỀU CHỈNH: In đậm chữ trong ô input của cột "Hạng Mục" khi in */
                font-weight: bold;
                font-size: 13px;
            }

            .footer { font-size: 8px; margin-top: 8px; padding-top: 5px; line-height: 1.1; }

            .signature-section { margin-top: 8px; padding-top: 5px; gap: 30px; }
            .signature-title { margin-bottom: 15px; font-size: 10px; }
            .signature-input { font-size: 10px; margin-top: -10px; }
            .signature-subtitle { font-size: 8px; }

            .main-content, .detailed-check, .signature-section { page-break-inside: avoid; }

            /* BỔ SUNG: In đậm TẤT CẢ dữ liệu nhập liệu của người dùng khi in */
            /* Bao gồm tất cả các loại input trừ readonly và textarea */
            .form-content input:not([readonly]),
            .form-content textarea {
                font-weight: bold !important;
            }
            /* Đảm bảo các ô tính toán tổng và các lựa chọn radio đã chọn cũng in đậm */
            .detailed-check .thanh-tien-input, /* Đây là input readonly nhưng cần in đậm */
            #grand-total, /* Đây là input readonly nhưng cần in đậm */
            .info-group input[type="radio"]:checked + label { /* In đậm label của radio đã chọn */
                font-weight: bold !important;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button class="tire-form-button print-button" id="printButton">🖨️ In Phiếu Kiểm Tra</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/tracuu.html'">📄 Tra cứu thông tin xe </button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieu_kiem_tra_lop.html'">📄 Phiếu Kiểm Tra Lốp</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">📄 Phiếu Kiểm Gầm</button>
	    <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieunhandichvu.html'">📄 Phiếu Dịch Vụ </button>
            <button class="tire-form-button" id="submitToSheet">📤 Gửi Thông Tin</button>
            <button class="tire-form-button clear-button" id="clearFormButton">🗑️ Xóa Form</button>
        </div>
        <div class="form-content">
            <form id="inspectionFormXe" action="https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec" method="POST">
                <input type="hidden" name="formType" value="PhieuKiemTraXe">

                <div class="header">
                    <div class="header-left">
                        <h1>PHIẾU KIỂM TRA XE</h1>
                        <div class="form-number">№ <span id="receiptNumber"></span> / <span id="currentMonth"></span></div>
                    </div>
                    <div class="header-right">
                        <div class="logo">
                            <img src="https://longvt89.github.io/phieukiemtra/logophilong.jpg" alt="Logo Phi Long Auto" style="height: 90px;">
                        </div>
                    </div>
                </div>

                <div class="customer-info">
                    <div class="customer-left">
                        <div class="info-group">
                            <label for="customerName">Họ tên:</label>
                            <input type="text" id="customerName" name="hoten" class="info-input name-input" required>
                        </div>
                        <div class="info-group inline-fields">
                            <div>
                                <label for="customerPhone">Điện thoại:</label>
                                <input type="tel" id="customerPhone" name="dienthoai" class="info-input phone-email-input" required>
                            </div>
                            <div>
                                <label for="customerEmail">E-mail:</label>
                                <input type="email" id="customerEmail" name="email" class="info-input phone-email-input">
                            </div>
                        </div>
                        <div class="info-group">
                            <label for="receivedDateTime">Ngày giờ nhận xe:</label>
                            <input type="datetime-local" id="receivedDateTime" name="nhanxe" class="info-input datetime-input" required>
                        </div>
                        <div class="info-group">
                            <label>Kiểm tra an toàn (Có/Không):</label>
                            <label><input type="radio" name="kiemTraAnToan" value="Có"> Có</label>
                            <label><input type="radio" name="kiemTraAnToan" value="Không"> Không</label>
                        </div>
                    </div>
                    <div class="customer-right">
                        <div class="info-group">
                            <label for="carType">Loại & kiểu xe:</label>
                            <input type="text" id="carType" name="loaixe" class="info-input car-type-input" required>
                        </div>
                        <div class="info-group inline-fields">
                            <div>
                                <label for="licensePlate">Biển số:</label>
                                <input type="text" id="licensePlate" name="bienso" class="info-input license-km-input" required>
                            </div>
                            <div>
                                <label for="kilometer">Kilô-mét:</label>
                                <input type="text" id="kilometer" name="sokm" class="info-input license-km-input" required>
                            </div>
                        </div>
                        <div class="info-group">
                            <label for="deliveryDateTime">Ngày gửi giao xe:</label>
                            <input type="datetime-local" id="deliveryDateTime" name="giaoxe" class="info-input datetime-input">
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="tire-section">
                        <div class="tire-diagram-container">
                            <div class="tire-diagram">
                                <img src="sodooto.png" alt="Sơ đồ ô tô" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;">
                            </div>

                            <div class="tire-position tire-front-left">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_FL" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_FL" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-front-right">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_FR" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_FR" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-rear-left">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_RL" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_RL" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-rear-right">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_RR" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_RR" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                            <div class="tire-position tire-spare">
                                <div class="tire-input-group">
                                    <label>Áp suất:</label>
                                    <input type="number" step="0.1" class="pressure-input" name="tire_pressure_Spare" placeholder="0">
                                    <small>kg/cm²</small>
                                </div>
                                <div class="tire-input-group">
                                    <label>Độ dày:</label>
                                    <input type="number" step="0.1" class="thickness-input" name="tire_thickness_Spare" placeholder="0">
                                    <small>mm</small>
                                </div>
                            </div>
                        </div>

                        <div class="tire-size-recommendation">
                            <label for="tireSize">Size lốp khuyến cáo:</label>
                            <input type="text" id="tireSize" name="sizeLopKhuyenCao" placeholder="Nhập size lốp">
                        </div>
                        <div class="recommendation">
                            <label for="notes">Lưu ý:</label>
                            <textarea id="notes" name="ghiChuChung" placeholder="Ghi chú các lưu ý cần thiết"></textarea>
                        </div>
                    </div>

                    <div class="safety-check">
                        <div class="safety-title">
                            HẠNG MỤC KIỂM TRA AN TOÀN
                        </div>
                        <div class="safety-grid">
                            <div class="safety-header">HẠNG MỤC</div>
                            <div class="safety-header">TỐT</div>
                            <div class="safety-header">LƯU Ý</div>
                            <div class="safety-header">THAY</div>

                            <div class="safety-item">
                                <div class="item-name">Lốp</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_Lop_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_Lop_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_Lop_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Gạt mưa</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_GatMua_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_GatMua_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_GatMua_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Nước rửa kính</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocRuaKinh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocRuaKinh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocRuaKinh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Má phanh</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_MaPhanh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_MaPhanh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_MaPhanh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Đĩa phanh</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DiaPhanh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DiaPhanh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DiaPhanh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Dầu phanh</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauPhanh_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauPhanh_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauPhanh_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Dầu động cơ</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauDongCo_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauDongCo_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_DauDongCo_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Lọc dầu động cơ</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocDauDongCo_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocDauDongCo_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocDauDongCo_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Nước làm mát</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocLamMat_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocLamMat_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_NuocLamMat_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Ắc quy</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_AcQuy_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_AcQuy_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_AcQuy_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Lọc gió động cơ</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDongCo_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDongCo_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDongCo_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Lọc gió điều hòa</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDieuHoa_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDieuHoa_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_LocGioDieuHoa_Thay" value="on"></div>
                            </div>

                            <div class="safety-item">
                                <div class="item-name">Thước lái</div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_ThuocLai_Tot" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_ThuocLai_LuuY" value="on"></div>
                                <div class="checkbox-cell"><input type="checkbox" class="checkbox" name="safety_ThuocLai_Thay" value="on"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="detailed-check">
                    <thead>
                        <tr>
                            <th class="stt">STT</th>
                            <th class="hang-muc">HẠNG MỤC</th>
                            <th class="dien-giai">DIỄN GIẢI</th>
                            <th class="sl">SL</th>
                            <th class="don-gia">ĐƠN GIÁ</th>
                            <th class="thanh-tien">THÀNH TIỀN</th>
                            <th class="xac-nhan">XÁC NHẬN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>01</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_1" value="Lốp"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_1"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_1" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_1" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_1" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_1" value="on"></td>
                        </tr>
                        <tr>
                            <td>02</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_2" value="Van"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_2"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_2" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_2" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_2" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_2" value="on"></td>
                        </tr>
                        <tr>
                            <td>03</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_3" value="Cân bằng động"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_3"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_3" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_3" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_3" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_3" value="on"></td>
                        </tr>
                        <tr>
                            <td>04</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_4" value="Cân chỉnh thước lái"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_4"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_4" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_4" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_4" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_4" value="on"></td>
                        </tr>
                        <tr>
                            <td>05</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_5" value="Phanh"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_5"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_5" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_5" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_5" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_5" value="on"></td>
                        </tr>
                        <tr>
                            <td>06</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_6" value="Gạt mưa"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_6"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_6" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_6" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_6" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_6" value="on"></td>
                        </tr>
                        <tr>
                            <td>07</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_7" value="Nước rửa kính"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_7"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_7" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_7" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_7" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_7" value="on"></td>
                        </tr>
                        <tr>
                            <td>08</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_8" value="Dầu động cơ"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_8"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_8" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_8" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_8" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_8" value="on"></td>
                        </tr>
                        <tr>
                            <td>09</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_9" value="Lọc dầu động cơ"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_9"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_9" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_9" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_9" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_9" value="on"></td>
                        </tr>
                        <tr>
                            <td>10</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_10" value="Lọc gió động cơ"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_10"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_10" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_10" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_10" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_10" value="on"></td>
                        </tr>
                        <tr>
                            <td>11</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_11" value="Lọc gió điều hòa"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_11"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_11" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_11" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_11" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_11" value="on"></td>
                        </tr>
                        <tr>
                            <td>12</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_12"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_12"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_12" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_12" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_12" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_12" value="on"></td>
                        </tr>
                        <tr>
                            <td>13</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_13"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_13"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_13" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_13" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_13" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_13" value="on"></td>
                        </tr>
                        <tr>
                            <td>14</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_14"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_14"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_14" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_14" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_14" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_14" value="on"></td>
                        </tr>
                        <tr>
                            <td>15</td>
                            <td class="hang-muc"><input type="text" class="hang-muc-input" name="item_hangMuc_15"></td>
                            <td><input type="text" class="dien-giai-input" name="item_dienGiai_15"></td>
                            <td><input type="number" step="any" class="sl-input" name="item_soLuong_15" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" step="any" class="don-gia-input" name="item_donGia_15" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="thanh-tien-input" name="item_thanhTien_15" readonly></td>
                            <td class="xac-nhan"><input type="checkbox" name="item_xacNhan_15" value="on"></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="5">TỔNG CỘNG</td>
                            <td><input type="text" id="grand-total" name="tongCong" readonly style="font-weight: bold;"></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

                <div class="footer">
                    <p><strong>Khuyến nghị:</strong></p>
                    <p>□ "Tôi đồng ý đăng ký số liệu cá nhân năm được cung cấp theo mẫu này có thể được lưu trữ và sử dụng cho mục đích liên quan đến 02 năm PHI LONG AUTO (Công Ty), nhằm mục đích truyền thông sản phẩm và dịch vụ của chúng tôi và các đối tác kinh doanh liên quan. Tôi có thể rút lại sự đồng ý của mình bất cứ lúc nào bằng cách liên hệ với Công Ty và yêu cầu loại bỏ thông tin cá nhân của tôi khỏi cơ sở dữ liệu này."</p>
                </div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">Đại lý</div>
                        <input type="text" list="nguoiPhuTrachList" class="signature-input" name="daiLyPhuTrach" placeholder="Chọn hoặc nhập tên">
                        <datalist id="nguoiPhuTrachList">
                            <option value="Cao Thanh Duy">
                            <option value="Trần Ngọc Hào">
                            <option value="Nguyễn Phước Hiếu">
                            <option value="Nguyễn Trung Kiên">
                        </datalist>
                        <div class="signature-subtitle">(Ký tên)</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Khách hàng</div>
                        <input type="text" class="signature-input" name="khachHangKyTen" placeholder="Ký tên">
                        <div class="signature-subtitle">(Ký tên)</div>
                    </div>
                </div>
            </form>
            </div>
    </div>

    <script>
        // Constants for Local Storage keys
        const RECEIPT_NUMBER_KEY = 'phieuKiemTraXe_receiptNumber';
        const LAST_MONTH_KEY = 'phieuKiemTraXe_lastMonth';
        const FORM_DATA_KEY = 'phieuKiemTraXe_formData'; // Key for saving form data

        // --- Utility Functions ---

        function calculateRowTotal(inputElement) {
            const row = inputElement.closest('tr');
            // Ensure inputs are treated as numbers, handle empty string as 0
            const quantity = parseFloat(row.querySelector('.sl-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.don-gia-input').value) || 0;
            const total = quantity * unitPrice;
            row.querySelector('.thanh-tien-input').value = total.toLocaleString('vi-VN');
            updateGrandTotal();
            saveFormData(); // Save data after calculation
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.thanh-tien-input').forEach(input => {
                // Parse locale-specific number (e.g., "1.000.000" -> 1000000)
                const value = parseFloat(input.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
                grandTotal += value;
            });
            document.getElementById('grand-total').value = grandTotal.toLocaleString('vi-VN');
        }

        function getCurrentDateTimeLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        }

        function resetFormAndLocalStorage() {
            const formElement = document.getElementById('inspectionFormXe');
            const receivedDateTimeInput = document.getElementById('receivedDateTime');

            localStorage.removeItem(FORM_DATA_KEY); // Clear saved data
            formElement.reset(); // Reset all form fields
            initializeReceiptNumber(); // Re-initialize receipt number for the next form
            receivedDateTimeInput.value = getCurrentDateTimeLocal(); // Set current time for next form
            updateGrandTotal(); // Update total to 0
            hasSubmitted = false; // Reset submission flag
            alert('Form đã được xóa và reset thành công!');
        }

        // --- Receipt Number Management ---

        function initializeReceiptNumber() {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;

                    if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                        receiptNumber = 1; // Reset if month or year changed
                        localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                        localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                    }
                    // else: Keep existing number if still in same month/year
                } catch (e) {
                    console.error("Lỗi khi đọc dữ liệu tháng từ localStorage:", e);
                    // Fallback to reset if parse error
                    receiptNumber = 1;
                    localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                    localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                }
            } else {
                receiptNumber = 1; // First time, set to 1
                localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
            }

            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        function incrementReceiptNumberOnPrint() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;
                } catch (e) {
                    console.error("Lỗi khi đọc dữ liệu tháng từ localStorage:", e);
                }
            }

            if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                receiptNumber = 1; // Reset if month/year changed before increment
            } else {
                receiptNumber++;
            }

            localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
            localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));

            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // --- Local Storage for Form Data ---

        function saveFormData() {
            const form = document.getElementById('inspectionFormXe');
            if (!form) return;

            const formData = {};
            // Select all relevant form elements (inputs, textareas, selects).
            // Exclude read-only inputs that are calculated or displayed (like receipt number, grand total)
            const inputs = form.querySelectorAll('input:not([readonly]), textarea, select');

            inputs.forEach(input => {
                if (input.name) { // Only process elements with a 'name' attribute
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked;
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value;
                        }
                    } else {
                        formData[input.name] = input.value;
                    }
                }
            });
            localStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData));
            // console.log('Form data saved to localStorage:', formData); // For debugging
        }

        function loadFormData() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData);
            const form = document.getElementById('inspectionFormXe');
            if (!form) return;

            for (const name in formData) {
                const elements = form.querySelectorAll(`[name="${name}"]`);
                if (elements.length > 0) {
                    elements.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = formData[name];
                        } else if (input.type === 'radio') {
                            if (input.value === formData[name]) {
                                input.checked = true;
                            }
                        } else {
                            input.value = formData[name];
                        }
                    });
                }
            }
            // console.log('Form data loaded from localStorage:', formData); // For debugging
            updateGrandTotal(); // Recalculate total after loading data
        }

        // --- Form Submission & Print Logic ---
        let hasSubmitted = false; // Flag to track if form has been submitted successfully

        document.addEventListener('DOMContentLoaded', () => {
            initializeReceiptNumber(); // Set up receipt number (before loading form data to avoid overwrite)

            const receivedDateTimeInput = document.getElementById('receivedDateTime');
            receivedDateTimeInput.value = getCurrentDateTimeLocal();

            loadFormData(); // Attempt to load saved data when page loads

            const form = document.getElementById('inspectionFormXe');
            if (form) {
                // Attach event listeners to save data on input/change
                form.addEventListener('input', saveFormData);
                form.addEventListener('change', saveFormData); // For checkboxes, radio buttons, select elements
            }

            // Event listener for the "Send Information" button
            const submitButton = document.getElementById('submitToSheet');
            if (submitButton) {
                submitButton.addEventListener('click', (event) => { // Added event parameter
                    event.preventDefault(); // Prevent default form submission
                    const scriptURL = form.action; // Get URL from form's action attribute

                    // Simple form validation: check if required fields are filled
                    if (!form.checkValidity()) {
                        alert('Vui lòng điền đầy đủ các trường bắt buộc trước khi gửi!');
                        form.reportValidity(); // Hiển thị các lỗi validation của trình duyệt
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = 'Đang gửi...';

                    const urlEncodedData = collectFormDataAsUrlEncoded(form);

                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData
                    })
                    .then(response => response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || 'Lỗi từ máy chủ không xác định.');
                        }
                        return data;
                    }))
                    .then(data => {
                        if (data.result === 'success') {
                            alert('✅ Gửi thông tin thành công! Bạn có thể in phiếu.');
                            console.log('Dữ liệu đã gửi:', data.row);
                            hasSubmitted = true; // Set flag to true
                            // Data is NOT cleared/reset here anymore. User will explicitly clear.
                        } else {
                            alert('❌ Không gửi được: ' + (data.message || 'Lỗi không xác định từ Apps Script.'));
                            console.error('Lỗi từ Apps Script:', data.message);
                        }
                    })
                    .catch(error => {
                        alert('❌ Có lỗi xảy ra khi gửi. Vui lòng kiểm tra console (F12) để biết chi tiết.');
                        console.error('Lỗi Fetch hoặc phản hồi không hợp lệ:', error);
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = '📤 Gửi Thông Tin';
                    });
                });
            }

            // Event listener for the "Print" button
            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default print behavior
                    if (!hasSubmitted) {
                        alert('Vui lòng nhấn "Gửi Thông Tin" trước khi in phiếu!');
                        return; // Stop execution if not submitted
                    }

                    // Tăng số phiếu trước khi in (vì mỗi bản in là một phiếu mới)
                    incrementReceiptNumberOnPrint();
                    window.print(); // Trigger print dialog
                    // We DO NOT reset/clear here automatically anymore.
                    // The user will confirm print and then clear manually.
                });
            }

            // NEW: Event listener for the "Clear Form" button
            const clearFormButton = document.getElementById('clearFormButton');
            if (clearFormButton) {
                clearFormButton.addEventListener('click', () => {
                    // Ask for user confirmation before clearing the form
                    if (confirm('Bạn có chắc chắn muốn xóa toàn bộ thông tin trên form không? (Chỉ xóa sau khi đã in thành công)')) {
                        resetFormAndLocalStorage(); // Call the dedicated reset function
                    }
                });
            }

            // IMPORTANT: Removed window.onafterprint automatic reset.
            // This is replaced by the manual "Clear Form" button for reliability across devices.
        });

        // Helper function to collect form data for submission
        function collectFormDataAsUrlEncoded(formElement) {
            const formData = new FormData(formElement);
            const params = new URLSearchParams();

            // Add formType and receipt number/month from span elements
            params.append('formType', formElement.querySelector('[name="formType"]').value);
            params.append('receiptNumber', document.getElementById('receiptNumber')?.textContent || '');
            params.append('currentMonthYear', document.getElementById('currentMonth')?.textContent || '');

            for (const pair of formData.entries()) {
                params.append(pair[0], pair[1]);
            }

            // Manually add unchecked checkboxes and unselected radio groups to ensure their absence is recorded
            formElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked && !params.has(checkbox.name)) {
                    params.append(checkbox.name, '');
                }
            });
            const radioGroupNames = new Set();
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroupNames.add(radio.name));

            radioGroupNames.forEach(groupName => {
                const checkedRadioInGroup = formElement.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (!checkedRadioInGroup && !params.has(groupName)) {
                    params.append(groupName, '');
                }
            });

            return params.toString();
        }
    </script>
</body>
</html>
