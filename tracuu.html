<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra C·ª©u Th√¥ng Tin Xe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { background-color: #ffffff; padding: 32px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 100%; max-width: 1200px; margin: 20px; }
        .search-button { background-color: #4f46e5; color: #ffffff; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease-in-out; width: 100%; }
        .search-button:hover { background-color: #4338ca; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* === B·ªê C·ª§C K·∫æT QU·∫¢ M·ªöI === */
        .result-header { text-align: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
        .result-header h2 { font-size: 1.75rem; font-weight: 700; color: #1f2937; }
        .result-header p { font-size: 1rem; color: #6b7280; margin-top: 4px; }
        
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
        .result-group { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; }
        .result-group h3 { font-size: 1.2rem; font-weight: 600; color: #374151; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 2px solid #6366f1; }
        
        .result-item { display: grid; grid-template-columns: 140px 1fr; gap: 16px; padding: 8px 0; border-bottom: 1px dashed #e5e7eb; }
        .result-group .result-item:last-child, .long-notes-section .result-item:last-child { border-bottom: none; }
        .result-item strong { font-weight: 600; color: #1f2937; text-align: right; }
        .result-item span { color: #4b5563; white-space: pre-wrap; }

        /* === KHU V·ª∞C CHI TI·∫æT H√ÄNG NGANG M·ªöI === */
        .long-notes-section { margin-top: 24px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; }
        .long-notes-section h3 { font-size: 1.2rem; font-weight: 600; color: #374151; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 2px solid #10b981; }

        .no-results { color: #ef4444; text-align: center; font-weight: 600; margin-top: 20px; }
        
        .history-toggle { background-color: #10b981; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 24px auto 0; display: block; width: fit-content; }
        .history-toggle:hover { background-color: #059669; }
        .history-section { margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 24px; display: none; }
        .history-section h2 { text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 16px; }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Tra C·ª©u Th√¥ng Tin Xe</h1>
        <p class="text-center text-gray-500 mb-8">Nh·∫≠p Bi·ªÉn s·ªë xe ho·∫∑c S·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ t√¨m ki·∫øm.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="licensePlate" class="block text-sm font-medium text-gray-700">Bi·ªÉn s·ªë xe:</label>
                <input type="text" id="licensePlate" placeholder="V√≠ d·ª•: 93C1-123.45" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div>
                <label for="phoneNumber" class="block text-sm font-medium text-gray-700">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="phoneNumber" placeholder="V√≠ d·ª•: 090xxxxxxx" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
        </div>

        <button id="searchButton" class="search-button">üîç T√¨m Ki·∫øm</button>
        <div id="loadingSpinner" class="loading-spinner"></div>
        <div id="results" class="result-section hidden"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec';

        // ƒê·ªãnh nghƒ©a c√°c nh√≥m hi·ªÉn th·ªã theo c·ªôt
        const FIELD_GROUPS = [
            {
                title: 'Th√¥ng Tin Chung',
                fields: ['hoten', 'customerName', 'dienthoai', 'email', 'bienso', 'licensePlate', 'loaixe', 'carModel', 'hangXe', 'vehicleTypeYear', 'sokm', 'mileage', 'sokmhientai', 'chiNhanh', 'branch']
            },
            {
                title: 'Th√¥ng Tin D·ªãch V·ª•',
                fields: ['receiptNumber', 'nhanxe', 'giaoxe', 'duKienGiaoXe', 'inspectionDate', 'advisor', 'serviceAdvisor', 'ktv', 'technician', 'nguoiTiepNhan']
            },
            {
                title: 'T√¨nh Tr·∫°ng L·ªëp & Phanh',
                fields: ['tire_pressure_FL', 'tire_thickness_FL', 'tire_pressure_FR', 'tire_thickness_FR', 'tire_pressure_RL', 'tire_thickness_RL', 'tire_pressure_RR', 'tire_thickness_RR', 'tire_pressure_Spare', 'tire_thickness_Spare', 'front_brake_pad', 'rear_brake_pad', 'brakeNote', 'brake_recommendation']
            }
        ];
        
        // **M·ªöI**: T√°ch c√°c tr∆∞·ªùng c√≥ n·ªôi dung d√†i ra m·ªôt danh s√°ch ri√™ng
        const LONG_TEXT_FIELDS = new Set(['yeuCauKhachHang', 'customerRequest', 'note', 'ghiChuChung', 'tireOverallCondition', 'tireStatusNote', 'bangChiTietCongViec', 'thongTinDichVuChiTiet', 'chiTietKiemTraAnToan']);

        // Nh√£n Ti·∫øng Vi·ªát (Gi·ªØ nguy√™n)
        const FIELD_LABELS = { hoten: "T√™n KH", customerName: "T√™n KH", dienthoai: "SƒêT", bienso: "Bi·ªÉn S·ªë", licensePlate: "Bi·ªÉn S·ªë", loaixe: "Lo·∫°i Xe", carModel: "D√≤ng Xe", sokm: "S·ªë KM", sokmhientai: "S·ªë KM", mileage: "S·ªë KM", chiNhanh: "Chi Nh√°nh", branch: "Chi Nh√°nh", nhanxe: "Ng√†y Nh·∫≠n", giaoxe: "Ng√†y Giao", receiptNumber: "S·ªë Phi·∫øu", ghiChuChung: "Ghi Ch√∫ Chung", tire_pressure_FL: "√Åp su·∫•t (Tr∆∞·ªõc Tr√°i)", tire_thickness_FL: "ƒê·ªô d√†y gai (Tr∆∞·ªõc Tr√°i)", tire_pressure_FR: "√Åp su·∫•t (Tr∆∞·ªõc Ph·∫£i)", tire_thickness_FR: "ƒê·ªô d√†y gai (Tr∆∞·ªõc Ph·∫£i)", tire_pressure_RL: "√Åp su·∫•t (Sau Tr√°i)", tire_thickness_RL: "ƒê·ªô d√†y gai (Sau Tr√°i)", tire_pressure_RR: "√Åp su·∫•t (Sau Ph·∫£i)", tire_thickness_RR: "ƒê·ªô d√†y gai (Sau Ph·∫£i)", tire_pressure_Spare: "√Åp su·∫•t (S∆° cua)", tire_thickness_Spare: "ƒê·ªô d√†y gai (S∆° cua)", hangXe: "H√£ng Xe", vehicleTypeYear: "ƒê·ªùi Xe", duKienGiaoXe: "D·ª± Ki·∫øn Giao", inspectionDate: "Ng√†y KT", advisor: "C·ªë v·∫•n DV", serviceAdvisor: "C·ªë v·∫•n DV", ktv: "KTV", technician: "KTV", nguoiTiepNhan: "Ng∆∞·ªùi nh·∫≠n", front_brake_pad: "Phanh tr∆∞·ªõc", rear_brake_pad: "Phanh sau", brakeNote: "Ghi ch√∫ phanh", brake_recommendation: "KN phanh", yeuCauKhachHang: "Y√™u c·∫ßu KH", customerRequest: "Y√™u c·∫ßu KH", note: "Ghi ch√∫", tireOverallCondition: "T·ªïng quan l·ªëp", tireStatusNote: "Ghi ch√∫ l·ªëp", bangChiTietCongViec: "Chi ti·∫øt c√¥ng vi·ªác", thongTinDichVuChiTiet: "Chi ti·∫øt d·ªãch v·ª•", chiTietKiemTraAnToan: "KT an to√†n" };
        
        const searchButton = document.getElementById('searchButton');
        const licensePlateInput = document.getElementById('licensePlate');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsContainer = document.getElementById('results');

        searchButton.addEventListener('click', searchData);

        function displayResults(records) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('hidden');
            
            const latestHtml = createRecordDetailHtml(records[0], true);
            resultsContainer.insertAdjacentHTML('beforeend', latestHtml);

            if (records.length > 1) {
                const historyButton = `<button id="historyToggleBtn" class="history-toggle">Xem ${records.length - 1} l·∫ßn gh√© tr∆∞·ªõc</button>`;
                resultsContainer.insertAdjacentHTML('beforeend', historyButton);

                const historySection = `<div id="historySection" class="history-section"><h2>L·ªãch s·ª≠ c√°c l·∫ßn tr∆∞·ªõc</h2></div>`;
                resultsContainer.insertAdjacentHTML('beforeend', historySection);

                const historyContainer = document.getElementById('historySection');
                const historyHtml = records.slice(1).map(rec => createRecordDetailHtml(rec, false)).join('');
                historyContainer.innerHTML += historyHtml;

                document.getElementById('historyToggleBtn').addEventListener('click', () => {
                    historyContainer.style.display = historyContainer.style.display === 'none' ? 'block' : 'none';
                });
            }
        }

        // **M·ªöI**: C·∫≠p nh·∫≠t h√†m ƒë·ªÉ t√°ch bi·ªát l∆∞·ªõi th√¥ng tin v√† h√†ng ngang chi ti·∫øt
        function createRecordDetailHtml(record, isLatest = true) {
            let processedFields = new Set();
            let html = `<div class="result-container mb-8">`;
            
            // Header
            const headerTitle = isLatest ? 'K·∫øt qu·∫£ m·ªõi nh·∫•t' : `${record.FormType || 'N/A'}`;
            html += `<div class="result-header ${!isLatest ? 'border-t pt-8' : ''}"><h2>${headerTitle}</h2><p>${record.Timestamp || 'N/A'}</p></div>`;

            // --- Ph·∫ßn 1: L∆∞·ªõi th√¥ng tin ch√≠nh ---
            html += `<div class="result-grid">`;
            
            FIELD_GROUPS.forEach(group => {
                const groupItems = group.fields.map(fieldKey => {
                    if (record[fieldKey]) {
                        processedFields.add(fieldKey);
                        const label = FIELD_LABELS[fieldKey] || fieldKey;
                        return `<div class="result-item"><strong>${label}:</strong> <span>${record[fieldKey]}</span></div>`;
                    }
                    return '';
                }).join('');

                if (groupItems) {
                    html += `<div class="result-group"><h3>${group.title}</h3>${groupItems}</div>`;
                }
            });

            let otherItems = '';
            for (const key in record) {
                if (record[key] && !processedFields.has(key) && !LONG_TEXT_FIELDS.has(key)) {
                    processedFields.add(key);
                    const label = FIELD_LABELS[key] || key;
                    otherItems += `<div class="result-item"><strong>${label}:</strong> <span>${record[key]}</span></div>`;
                }
            }
            if (otherItems) {
                 html += `<div class="result-group"><h3>Th√¥ng Tin Kh√°c</h3>${otherItems}</div>`;
            }
            html += `</div>`; // ƒê√≥ng result-grid

            // --- Ph·∫ßn 2: H√†ng ngang cho c√°c chi ti·∫øt d√†i ---
            let longNotesHtml = '';
            LONG_TEXT_FIELDS.forEach(key => {
                if (record[key]) {
                    const label = FIELD_LABELS[key] || key;
                    longNotesHtml += `<div class="result-item"><strong>${label}:</strong> <span>${record[key]}</span></div>`;
                }
            });

            if (longNotesHtml) {
                html += `<div class="long-notes-section"><h3>Chi Ti·∫øt & Ghi Ch√∫</h3>${longNotesHtml}</div>`;
            }
            html += `</div>`; // ƒê√≥ng result-container
            return html;
        }

        function displayError(message) {
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = `<div class="no-results">${message}</div>`;
        }
        
        async function searchData() {
            const plate = licensePlateInput.value.trim();
            const phone = phoneNumberInput.value.trim();
            if (!plate && !phone) { alert('Vui l√≤ng nh·∫≠p Bi·ªÉn s·ªë xe ho·∫∑c S·ªë ƒëi·ªán tho·∫°i.'); return; }
            loadingSpinner.style.display = 'block';
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            try {
                const url = new URL(SCRIPT_URL);
                if (plate) url.searchParams.append('plate', plate);
                if (phone) url.searchParams.append('phone', phone);
                const response = await fetch(url);
                const result = await response.json();
                if (result.result === 'success' && result.data && result.data.length > 0) {
                    displayResults(result.data);
                } else if (result.result === 'error') {
                    displayError(result.message);
                } else {
                    displayError('Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√π h·ª£p.');
                }
            } catch (error) {
                console.error('L·ªói khi t√¨m ki·∫øm:', error);
                displayError('ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>
