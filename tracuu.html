<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra C·ª©u Th√¥ng Tin Xe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent content overflow */
            min-height: 100vh;
            padding: 20px;
        }
        .tire-form-button {
            background: #28a745;
            color: white;
            padding: 5px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .tire-form-button:hover { background: #218838; }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px; /* Increased max-width for better display of results */
        }
        .input-group label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            display: block;
        }
        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            color: #4b5563;
        }
        .search-button, .history-button {
            background-color: #4f46e5;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
            margin-top: 10px; /* Added margin for separation */
        }
        .search-button:hover, .history-button:hover {
            background-color: #4338ca;
        }
        .history-button {
            background-color: #10b981; /* Green for history */
        }
        .history-button:hover {
            background-color: #059669;
        }
        .result-section {
            margin-top: 32px;
            border-top: 1px solid #e5e7eb;
            padding-top: 24px;
        }
        .car-entry-block {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .car-entry-block:last-child {
            margin-bottom: 0;
        }
        .car-entry-block h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 10px;
        }
        .result-item {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item strong {
            flex: 0 0 180px; /* Fixed width for labels */
            color: #1f2937;
            font-weight: 600;
        }
        .result-item span {
            flex: 1; /* Take remaining space */
            color: #4b5563;
            /* ƒê·ªÉ hi·ªÉn th·ªã xu·ªëng d√≤ng t·ª´ \n */
            white-space: pre-wrap; /* Gi√∫p c√°c k√Ω t·ª± xu·ªëng d√≤ng (\n) ƒë∆∞·ª£c hi·ªÉn th·ªã */
        }
        .no-results {
            color: #ef4444;
            text-align: center;
            font-weight: 600;
            margin-top: 20px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .result-item strong {
                flex: 1 0 100%; /* Labels take full width on small screens */
                margin-bottom: 4px;
            }
            .result-item span {
                flex: 1 0 100%; /* Values take full width on small screens */
            }
        }
        /* Styles for parsed service items table */
        .parsed-service-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .parsed-service-table th,
        .parsed-service-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        .parsed-service-table th {
            background-color: #eef2ff; /* Light blue header */
            font-weight: 600;
            color: #374151;
        }
        .parsed-service-table tr:nth-child(even) {
            background-color: #f6f8ff; /* Lightest blue for even rows */
        }
        .parsed-service-table td.qty-col,
        .parsed-service-table td.total-col {
            text-align: right;
            white-space: nowrap; /* Keep numbers on one line */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieunhandichvu.html'">üìÑ Phi·∫øu Nh·∫≠n D·ªãch V·ª• </button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieu_kiem_tra_lop.html'">üìÑ Phi·∫øu Ki·ªÉm Tra L·ªëp</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/index.html'">üìÑ Phi·∫øu Ki·ªÉm Tra Xe </button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">üìÑ Phi·∫øu Ki·ªÉm G·∫ßm</button>
            <button class="tire-form-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/baoduong.html'">üìÑ Phi·∫øu B·∫£o D∆∞·ª°ng</button>
        </div>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Tra C·ª©u Th√¥ng Tin Xe</h1>
        <h2 style="font-size: 14px;">Tra C·ª©u Th√¥ng Tin Xe ch·ªâ nh·∫≠p bi·ªÉn s·ªë ho·∫∑c s·ªë ƒëi·ªán tho·∫°i </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="input-group">
                <label for="licensePlate" class="block text-sm">Bi·ªÉn s·ªë xe:</label>
                <input type="text" id="licensePlate" placeholder="Nh·∫≠p bi·ªÉn s·ªë xe" class="mt-1">
            </div>
            <div class="input-group">
                <label for="phoneNumber" class="block text-sm">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="phoneNumber" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" class="mt-1">
            </div>
        </div>

        <button id="searchButton" class="search-button">T√¨m Ki·∫øm</button>
        <button id="historyButton" class="history-button hidden">Xem L·ªãch S·ª≠</button>

        <div id="loadingSpinner" class="loading-spinner"></div>

        <div id="results" class="result-section hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">M√¥ t·∫£ hi·ªán tr·∫°ng xe</h2>
            <div id="carDetailsContainer">
                </div>
            <div id="noResultsMessage" class="no-results hidden">
                Kh√¥ng t√¨m th·∫•y th√¥ng tin xe ph√π h·ª£p.
            </div>
            <div id="errorMessage" class="no-results hidden text-red-600">
                ƒê√£ x·∫£y ra l·ªói khi tra c·ª©u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.
            </div>
        </div>
    </div>

    <script>
    // !!! QUAN TR·ªåNG: Thay th·∫ø URL n√†y b·∫±ng URL Web App ƒë√£ tri·ªÉn khai t·ª´ Google Apps Script c·ªßa b·∫°n !!!
    const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec';

    const ELEMENTS = {
        licensePlateInput: document.getElementById('licensePlate'),
        phoneNumberInput: document.getElementById('phoneNumber'),
        searchButton: document.getElementById('searchButton'),
        historyButton: document.getElementById('historyButton'),
        loadingSpinner: document.getElementById('loadingSpinner'),
        resultsSection: document.getElementById('results'),
        carDetailsContainer: document.getElementById('carDetailsContainer'),
        noResultsMessage: document.getElementById('noResultsMessage'),
        errorMessage: document.getElementById('errorMessage')
    };

    // C·∫•u h√¨nh c√°c nh√£n hi·ªÉn th·ªã cho t·ª´ng formType
    const FORM_LABELS = {
        'PhieuDanhGiaLop': {
            carModel: 'Lo·∫°i xe',
            tireSize: 'Size l·ªëp',
            tireStatus: 'Hi·ªán tr·∫°ng l·ªëp',
            recommendation: 'Hi·ªán Tr·∫°ng Khuy·∫øn ngh·ªã'
        },
        'PhieuKiemTraGam': {
            carModel: 'Lo·∫°i xe',
            unconfirmedItems: 'H·∫°ng m·ª•c ch∆∞a thay',
            recommendation: 'Hi·ªán Tr·∫°ng Khuy·∫øn ngh·ªã'
        },
        'PhieuNhanDichVu': {
            carModel: 'H√£ng xe',
            yeuCauKhachHang: 'Y√™u c·∫ßu kh√°ch h√†ng',
            chanDoanBanDau: 'Ch·∫©n ƒëo√°n ban ƒë·∫ßu',
            thongTinDichVu: 'Th√¥ng tin d·ªãch v·ª• chi ti·∫øt',
            tongCong: 'T·ªïng c·ªông'
        },
        'PhieuKiemTraXe': {
            carModel: 'Lo·∫°i xe',
            chiTietKiemTraAnToan: 'Chi ti·∫øt ki·ªÉm tra an to√†n',
            bangChiTietCongViec: 'B·∫£ng chi ti·∫øt c√¥ng vi·ªác',
            tongCongThanhToan: 'T·ªïng c·ªông thanh to√°n'
        },
        'PhieuDanhGiaLopMoi': {
            carModel: 'Lo·∫°i xe',
            tireStatusNote: 'Hi·ªán tr·∫°ng l·ªëp',
            brakeNote: 'Ghi ch√∫ phanh',
            rec_canchinhthuoclai: 'Khuy·∫øn c√°o C√¢n ch·ªânh th∆∞·ªõc l√°i',
            rec_canbangdong: 'Khuy·∫øn c√°o C√¢n b·∫±ng ƒë·ªông',
            rec_daolop: 'Khuy·∫øn c√°o ƒê·∫£o l·ªëp',
            rec_thaythe: 'Khuy·∫øn c√°o Thay th·∫ø'
        }
    };

    // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
    function formatCurrency(value) {
        if (typeof value === 'string') {
            value = parseFloat(value.replace(/\./g, '').replace(/,/g, '.'));
        }
        if (isNaN(value)) return '0';
        return value.toLocaleString('vi-VN');
    }

    // H√†m chung ƒë·ªÉ hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt c·ªßa m·ªôt b·∫£n ghi
    function renderRecordDetails(record, container) {
        const labels = FORM_LABELS[record.formType] || {};
        const detailsDiv = document.createElement('div');

        const commonDetails = `
            <div class="result-item"><strong>H·ªç t√™n kh√°ch:</strong><span>${record.customerName || 'N/A'}</span></div>
            <div class="result-item"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong><span>${record.phoneNumber || 'N/A'}</span></div>
            <div class="result-item"><strong>Bi·ªÉn s·ªë xe:</strong><span>${record.licensePlate || 'N/A'}</span></div>
            <div class="result-item"><strong>H√£ng/ƒê·ªùi xe:</strong><span>${record.carModel || 'N/A'}</span></div>
            <div class="result-item"><strong>S·ªë kilomet:</strong><span>${record.odometer || 'N/A'}</span></div>
            <div class="result-item"><strong>Ng√†y nh·∫≠p li·ªáu:</strong><span>${record.entryDate || 'N/A'}</span></div>
        `;
        detailsDiv.innerHTML = commonDetails;

        if (record.formType === 'PhieuNhanDichVu' && record.thongTinDichVuChiTietParsed) {
            const tableHtml = `
                <table class="parsed-service-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>H·∫°ng m·ª•c</th>
                            <th>Di·ªÖn gi·∫£i</th>
                            <th class="qty-col">SL</th>
                            <th class="total-col">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${record.thongTinDichVuChiTietParsed.map(item => `
                            <tr>
                                <td>${item.stt}</td>
                                <td>${item.hangMuc || 'N/A'}</td>
                                <td>${item.dienGiai || 'N/A'}</td>
                                <td class="qty-col">${item.soLuong || 'N/A'}</td>
                                <td class="total-col">${item.thanhTien ? formatCurrency(item.thanhTien) : '0'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            detailsDiv.innerHTML += `
                <div class="result-item"><strong>${labels.yeuCauKhachHang}:</strong><span>${record.yeuCauKhachHang || 'Kh√¥ng c√≥'}</span></div>
                <div class="result-item"><strong>${labels.chanDoanBanDau}:</strong><span>${record.chanDoanBanDau || 'Kh√¥ng c√≥'}</span></div>
                <div class="result-item"><strong>${labels.thongTinDichVu}:</strong><span>${tableHtml}</span></div>
                <div class="result-item"><strong>${labels.tongCong}:</strong><span>${record.tongCong ? formatCurrency(record.tongCong) + ' VNƒê' : '0 VNƒê'}</span></div>
            `;
        } else if (record.formType === 'PhieuKiemTraXe') {
            detailsDiv.innerHTML += `
                <div class="result-item"><strong>Chi ti·∫øt ki·ªÉm tra an to√†n:</strong><span>${record.chiTietKiemTraAnToan || 'Kh√¥ng c√≥'}</span></div>
                <div class="result-item"><strong>B·∫£ng chi ti·∫øt c√¥ng vi·ªác:</strong><span>${record.bangChiTietCongViec || 'Kh√¥ng c√≥'}</span></div>
                <div class="result-item"><strong>T·ªïng c·ªông thanh to√°n:</strong><span>${record.tongCongThanhToan ? formatCurrency(record.tongCongThanhToan) + ' VNƒê' : '0 VNƒê'}</span></div>
            `;
        } else {
            for (const key in labels) {
                if (record[key]) {
                    detailsDiv.innerHTML += `
                        <div class="result-item"><strong>${labels[key]}:</strong><span>${record[key] || 'Kh√¥ng c√≥'}</span></div>
                    `;
                }
            }
        }

        detailsDiv.innerHTML += `<div class="result-item"><strong>Ghi ch√∫ chung:</strong><span>${record.notes || 'Kh√¥ng c√≥'}</span></div>`;

        container.appendChild(detailsDiv);
    }

    // Hi·ªÉn th·ªã c√°c b·∫£n ghi t√¨m th·∫•y
    function displayCarRecords(records, isHistory = false) {
        const { carDetailsContainer, noResultsMessage, resultsSection } = ELEMENTS;
        carDetailsContainer.innerHTML = '';
        noResultsMessage.classList.add('hidden');
        resultsSection.classList.remove('hidden');

        if (records.length === 0) {
            noResultsMessage.classList.remove('hidden');
            return;
        }

        const groupedRecords = records.reduce((acc, record) => {
            const key = record.licensePlate || 'Kh√¥ng r√µ bi·ªÉn s·ªë';
            if (!acc[key]) {
                acc[key] = [];
            }
            acc[key].push(record);
            return acc;
        }, {});

        for (const key in groupedRecords) {
            const recordsForThisCar = groupedRecords[key];
            const latestRecord = recordsForThisCar[0];
            const customerInfo = `${latestRecord.customerName || 'N/A'} - ${latestRecord.phoneNumber || 'N/A'}`;

            const carBlock = document.createElement('div');
            carBlock.className = 'car-entry-block';
            carBlock.innerHTML = `<h3>Xe: ${key} (${customerInfo})</h3>`;
            carDetailsContainer.appendChild(carBlock);

            recordsForThisCar.forEach((record) => {
                const entryTitle = document.createElement('h4');
                entryTitle.className = 'text-lg font-semibold text-gray-600 mb-3 mt-4';
                entryTitle.textContent = `L·∫ßn nh·∫≠p li·ªáu: ${record.entryDate || 'N/A'} - Lo·∫°i phi·∫øu: ${record.formType || 'N/A'}`;
                carBlock.appendChild(entryTitle);
                renderRecordDetails(record, carBlock);
            });
        }
    }

    // H√†m t√¨m ki·∫øm ch√≠nh
    async function performSearch(actionType) {
        const { licensePlateInput, phoneNumberInput, resultsSection, noResultsMessage, errorMessage, loadingSpinner, historyButton } = ELEMENTS;

        ELEMENTS.carDetailsContainer.innerHTML = '';
        resultsSection.classList.add('hidden');
        noResultsMessage.classList.add('hidden');
        errorMessage.classList.add('hidden');
        historyButton.classList.add('hidden');

        const licensePlate = licensePlateInput.value.trim().toUpperCase();
        const phoneNumber = phoneNumberInput.value.trim();

        if (!licensePlate && !phoneNumber) {
            errorMessage.textContent = 'Vui l√≤ng nh·∫≠p Bi·ªÉn s·ªë xe ho·∫∑c S·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ t√¨m ki·∫øm.';
            errorMessage.classList.remove('hidden');
            resultsSection.classList.remove('hidden');
            return;
        }

        loadingSpinner.style.display = 'block';

        try {
            const url = new URL(GOOGLE_APPS_SCRIPT_WEB_APP_URL);
            if (licensePlate) url.searchParams.append('licensePlate', licensePlate);
            if (phoneNumber) url.searchParams.append('phoneNumber', phoneNumber);
            url.searchParams.append('action', actionType);

            const response = await fetch(url);
            const result = await response.json();

            loadingSpinner.style.display = 'none';

            if (result.result === 'success' && result.data && result.data.length > 0) {
                displayCarRecords(result.data, actionType === 'history');
                if (actionType === 'latest') {
                    historyButton.classList.remove('hidden');
                }
            } else if (result.result === 'not_found' || (result.result === 'success' && result.data && result.data.length === 0)) {
                noResultsMessage.classList.remove('hidden');
                resultsSection.classList.remove('hidden');
            } else {
                errorMessage.textContent = result.message || 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh khi tra c·ª©u d·ªØ li·ªáu.';
                errorMessage.classList.remove('hidden');
                resultsSection.classList.remove('hidden');
            }
        } catch (error) {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            loadingSpinner.style.display = 'none';
            errorMessage.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.';
            errorMessage.classList.remove('hidden');
            resultsSection.classList.remove('hidden');
        }
    }

    ELEMENTS.searchButton.addEventListener('click', () => performSearch('latest'));
    ELEMENTS.historyButton.addEventListener('click', () => performSearch('history'));
</script>
</body>
</html>
