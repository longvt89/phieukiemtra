<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Nh·∫≠n D·ªãch V·ª• - PHI LONG AUTO</title>
    
    <style>
        /* Reset CSS cho t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ƒê·ªãnh nghƒ©a font ch·ªØ, k√≠ch th∆∞·ªõc ch·ªØ, m√†u s·∫Øc v√† n·ªÅn cho to√†n b·ªô trang */
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: #f5f5f5;
            padding: 20px;
        }

        /* Container ch√≠nh c·ªßa phi·∫øu, gi·ªõi h·∫°n chi·ªÅu r·ªông v√† t·∫°o b√≥ng ƒë·ªï */
        .container {
            max-width: 230mm; /* K√≠ch th∆∞·ªõc A4 theo chi·ªÅu ngang ƒë·ªÉ ch·ª©a ƒë·ªß c√°c n√∫t */
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* V√πng n·ªôi dung ch√≠nh c·ªßa form, thi·∫øt l·∫≠p kho·∫£ng c√°ch l·ªÅ */
        .form-content {
            padding: 15mm; /* Kho·∫£ng c√°ch l·ªÅ trong phi·∫øu */
        }

        /* Ph·∫ßn Header c·ªßa phi·∫øu: Logo, ti√™u ƒë·ªÅ, s·ªë phi·∫øu */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        /* Ti√™u ƒë·ªÅ ch√≠nh c·ªßa phi·∫øu */
        .header-left h1 {
            font-size: 24px;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 5px;
        }

        /* ƒê·ªãnh d·∫°ng s·ªë phi·∫øu */
        .form-number {
            font-size: 16px;
            font-weight: bold;
        }

        /* Ph·∫ßn b√™n ph·∫£i header ch·ª©a logo */
        .header-right {
            text-align: right;
        }

        /* ƒê·ªãnh d·∫°ng logo */
        .logo {
            width: 80px;
            height: 60px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
        }

        /* Ph·∫ßn th√¥ng tin kh√°ch h√†ng v√† xe: Chia l√†m 2 c·ªôt */
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        /* Nh√≥m c√°c input field (label v√† input) */
        .info-group {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ƒê·ªãnh d·∫°ng nh√£n (label) c·ªßa input */
        .info-group label {
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }

        /* ƒê·ªãnh d·∫°ng chung cho c√°c input text */
        .info-group .info-input {
            border: none;
            border-bottom: 1px dotted #000; /* ƒê∆∞·ªùng g·∫°ch d∆∞·ªõi d·∫°ng ch·∫•m */
            flex-grow: 1; /* Cho ph√©p input m·ªü r·ªông ƒë·ªÉ l·∫•p ƒë·∫ßy kh√¥ng gian */
            padding: 0 5px;
            font-size: 12px;
            min-width: 50px;
        }
        /* ƒê·ªãnh nghƒ©a chi·ªÅu r·ªông t·ªëi thi·ªÉu cho c√°c lo·∫°i input kh√°c nhau */
        .info-group .info-input.name-input { min-width: 150px; }
        .info-group .info-input.phone-email-input { min-width: 90px; }
        .info-group .info-input.datetime-input { min-width: 130px; }
        .info-group .info-input.car-type-input { min-width: 150px; }
        .info-group .info-input.license-km-input { min-width: 90px; }

        /* Ph·∫ßn y√™u c·∫ßu kh√°ch h√†ng v√† ch·∫©n ƒëo√°n ban ƒë·∫ßu */
        .request-details {
            margin-bottom: 13px;
            border: 1px solid #000;
            padding: 9px;
        }

        /* Ti√™u ƒë·ªÅ cho c√°c ph·∫ßn con (v√≠ d·ª•: Y√™u c·∫ßu kh√°ch h√†ng) */
        .section-title {
            background: #003366;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            margin: -10px -10px 10px -10px; /* T·∫°o hi·ªáu ·ª©ng tr√†n ra ngo√†i l·ªÅ c·ªßa request-details */
        }

        /* Nh√≥m c√°c textarea (label v√† textarea) */
        .request-group {
            margin-bottom: 10px;
        }

        /* ƒê·ªãnh d·∫°ng nh√£n (label) c·ªßa textarea */
        .request-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* ƒê·ªãnh d·∫°ng textarea */
        .request-group textarea {
            width: 100%;
            border: 1px dotted #000;
            padding: 5px;
            resize: vertical; /* Cho ph√©p thay ƒë·ªïi k√≠ch th∆∞·ªõc theo chi·ªÅu d·ªçc */
            min-height: 50px;
            font-size: 12px;
        }

        /* B·∫£ng chi ti·∫øt d·ªãch v·ª•/v·∫≠t t∆∞ */
        .detailed-service {
            margin-top: 15px;
            width: 100%;
            border-collapse: collapse; /* C√°c ƒë∆∞·ªùng vi·ªÅn li·ªÅn nhau */
            border: 2px solid #000;
        }

        /* ƒê·ªãnh d·∫°ng chung cho ti√™u ƒë·ªÅ b·∫£ng v√† √¥ d·ªØ li·ªáu */
        .detailed-service th,
        .detailed-service td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 11px;
        }

        /* ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ b·∫£ng ch√≠nh */
        .detailed-service th {
            background: #003366;
            color: white;
            font-weight: bold;
        }

        /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho c√°c c·ªôt */
        .detailed-service .stt { width: 30px; }
        .detailed-service .hang-muc { width: 120px; text-align: left; font-weight: bold;}
        .detailed-service .dien-giai { width: 180px; }
        .detailed-service .sl { width: 50px; }
        .detailed-service .don-gia, .detailed-service .thanh-tien { width: 90px; }
        .detailed-service .xac-nhan-col { width: 60px; }
        .detailed-service .cap-do-col { width: 60px; } /* Th√™m c·ªôt c·∫•p ƒë·ªô */


        /* ƒê·ªãnh d·∫°ng input text v√† number trong b·∫£ng */
        .detailed-service input[type="text"],
        .detailed-service input[type="number"] {
            width: 100%;
            border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }
        /* CƒÉn tr√°i v√† in ƒë·∫≠m cho c·ªôt h·∫°ng m·ª•c trong b·∫£ng */
        .detailed-service input[type="text"].hang-muc-input {
            text-align: left;
            font-weight: bold;
        }
        /* ƒê·ªãnh d·∫°ng checkbox trong b·∫£ng */
        .detailed-service input[type="checkbox"] {
            width: 15px;
            height: 15px;
            margin: 0 auto;
            display: block;
            vertical-align: middle;
        }

        /* ƒê·ªãnh d·∫°ng h√†ng t·ªïng c·ªông */
        .total-row {
            background: #ccc;
            font-weight: bold;
        }

        /* Ti√™u ƒë·ªÅ danh m·ª•c trong b·∫£ng (v√≠ d·ª•: Level 1, Level 2) */
        .category-header th {
            background: #e0e0e0; /* M√†u n·ªÅn x√°m nh·∫°t */
            color: #000;
            font-weight: bold;
            text-align: left;
            padding: 5px 10px;
            border: 1px solid #000;
            font-size: 12px;
        }

        /* Ph·∫ßn ch·ªØ k√Ω */
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 20px;
            padding-top: 15px;
        }

        /* Khung ch·ª©a m·ªói ch·ªØ k√Ω (ƒê·∫°i l√Ω, Kh√°ch h√†ng) */
        .signature-box { text-align: center; }

        /* Ti√™u ƒë·ªÅ "ƒê·∫°i l√Ω" / "Kh√°ch h√†ng" */
        .signature-title {
            font-weight: bold;
            margin-bottom: 30px;
        }

        /* Input ƒë·ªÉ nh·∫≠p t√™n ng∆∞·ªùi k√Ω */
        .signature-input {
            border: none;
            border-bottom: 1px dotted #000;
            width: 100%;
            text-align: center;
            padding: 2px 0;
            font-size: 12px;
            margin-top: -20px; /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ input l√™n cao h∆°n ƒë·ªÉ ch·ªØ k√Ω n·∫±m g·∫ßn d√≤ng */
        }

        /* Ch√∫ th√≠ch "(K√Ω t√™n)" */
        .signature-subtitle {
            font-size: 10px;
            font-style: italic;
        }

        /* Ph·∫ßn ch√¢n trang */
        .footer {
            margin-top: 15px;
            font-size: 9px;
            line-height: 1.2;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        /* Nh√≥m c√°c n√∫t ch·ª©c nƒÉng ·ªü ƒë·∫ßu trang */
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Cho ph√©p c√°c n√∫t xu·ªëng d√≤ng tr√™n m√†n h√¨nh nh·ªè */
            gap: 10px;
            margin-bottom: 20px;
        }

        /* ƒê·ªãnh d·∫°ng chung cho t·∫•t c·∫£ c√°c n√∫t */
        .app-button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap; /* NgƒÉn vƒÉn b·∫£n trong n√∫t b·ªã xu·ªëng d√≤ng */
            flex-shrink: 0; /* NgƒÉn n√∫t b·ªã co l·∫°i */
            background: #28a745; /* M√†u xanh l√° c√¢y */
            color: white;
        }

        /* Hi·ªáu ·ª©ng hover cho n√∫t */
        .app-button:hover { background: #218838; }

        /* M√†u s·∫Øc ri√™ng cho n√∫t In */
        .print-button {
            background: #007bff; /* M√†u xanh d∆∞∆°ng */
        }
        .print-button:hover { background: #0056b3; }

        /* M√†u s·∫Øc ri√™ng cho n√∫t X√≥a Form */
        .clear-button {
            background: #dc3545; /* M√†u ƒë·ªè */
        }
        .clear-button:hover { background: #c82333; }

        /* Style for recommended option in dropdown */
        .recommended-option {
            background-color: #e6f7ff; /* Light blue background */
            font-weight: bold;
            color: #0056b3; /* Darker blue text */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button class="app-button print-button" id="printButton">üñ®Ô∏è In Phi·∫øu</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/tracuu.html'">üìÑ Tra c·ª©u th√¥ng tin xe </button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra'">üìÑ Phi·∫øu Ki·ªÉm Tra Xe </button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieu_kiem_tra_lop.html'">üìÑ Phi·∫øu Ki·ªÉm Tra L·ªëp</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">üìÑ Phi·∫øu Ki·ªÉm G·∫ßm</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/baoduong.html'">üìÑ Phi·∫øu B·∫£o D∆∞·ª°ng</button>
            <button class="app-button" id="submitToSheet">üì§ G·ª≠i Th√¥ng Tin</button>
            <button class="app-button clear-button" id="clearFormButton">üóëÔ∏è X√≥a Form</button>
        </div>
        
        <div class="form-content">
            <form id="serviceReceiptForm" action="https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec" method="POST">
                <input type="hidden" name="formType" value="PhieuNhanDichVu">

                <div class="header">
                    <div class="header-left">
                        <h1>PHI·∫æU NH·∫¨N D·ªäCH V·ª§</h1>
                        <div class="form-number">‚Ññ <span id="receiptNumber"></span> / <span id="currentMonth"></span></div>
                    </div>
                    <div class="header-right">
                        <div class="logo">
                            <img src="https://longvt89.github.io/phieukiemtra/logophilong.jpg" alt="Logo Phi Long Auto" style="height: 90px;">
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-left">
                        <div class="info-group">
                            <label for="customerName">H·ªç t√™n kh√°ch h√†ng:</label>
                            <input type="text" id="customerName" name="hoten" class="info-input name-input" required>
                        </div>
                        <div class="info-group">
                            <label for="customerPhone">S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="tel" id="customerPhone" name="dienthoai" class="info-input phone-email-input" required>
                        </div>
                        <div class="info-group">
                            <label for="carModel">H√£ng/ƒê·ªùi xe:</label>
                            <input type="text" id="carModel" name="hangXe" class="info-input car-type-input" required>
                        </div>
                        <div class="info-group">
                            <label for="licensePlate">Bi·ªÉn s·ªë xe:</label>
                            <input type="text" id="licensePlate" name="bienso" class="info-input license-km-input" required>
                        </div>
                    </div>
                    <div class="info-right">
                        <div class="info-group">
                            <label for="receptionist">Ng∆∞·ªùi ti·∫øp nh·∫≠n:</label>
                            <input type="text" list="receptionistList" id="receptionist" name="nguoiTiepNhan" class="info-input name-input">
                            <datalist id="receptionistList">
                                <option value="Cao Thanh Duy">
                                <option value="Tr·∫ßn Ng·ªçc H√†o">
                                <option value="Nguy·ªÖn Ph∆∞·ªõc Hi·∫øu">
                                <option value="Nguy·ªÖn Trung Ki√™n">
                            </datalist>
                        </div>
                        <div class="info-group">
                            <label for="receivedDateTime">Ng√†y gi·ªù nh·∫≠n xe:</label>
                            <input type="datetime-local" id="receivedDateTime" name="nhanxe" class="info-input datetime-input" required>
                        </div>
                        <div class="info-group">
                            <label for="expectedDeliveryTime">Ng√†y gi·ªù d·ª± ki·∫øn giao:</label>
                            <input type="datetime-local" id="expectedDeliveryTime" name="duKienGiaoXe" class="info-input datetime-input">
                        </div>
                        <!-- Th√™m tr∆∞·ªùng s·ªë KM c≈© -->
                        <div class="info-group">
                            <label for="oldOdometer">S·ªë KM c≈©:</label>
                            <input type="text" id="oldOdometer" name="sokmcu" class="info-input license-km-input">
                        </div>
                        <div class="info-group">
                            <label for="currentOdometer">S·ªë KM hi·ªán t·∫°i:</label>
                            <input type="text" id="currentOdometer" name="sokmhientai" class="info-input license-km-input">
                        </div>
                        <!-- Th√™m tr∆∞·ªùng ch·ªçn c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng -->
                        <div class="info-group">
                            <label for="maintenanceLevel">C·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng:</label>
                            <select id="maintenanceLevel" name="capDoBaoDuong" class="info-input">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="request-details">
                    <div class="section-title">Y√äU C·∫¶U C·ª¶A KH√ÅCH H√ÄNG & CH·∫®N ƒêO√ÅN BAN ƒê·∫¶U</div>
                    <div class="request-group">
                        <label for="customerRequest">Y√™u c·∫ßu c·ªßa kh√°ch h√†ng:</label>
                        <textarea id="customerRequest" name="yeuCauKhachHang" placeholder="M√¥ t·∫£ c√°c v·∫•n ƒë·ªÅ ho·∫∑c d·ªãch v·ª• kh√°ch h√†ng y√™u"></textarea>
                    </div>
                    <div class="request-group">
                        <label for="initialDiagnosis">Ch·∫©n ƒëo√°n ban ƒë·∫ßu:</label>
                        <textarea id="initialDiagnosis" name="chanDoanBanDau" placeholder="M√¥ t·∫£ ch·∫©n ƒëo√°n ban ƒë·∫ßu c·ªßa k·ªπ thu·∫≠t vi√™n"></textarea>
                    </div>
                </div>

                <table class="detailed-service">
                    <thead>
                        <tr>
                            <th class="stt">STT</th>
                            <th class="hang-muc">H·∫†NG M·ª§C D·ªäCH V·ª§/V·∫¨T T∆Ø</th>
                            <th class="dien-giai">DI·ªÑN GI·∫¢I</th>
                            <th class="sl">SL</th>
                            <th class="don-gia">ƒê∆†N GI√Å</th>
                            <th class="thanh-tien">TH√ÄNH TI·ªÄN</th>
                            <th class="xac-nhan-col">X√ÅC NH·∫¨N</th>
                            <th class="cap-do-col">C·∫§P ƒê·ªò</th> <!-- Th√™m c·ªôt C·∫§P ƒê·ªò -->
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        <!-- C√°c h√†ng s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JavaScript -->
                    </tbody>
                </table>

                <div class="request-details" style="margin-top: 15px;">
                    <div class="section-title">GHI CH√ö</div>
                    <div class="request-group">
                        <label for="generalNotes">Ghi ch√∫ chung:</label>
                        <textarea id="generalNotes" name="ghiChuChung" placeholder="C√°c ghi ch√∫ ho·∫∑c y√™u c·∫ßu ƒë·∫∑c bi·ªát kh√°c"></textarea>
                    </div>
                </div>

                <div class="footer">
                    <p><strong>Khuy·∫øn ngh·ªã:</strong></p>
                    <p>‚ñ° "T√¥i ƒë·ªìng √Ω ƒëƒÉng k√Ω s·ªë li·ªáu c√° nh√¢n ƒë∆∞·ª£c cung c·∫•p theo m·∫´u n√†y c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u tr·ªØ v√† s·ª≠ d·ª•ng cho m·ª•c ƒë√≠ch li√™n quan ƒë·∫øn PHI LONG AUTO (C√¥ng Ty), nh·∫±m m·ª•c ƒë√≠ch truy·ªÅn th√¥ng s·∫£n ph·∫©m v√† d·ªãch v·ª• c·ªßa ch√∫ng t√¥i v√† c√°c ƒë·ªëi t√°c kinh doanh li√™n quan. T√¥i c√≥ th·ªÉ r√∫t l·∫°i s·ª± ƒë·ªìng √Ω c·ªßa m√¨nh b·∫•t c·ª© l√∫c n√†o b·∫±ng c√°ch li√™n h·ªá v·ªõi C√¥ng Ty v√† y√™u c·∫ßu lo·∫°i b·ªè th√¥ng tin c√° nh√¢n c·ªßa t√¥i kh·ªèi c∆° s·ªü d·ªØ li·ªáu n√†y."</p>
                </div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">ƒê·∫°i l√Ω</div>
                        <input type="text" list="receptionistList" class="signature-input" name="daiLyPhuTrach" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n">
                        <div class="signature-subtitle">(K√Ω t√™n)</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Kh√°ch h√†ng</div>
                        <input type="text" class="signature-input" name="khachHangKyTen" placeholder="K√Ω t√™n">
                        <div class="signature-subtitle">(K√Ω t√™n)</div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // C√°c h·∫±ng s·ªë key cho Local Storage ƒë·ªÉ l∆∞u tr·∫°ng th√°i form v√† s·ªë phi·∫øu
        const RECEIPT_NUMBER_KEY = 'serviceReceipt_receiptNumber';
        const LAST_MONTH_KEY = 'serviceReceipt_lastMonth';
        const FORM_DATA_KEY = 'serviceReceipt_formData';

        // C·∫•u tr√∫c d·ªØ li·ªáu quy ƒë·ªãnh b·∫£o d∆∞·ª°ng d·ª±a tr√™n h√¨nh ·∫£nh b·∫°n ƒë√£ cung c·∫•p
        const maintenanceMilestones = [
            { km: 1000, level: 'Ki·ªÉm tra ƒë·∫ßu ti√™n (1 th√°ng)', items: [
                'Ki·ªÉm tra t·ªïng th·ªÉ xe', 'Ki·ªÉm tra m·ª©c d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra m·ª©c n∆∞·ªõc l√†m m√°t',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n, c√≤i, g·∫°t m∆∞a'
            ]},
            { km: 5000, level: 'C·∫•p 1', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 10000, level: 'C·∫•p 2', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh ho·∫∑c thay l·ªçc gi√≥ ƒë·ªông c∆°',
                'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy', 'Ki·ªÉm tra h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'Ki·ªÉm tra l·ªçc gi√≥ ƒëi·ªÅu h√≤a',
                'Ki·ªÉm tra h·ªá th·ªëng treo v√† l√°i', 'Ki·ªÉm tra d·∫ßu h·ªôp s·ªë (n·∫øu c√≥)',
            ]},
            { km: 15000, level: 'C·∫•p 1', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 20000, level: 'C·∫•p 3', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'Thay l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
                'Ki·ªÉm tra h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'Thay l·ªçc gi√≥ ƒëi·ªÅu h√≤a', 'Ki·ªÉm tra h·ªá th·ªëng treo v√† l√°i',
                'Ki·ªÉm tra d·∫ßu h·ªôp s·ªë', 'Ki·ªÉm tra bugi (n·∫øu ƒë·∫øn h·∫°n thay)', 'Ki·ªÉm tra d√¢y ƒëai truy·ªÅn ƒë·ªông',
            ]},
            { km: 25000, level: 'C·∫•p 1', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 30000, level: 'C·∫•p 2', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh ho·∫∑c thay l·ªçc gi√≥ ƒë·ªông c∆°',
                'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy', 'Ki·ªÉm tra h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'Ki·ªÉm tra l·ªçc gi√≥ ƒëi·ªÅu h√≤a',
                'Ki·ªÉm tra h·ªá th·ªëng treo v√† l√°i', 'Ki·ªÉm tra d·∫ßu h·ªôp s·ªë (n·∫øu c√≥)',
            ]},
            { km: 35000, level: 'C·∫•p 1', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 40000, level: 'C·∫•p 4', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'Thay l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
                'Ki·ªÉm tra v√† thay th·∫ø m√° phanh, ƒëƒ©a phanh n·∫øu c·∫ßn', 'Thay l·ªçc gi√≥ ƒëi·ªÅu h√≤a', 'Ki·ªÉm tra h·ªá th·ªëng treo v√† l√°i',
                'Thay d·∫ßu h·ªôp s·ªë', 'Thay bugi', 'Ki·ªÉm tra v√† thay d√¢y ƒëai truy·ªÅn ƒë·ªông', 'Ki·ªÉm tra h·ªá th·ªëng nhi√™n li·ªáu',
                'Ki·ªÉm tra h·ªá th·ªëng x·∫£', 'V·ªá sinh kim phun', 'Ki·ªÉm tra v√† thay n∆∞·ªõc l√†m m√°t',
            ]},
            { km: 45000, level: 'C·∫•p 1', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 50000, level: 'C·∫•p 2', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh ho·∫∑c thay l·ªçc gi√≥ ƒë·ªông c∆°',
                'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy', 'Ki·ªÉm tra h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'Ki·ªÉm tra l·ªçc gi√≥ ƒëi·ªÅu h√≤a',
                'Ki·ªÉm tra h·ªá th·ªëng treo v√† l√°i', 'Ki·ªÉm tra d·∫ßu h·ªôp s·ªë (n·∫øu c√≥)',
            ]},
            { km: 55000, level: 'C·∫•p 1', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 60000, level: 'C·∫•p 4+', items: [
                'Ki·ªÉm tra v√† thay d·∫ßu ƒë·ªông c∆°', 'Ki·ªÉm tra v√† thay l·ªçc d·∫ßu', 'Ki·ªÉm tra m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'Ki·ªÉm tra √°p su·∫•t l·ªëp', 'Ki·ªÉm tra ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'Thay l·ªçc gi√≥ ƒë·ªông c∆°', 'Ki·ªÉm tra t√¨nh tr·∫°ng ·∫Øc quy',
                'Ki·ªÉm tra v√† thay th·∫ø m√° phanh, ƒëƒ©a phanh n·∫øu c·∫ßn', 'Thay l·ªçc gi√≥ ƒëi·ªÅu h√≤a', 'Ki·ªÉm tra h·ªá th·ªëng treo v√† l√°i',
                'Thay d·∫ßu h·ªôp s·ªë', 'Thay bugi', 'Ki·ªÉm tra v√† thay d√¢y ƒëai truy·ªÅn ƒë·ªông', 'Ki·ªÉm tra h·ªá th·ªëng nhi√™n li·ªáu',
                'Ki·ªÉm tra h·ªá th·ªëng x·∫£', 'V·ªá sinh kim phun', 'Ki·ªÉm tra v√† thay n∆∞·ªõc l√†m m√°t',
                'Ki·ªÉm tra v√† thay d·∫ßu phanh', 'Ki·ªÉm tra v√† thay d·∫ßu tr·ª£ l·ª±c l√°i',
            ]}
        ];

        // ƒê·ªãnh nghƒ©a c√°c h·∫°ng m·ª•c d·ªãch v·ª• c√≥ s·∫µn v√† c·∫•p ƒë·ªô m·∫∑c ƒë·ªãnh c·ªßa ch√∫ng
        const predefinedServiceItems = [
            // Level 1 - D·ªãch v·ª• c∆° b·∫£n
            { stt: '01', hangMuc: 'L·ªëp Xe', level: 'C·∫•p 1' },
            { stt: '02', hangMuc: 'ƒê·∫£o l·ªëp', level: 'C·∫•p 1' },
            { stt: '03', hangMuc: 'C√¢n b·∫±ng ƒë·ªông', level: 'C·∫•p 1' },
            { stt: '04', hangMuc: 'Phanh', level: 'C·∫•p 1' },
            { stt: '05', hangMuc: 'D·∫ßu ƒë·ªông c∆°', level: 'C·∫•p 1' },
            { stt: '06', hangMuc: 'L·ªçc d·∫ßu ƒë·ªông c∆°', level: 'C·∫•p 1' },
            { stt: '07', hangMuc: 'L·ªçc gi√≥ ƒë·ªông c∆°', level: 'C·∫•p 1' },
            { stt: '08', hangMuc: 'L·ªçc gi√≥ m√°y l·∫°nh', level: 'C·∫•p 1' },
            { stt: '09', hangMuc: 'D·∫ßu phanh', level: 'C·∫•p 1' },
            { stt: '10', hangMuc: 'N∆∞·ªõc r·ª≠a k√≠nh', level: 'C·∫•p 1' },
            { stt: '11', hangMuc: 'G·∫°t m∆∞a', level: 'C·∫•p 1' },
            { stt: '12', hangMuc: '·∫Æc quy', level: 'C·∫•p 1' },
            { stt: '13', hangMuc: 'G√≥c ƒë·∫∑t b√°nh xe / C√¢n ch·ªânh l√°i', level: 'C·∫•p 1' },
            // Level 2 - D·ªãch v·ª• m·ªü r·ªông
            { stt: '14', hangMuc: 'Rotuyn (l√°i, tr·ª•)', level: 'C·∫•p 2' },
            { stt: '15', hangMuc: 'Phu·ªôc', level: 'C·∫•p 2' },
            { stt: '16', hangMuc: 'B·∫°c ƒë·∫°n b√°nh xe', level: 'C·∫•p 2' },
            { stt: '17', hangMuc: 'D·∫ßu h·ªôp s·ªë t·ª± ƒë·ªông', level: 'C·∫•p 2' },
            { stt: '18', hangMuc: 'D·∫ßu vi sai / c·∫ßu', level: 'C·∫•p 2' },
            { stt: '19', hangMuc: 'V-belt / D√¢y curoa ngo√†i', level: 'C·∫•p 2' },
            { stt: '20', hangMuc: 'Bugi R: m·ªói 40.000 km v·ªõi lo·∫°i th∆∞·ªùng v√† 100.000 km v·ªõi lo·∫°i ƒëi·ªán c·ª±c h·ª£p kim', level: 'C·∫•p 2' },
            { stt: '21', hangMuc: 'D·∫ßu tr·ª£ l·ª±c l√°i', level: 'C·∫•p 2' },
            { stt: '22', hangMuc: 'L·ªçc nhi√™n li·ªáu (diesel)', level: 'C·∫•p 2' },
            { stt: '23', hangMuc: 'L·ªçc nhi√™n li·ªáu ƒë·ªông c∆° xƒÉng', level: 'C·∫•p 2' },
            { stt: '24', hangMuc: 'B√≥ng ƒë√®n', level: 'C·∫•p 2' },
            // Level 2 D·ªãch v·ª• gia tƒÉng gi√° tr·ªã - tƒÉng Tr·∫£i nghi·ªám. Kh√°ch h√†ng
            { stt: '25', hangMuc: 'V·ªá sinh gi√†n l·∫°nh', level: 'C·∫•p 2+' },
            { stt: '26', hangMuc: 'V·ªá sinh h·ªá th·ªëng nhi√™n li·ªáu', level: 'C·∫•p 2+' },
            { stt: '27', hangMuc: 'V·ªá sinh kim phun tr·ª±c ti·∫øp', level: 'C·∫•p 2+' },
            { stt: '28', hangMuc: 'S√∫c r·ª≠a ƒë·ªông c∆° A', level: 'C·∫•p 2+' },
            { stt: '29', hangMuc: 'Ph·ª• gia n√¢ng c·∫•p nh·ªõt', level: 'C·∫•p 2+' },
            { stt: '30', hangMuc: 'V·ªá sinh h·ªçng ga', level: 'C·∫•p 2+' },
        ];


        // H√†m t√≠nh t·ªïng ti·ªÅn cho m·ªôt h√†ng v√† c·∫≠p nh·∫≠t t·ªïng c·ªông
        function calculateRowTotal(inputElement) {
            const row = inputElement.closest('tr'); // T√¨m h√†ng ch·ª©a input
            const quantity = parseFloat(row.querySelector('.sl-input').value) || 0; // L·∫•y s·ªë l∆∞·ª£ng
            const unitPrice = parseFloat(row.querySelector('.don-gia-input').value) || 0; // L·∫•y ƒë∆°n gi√°
            const total = quantity * unitPrice; // T√≠nh th√†nh ti·ªÅn
            row.querySelector('.thanh-tien-input').value = total.toLocaleString('vi-VN'); // Hi·ªÉn th·ªã th√†nh ti·ªÅn v·ªõi ƒë·ªãnh d·∫°ng VN
            updateGrandTotal(); // C·∫≠p nh·∫≠t t·ªïng c·ªông
            saveFormData(); // L∆∞u d·ªØ li·ªáu form v√†o Local Storage
        }

        // H√†m c·∫≠p nh·∫≠t t·ªïng c·ªông c·ªßa to√†n b·ªô b·∫£ng
        function updateGrandTotal() {
            let grandTotal = 0;
            // Duy·ªát qua t·∫•t c·∫£ c√°c input th√†nh ti·ªÅn
            document.querySelectorAll('.thanh-tien-input').forEach(input => {
                // Parse gi√° tr·ªã ƒë√£ ƒë·ªãnh d·∫°ng (v√≠ d·ª•: "1.000.000" th√†nh 1000000)
                const value = parseFloat(input.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
                grandTotal += value;
            });
            // Hi·ªÉn th·ªã t·ªïng c·ªông cu·ªëi c√πng v·ªõi ƒë·ªãnh d·∫°ng VN
            document.getElementById('grand-total').value = grandTotal.toLocaleString('vi-VN');
        }

        // H√†m l·∫•y ng√†y gi·ªù hi·ªán t·∫°i theo ƒë·ªãnh d·∫°ng local cho input datetime-local
        function getCurrentDateTimeLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // ƒêi·ªÅu ch·ªânh m√∫i gi·ªù
            return now.toISOString().slice(0, 16); // Tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng "YYYY-MM-DDTHH:MM"
        }

        // H√†m reset to√†n b·ªô form v√† x√≥a d·ªØ li·ªáu ƒë√£ l∆∞u trong Local Storage
        function resetFormAndLocalStorage() {
            const formElement = document.getElementById('serviceReceiptForm');
            const receivedDateTimeInput = document.getElementById('receivedDateTime');
            const expectedDeliveryTimeInput = document.getElementById('expectedDeliveryTime');
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            const oldOdometerInput = document.getElementById('oldOdometer');
            const currentOdometerInput = document.getElementById('currentOdometer');


            localStorage.removeItem(FORM_DATA_KEY); // X√≥a d·ªØ li·ªáu form ƒë√£ l∆∞u
            formElement.reset(); // Reset t·∫•t c·∫£ c√°c tr∆∞·ªùng trong form
            initializeReceiptNumber(); // Kh·ªüi t·∫°o l·∫°i s·ªë phi·∫øu
            receivedDateTimeInput.value = getCurrentDateTimeLocal(); // ƒê·∫∑t l·∫°i ng√†y gi·ªù nh·∫≠n xe hi·ªán t·∫°i
            expectedDeliveryTimeInput.value = ''; // X√≥a ng√†y gi·ªù d·ª± ki·∫øn giao
            oldOdometerInput.value = ''; // Reset s·ªë KM c≈©
            currentOdometerInput.value = ''; // Reset s·ªë KM hi·ªán t·∫°i

            populateMaintenanceLevels(); // Populate l·∫°i dropdown c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng (kh√¥ng c√≥ khuy·∫øn kh√≠ch ban ƒë·∫ßu)
            maintenanceLevelSelect.value = ''; // Reset c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng
            populateServiceTable(); // T·∫£i l·∫°i b·∫£ng d·ªãch v·ª• (ch·ªâ hi·ªÉn th·ªã c√°c h·∫°ng m·ª•c m·∫∑c ƒë·ªãnh)
            updateGrandTotal(); // C·∫≠p nh·∫≠t t·ªïng c·ªông v·ªÅ 0
            hasSubmitted = false; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i g·ª≠i form
            alert('Form ƒë√£ ƒë∆∞·ª£c x√≥a v√† reset th√†nh c√¥ng!');
        }

        // H√†m kh·ªüi t·∫°o s·ªë phi·∫øu v√† c·∫≠p nh·∫≠t th√°ng/nƒÉm
        function initializeReceiptNumber() {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;

                    // N·∫øu th√°ng ho·∫∑c nƒÉm thay ƒë·ªïi, reset s·ªë phi·∫øu v·ªÅ 1
                    if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                        receiptNumber = 1;
                        localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                        localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                    }
                } catch (e) {
                    console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu th√°ng t·ª´ localStorage:", e);
                    // Tr∆∞·ªùng h·ª£p l·ªói parse, c≈©ng reset v·ªÅ 1
                    receiptNumber = 1;
                    localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                    localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                }
            } else {
                // L·∫ßn ƒë·∫ßu ti√™n ch·∫°y ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu c≈©, ƒë·∫∑t s·ªë phi·∫øu l√† 1
                receiptNumber = 1;
                localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
            }

            // Hi·ªÉn th·ªã s·ªë phi·∫øu v√† th√°ng/nƒÉm v·ªõi ƒë·ªãnh d·∫°ng 6 ch·ªØ s·ªë (000001) v√† MM/YYYY
            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // H√†m tƒÉng s·ªë phi·∫øu khi in (gi·∫£ ƒë·ªãnh m·ªói l·∫ßn in l√† m·ªôt phi·∫øu m·ªõi)
        function incrementReceiptNumberOnPrint() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;
                } catch (e) {
                    console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu th√°ng t·ª´ localStorage:", e);
                }
            }

            // N·∫øu th√°ng ho·∫∑c nƒÉm thay ƒë·ªïi, reset s·ªë phi·∫øu v·ªÅ 1 tr∆∞·ªõc khi tƒÉng
            if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                receiptNumber = 1;
            } else {
                receiptNumber++;
            }

            // L∆∞u l·∫°i s·ªë phi·∫øu v√† th√¥ng tin th√°ng/nƒÉm m·ªõi
            localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
            localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã s·ªë phi·∫øu tr√™n giao di·ªán
            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // H√†m l∆∞u d·ªØ li·ªáu form v√†o Local Storage ƒë·ªÉ gi·ªØ tr·∫°ng th√°i khi t·∫£i l·∫°i trang
        function saveFormData() {
            const form = document.getElementById('serviceReceiptForm');
            if (!form) return;

            const formData = {};
            // L·∫•y t·∫•t c·∫£ input, textarea, select ngo·∫°i tr·ª´ c√°c input readonly
            const inputs = form.querySelectorAll('input:not([readonly]), textarea, select');

            inputs.forEach(input => {
                if (input.name) { // Ch·ªâ x·ª≠ l√Ω c√°c ph·∫ßn t·ª≠ c√≥ thu·ªôc t√≠nh 'name'
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked; // L∆∞u tr·∫°ng th√°i true/false c·ªßa checkbox
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value; // L∆∞u gi√° tr·ªã c·ªßa radio ƒë∆∞·ª£c ch·ªçn
                        }
                    } else {
                        formData[input.name] = input.value; // L∆∞u gi√° tr·ªã c·ªßa c√°c input kh√°c
                    }
                }
            });
            localStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData)); // L∆∞u d∆∞·ªõi d·∫°ng chu·ªói JSON
        }

        // H√†m t·∫£i d·ªØ li·ªáu ƒë√£ l∆∞u t·ª´ Local Storage v√† ƒëi·ªÅn v√†o form
        function loadFormData() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData); // Parse chu·ªói JSON th√†nh ƒë·ªëi t∆∞·ª£ng
            const form = document.getElementById('serviceReceiptForm');
            if (!form) return;

            for (const name in formData) { // Duy·ªát qua t·ª´ng tr∆∞·ªùng d·ªØ li·ªáu ƒë√£ l∆∞u
                const elements = form.querySelectorAll(`[name="${name}"]`);
                if (elements.length > 0) {
                    elements.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = formData[name]; // Kh√¥i ph·ª•c tr·∫°ng th√°i checkbox
                        } else if (input.type === 'radio') {
                            if (input.value === formData[name]) {
                                input.checked = true; // Kh√¥i ph·ª•c tr·∫°ng th√°i radio
                            }
                        } else {
                            input.value = formData[name]; // Kh√¥i ph·ª•c gi√° tr·ªã input kh√°c
                        }
                    });
                }
            }
            // Sau khi t·∫£i d·ªØ li·ªáu, c·∫ßn c·∫≠p nh·∫≠t l·∫°i b·∫£ng d·ªãch v·ª• v√† t·ªïng c·ªông
            updateGrandTotal();
            
            // T·∫£i gi√° tr·ªã cho oldOdometer v√† currentOdometer
            const oldOdometerValue = document.getElementById('oldOdometer').value;
            const currentOdometerValue = document.getElementById('currentOdometer').value;

            // C·∫≠p nh·∫≠t g·ª£i √Ω c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng sau khi t·∫£i d·ªØ li·ªáu
            updateMaintenanceLevelRecommendation(oldOdometerValue, currentOdometerValue);

            // N·∫øu c√≥ c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng ƒë√£ ch·ªçn, g·ªçi populateServiceTable ƒë·ªÉ hi·ªÉn th·ªã c√°c h·∫°ng m·ª•c ƒë·ªông
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            if (maintenanceLevelSelect.value) {
                populateServiceTable(parseInt(maintenanceLevelSelect.value));
            } else {
                populateServiceTable(); // T·∫£i b·∫£ng m·∫∑c ƒë·ªãnh
            }
        }

        // H√†m t·∫°o m·ªôt h√†ng d·ªãch v·ª• trong b·∫£ng
        function createServiceRow(stt, hangMuc, dienGiai = '', soLuong = '', donGia = '', thanhTien = '', xacNhan = false, level = '', isDynamic = false) {
            const row = document.createElement('tr');
            const namePrefix = isDynamic ? `dynamic_service_${stt}` : `service_${stt}`; // T√™n duy nh·∫•t cho c√°c h√†ng ƒë·ªông

            row.innerHTML = `
                <td>${stt}</td>
                <td class="hang-muc"><input type="text" class="hang-muc-input" name="${namePrefix}_hangMuc" value="${hangMuc}" ${isDynamic ? '' : 'readonly'}></td>
                <td><input type="text" class="dien-giai-input" name="${namePrefix}_dienGiai" value="${dienGiai}"></td>
                <td><input type="number" step="any" class="sl-input" name="${namePrefix}_soLuong" value="${soLuong}" oninput="calculateRowTotal(this)"></td>
                <td><input type="number" step="any" class="don-gia-input" name="${namePrefix}_donGia" value="${donGia}" oninput="calculateRowTotal(this)"></td>
                <td><input type="text" class="thanh-tien-input" name="${namePrefix}_thanhTien" value="${thanhTien}" readonly></td>
                <td class="xac-nhan-col"><input type="checkbox" name="${namePrefix}_xacNhan" value="X" ${xacNhan ? 'checked' : ''}></td>
                <td class="cap-do-col">${level}</td>
            `;
            if (isDynamic) {
                row.classList.add('dynamic-row'); // ƒê√°nh d·∫•u h√†ng ƒë·ªông ƒë·ªÉ d·ªÖ d√†ng x√≥a
            }
            return row;
        }

        // H√†m populate b·∫£ng d·ªãch v·ª• v·ªõi c√°c h·∫°ng m·ª•c m·∫∑c ƒë·ªãnh v√† h·∫°ng m·ª•c ƒë·ªông (n·∫øu c√≥ c·∫•p ƒë·ªô ƒë∆∞·ª£c ch·ªçn)
        function populateServiceTable(selectedKm = null) {
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = ''; // X√≥a t·∫•t c·∫£ c√°c h√†ng hi·ªán c√≥

            let currentStt = 1; // Bi·∫øn ƒë·∫øm STT

            // Th√™m c√°c h·∫°ng m·ª•c d·ªãch v·ª• m·∫∑c ƒë·ªãnh
            predefinedServiceItems.forEach(item => {
                const row = createServiceRow(
                    String(currentStt++).padStart(2, '0'),
                    item.hangMuc,
                    '', '', '', '', false, item.level, false // isDynamic = false cho c√°c h√†ng m·∫∑c ƒë·ªãnh
                );
                tbody.appendChild(row);
            });

            // Th√™m h√†ng t·ªïng c·ªông v√†o cu·ªëi c√°c h·∫°ng m·ª•c m·∫∑c ƒë·ªãnh
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            totalRow.innerHTML = `
                <td colspan="5">T·ªîNG C·ªòNG</td>
                <td><input type="text" id="grand-total" name="tongCong" readonly style="font-weight: bold;"></td>
                <td colspan="2"></td> <!-- C·∫≠p nh·∫≠t colspan cho c·ªôt C·∫§P ƒê·ªò -->
            `;
            tbody.appendChild(totalRow);


            // Th√™m c√°c h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng ƒë·ªông n·∫øu c√≥ c·∫•p ƒë·ªô ƒë∆∞·ª£c ch·ªçn
            if (selectedKm !== null) {
                const milestone = maintenanceMilestones.find(m => m.km === selectedKm);
                if (milestone) {
                    // Th√™m m·ªôt ti√™u ƒë·ªÅ cho c√°c h·∫°ng m·ª•c ƒë·ªông
                    const categoryHeaderRow = document.createElement('tr');
                    categoryHeaderRow.classList.add('category-header');
                    categoryHeaderRow.innerHTML = `<th colspan="8">C√°c h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng theo c·∫•p ƒë·ªô: ${milestone.level} (${milestone.km} km)</th>`; // C·∫≠p nh·∫≠t colspan
                    tbody.insertBefore(categoryHeaderRow, totalRow); // Ch√®n tr∆∞·ªõc h√†ng t·ªïng c·ªông

                    milestone.items.forEach(item => {
                        const row = createServiceRow(
                            String(currentStt++).padStart(2, '0'),
                            item, // H·∫°ng m·ª•c
                            '', '', '', '', false, milestone.level, true // isDynamic = true cho c√°c h√†ng ƒë·ªông
                        );
                        tbody.insertBefore(row, totalRow); // Ch√®n tr∆∞·ªõc h√†ng t·ªïng c·ªông
                    });
                }
            }

            // Sau khi t·∫°o l·∫°i b·∫£ng, c·∫ßn t·∫£i l·∫°i d·ªØ li·ªáu ƒë√£ l∆∞u cho c√°c tr∆∞·ªùng input
            loadFormDataForTableInputs();
            updateGrandTotal(); // C·∫≠p nh·∫≠t t·ªïng c·ªông
        }

        // H√†m t·∫£i d·ªØ li·ªáu ƒë√£ l∆∞u ƒë·∫∑c bi·ªát cho c√°c input trong b·∫£ng
        function loadFormDataForTableInputs() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;
            const formData = JSON.parse(savedData);

            document.querySelectorAll('.detailed-service input[name], .detailed-service textarea[name]').forEach(input => {
                if (formData[input.name] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = formData[input.name];
                    } else {
                        input.value = formData[input.name];
                    }
                }
            });
        }

        /**
         * H√†m l·∫•y c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng khuy·∫øn ngh·ªã d·ª±a tr√™n s·ªë KM hi·ªán t·∫°i.
         * T√¨m m·ªëc b·∫£o d∆∞·ª°ng l·ªõn nh·∫•t nh·ªè h∆°n ho·∫∑c b·∫±ng s·ªë KM hi·ªán t·∫°i.
         * @param {number} currentKm - S·ªë kilomet hi·ªán t·∫°i c·ªßa xe.
         * @returns {number|null} KM c·ªßa m·ªëc b·∫£o d∆∞·ª°ng khuy·∫øn ngh·ªã, ho·∫∑c null n·∫øu kh√¥ng t√¨m th·∫•y.
         */
        function getRecommendedMaintenanceLevel(currentKm) {
            if (isNaN(currentKm) || currentKm <= 0) {
                return null;
            }
            let recommendedKm = null;
            // Duy·ªát t·ª´ c√°c m·ªëc KM l·ªõn nh·∫•t xu·ªëng ƒë·ªÉ t√¨m m·ªëc g·∫ßn nh·∫•t v√† nh·ªè h∆°n ho·∫∑c b·∫±ng currentKm
            for (let i = maintenanceMilestones.length - 1; i >= 0; i--) {
                if (currentKm >= maintenanceMilestones[i].km) {
                    recommendedKm = maintenanceMilestones[i].km;
                    break;
                }
            }
            return recommendedKm;
        }

        /**
         * H√†m populate c√°c t√πy ch·ªçn cho dropdown C·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng, bao g·ªìm g·ª£i √Ω "khuy·∫øn kh√≠ch".
         * @param {number|null} recommendedKm - KM c·ªßa m·ªëc b·∫£o d∆∞·ª°ng ƒë∆∞·ª£c khuy·∫øn ngh·ªã.
         * @param {string} selectedValue - Gi√° tr·ªã hi·ªán t·∫°i ƒëang ƒë∆∞·ª£c ch·ªçn trong dropdown.
         */
        function populateMaintenanceLevels(recommendedKm = null, selectedValue = '') {
            const selectElement = document.getElementById('maintenanceLevel');
            selectElement.innerHTML = ''; // X√≥a c√°c t√πy ch·ªçn hi·ªán c√≥

            // Th√™m t√πy ch·ªçn m·∫∑c ƒë·ªãnh
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Ch·ªçn c·∫•p ƒë·ªô --';
            selectElement.appendChild(defaultOption);

            // Th√™m c√°c t√πy ch·ªçn t·ª´ maintenanceMilestones
            maintenanceMilestones.forEach(milestone => {
                const option = document.createElement('option');
                option.value = milestone.km;
                option.textContent = `${milestone.level} (${milestone.km} km)`;
                if (milestone.km === recommendedKm) {
                    option.textContent += ' (khuy·∫øn kh√≠ch)';
                    // Th√™m class ƒë·ªÉ b√¥i s√°ng/l√†m n·ªïi b·∫≠t option n√†y
                    option.classList.add('recommended-option');
                }
                selectElement.appendChild(option);
            });

            // ƒê·∫∑t l·∫°i gi√° tr·ªã ƒë√£ ch·ªçn n·∫øu c√≥
            if (selectedValue) {
                selectElement.value = selectedValue;
            } else if (recommendedKm) {
                selectElement.value = recommendedKm; // T·ª± ƒë·ªông ch·ªçn khuy·∫øn ngh·ªã n·∫øu kh√¥ng c√≥ gi√° tr·ªã c≈©
            }
            // N·∫øu sau khi ƒë·∫∑t gi√° tr·ªã, dropdown v·∫´n kh√¥ng c√≥ gi√° tr·ªã n√†o ƒë∆∞·ª£c ch·ªçn (v√≠ d·ª•: recommendedKm l√† null ho·∫∑c kh√¥ng t√¨m th·∫•y trong danh s√°ch)
            // th√¨ ƒë·∫£m b·∫£o t√πy ch·ªçn m·∫∑c ƒë·ªãnh '-- Ch·ªçn c·∫•p ƒë·ªô --' ƒë∆∞·ª£c ch·ªçn.
            if (!selectElement.value && selectElement.options.length > 0) {
                 selectElement.value = ''; // ƒê·∫£m b·∫£o t√πy ch·ªçn m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c ch·ªçn
            }
        }

        /**
         * H√†m c·∫≠p nh·∫≠t g·ª£i √Ω c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng khi c√≥ thay ƒë·ªïi ·ªü KM c≈© ho·∫∑c KM hi·ªán t·∫°i.
         */
        function updateMaintenanceLevelRecommendation() {
            // L·∫•y gi√° tr·ªã KM hi·ªán t·∫°i v√† lo·∫°i b·ªè d·∫•u ch·∫•m ph√¢n c√°ch h√†ng ngh√¨n
            const currentOdometerValue = parseFloat(document.getElementById('currentOdometer').value.replace(/\./g, '')) || 0;
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            const currentSelectedLevel = maintenanceLevelSelect.value; // Gi·ªØ gi√° tr·ªã hi·ªán t·∫°i ƒëang ƒë∆∞·ª£c ch·ªçn

            let recommendedKm = null;
            if (currentOdometerValue > 0) {
                recommendedKm = getRecommendedMaintenanceLevel(currentOdometerValue);
            }
            
            // Populate l·∫°i dropdown v·ªõi g·ª£i √Ω m·ªõi, gi·ªØ nguy√™n l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng n·∫øu c√≥
            populateMaintenanceLevels(recommendedKm, currentSelectedLevel);
            saveFormData(); // L∆∞u tr·∫°ng th√°i form sau khi c·∫≠p nh·∫≠t g·ª£i √Ω
        }


        let hasSubmitted = false; // Bi·∫øn c·ªù ki·ªÉm tra tr·∫°ng th√°i g·ª≠i form th√†nh c√¥ng

        // Ch·∫°y khi to√†n b·ªô DOM ƒë√£ ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', () => {
            initializeReceiptNumber(); // Kh·ªüi t·∫°o s·ªë phi·∫øu khi t·∫£i trang
            document.getElementById('receivedDateTime').value = getCurrentDateTimeLocal(); // ƒê·∫∑t ng√†y gi·ªù nh·∫≠n xe m·∫∑c ƒë·ªãnh

            // Populating the table with predefined items first
            populateServiceTable();
            
            // Kh·ªüi t·∫°o v√† populate dropdown c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng
            // G·ªçi populateMaintenanceLevels l·∫ßn ƒë·∫ßu m√† kh√¥ng c√≥ recommendedKm ƒë·ªÉ n√≥ hi·ªÉn th·ªã t·∫•t c·∫£ c√°c t√πy ch·ªçn
            // v√† sau ƒë√≥ loadFormData s·∫Ω x·ª≠ l√Ω vi·ªác ch·ªçn l·∫°i n·∫øu c√≥ d·ªØ li·ªáu ƒë√£ l∆∞u.
            populateMaintenanceLevels(); 
            
            loadFormData(); // T·∫£i d·ªØ li·ªáu form n·∫øu c√≥ (s·∫Ω g·ªçi populateServiceTable l·∫°i n·∫øu c√≥ c·∫•p ƒë·ªô ƒë√£ ch·ªçn)


            const form = document.getElementById('serviceReceiptForm');
            if (form) {
                // G√°n s·ª± ki·ªán 'input' v√† 'change' ƒë·ªÉ l∆∞u form t·ª± ƒë·ªông
                form.addEventListener('input', saveFormData);
                form.addEventListener('change', saveFormData);
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            if (maintenanceLevelSelect) {
                maintenanceLevelSelect.addEventListener('change', () => {
                    const selectedKm = maintenanceLevelSelect.value ? parseInt(maintenanceLevelSelect.value) : null;
                    populateServiceTable(selectedKm);
                    saveFormData(); // L∆∞u tr·∫°ng th√°i c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng ƒë√£ ch·ªçn
                });
            }

            // Th√™m s·ª± ki·ªán input cho tr∆∞·ªùng KM c≈© v√† KM hi·ªán t·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t g·ª£i √Ω
            const oldOdometerInput = document.getElementById('oldOdometer');
            const currentOdometerInput = document.getElementById('currentOdometer');

            if (oldOdometerInput) {
                oldOdometerInput.addEventListener('input', updateMaintenanceLevelRecommendation);
            }
            if (currentOdometerInput) {
                currentOdometerInput.addEventListener('input', updateMaintenanceLevelRecommendation);
            }


            // X·ª≠ l√Ω s·ª± ki·ªán khi click n√∫t "G·ª≠i Th√¥ng Tin"
            const submitButton = document.getElementById('submitToSheet');
            if (submitButton) {
                submitButton.addEventListener('click', (event) => {
                    event.preventDefault(); // NgƒÉn h√†nh vi g·ª≠i form m·∫∑c ƒë·ªãnh
                    const scriptURL = form.action; // L·∫•y URL Apps Script t·ª´ thu·ªôc t√≠nh 'action' c·ªßa form

                    // Ki·ªÉm tra validation c·ªßa form
                    if (!form.checkValidity()) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc tr∆∞·ªõc khi g·ª≠i!');
                        form.reportValidity(); // Hi·ªÉn th·ªã l·ªói validation c·ªßa tr√¨nh duy·ªát
                        return;
                    }

                    // V√¥ hi·ªáu h√≥a n√∫t g·ª≠i v√† thay ƒë·ªïi text ƒë·ªÉ tr√°nh g·ª≠i nhi·ªÅu l·∫ßn
                    submitButton.disabled = true;
                    submitButton.textContent = 'ƒêang g·ª≠i...';

                    // Thu th·∫≠p d·ªØ li·ªáu form d∆∞·ªõi d·∫°ng URL-encoded
                    const urlEncodedData = collectFormDataAsUrlEncoded(form);

                    // G·ª≠i d·ªØ li·ªáu ƒë·∫øn Apps Script b·∫±ng Fetch API (POST request)
                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData
                    })
                    .then(response => response.json().then(data => {
                        if (!response.ok) { // Ki·ªÉm tra n·∫øu ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng (HTTP status code >= 400)
                            // S·ª≠ d·ª•ng String() ƒë·ªÉ ƒë·∫£m b·∫£o data.message l√† chu·ªói
                            throw new Error(String(data.message || 'L·ªói t·ª´ m√°y ch·ªß kh√¥ng x√°c ƒë·ªãnh.'));
                        }
                        return data; // Tr·∫£ v·ªÅ d·ªØ li·ªáu JSON
                    }))
                    .then(data => {
                        if (data.result === 'success') {
                            alert('‚úÖ G·ª≠i th√¥ng tin th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ in phi·∫øu.');
                            console.log('D·ªØ li·ªáu ƒë√£ g·ª≠i:', data.data); // Log d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ Apps Script
                            hasSubmitted = true; // ƒê·∫∑t c·ªù ƒë√£ g·ª≠i th√†nh c√¥ng
                        } else {
                            alert('‚ùå Kh√¥ng g·ª≠i ƒë∆∞·ª£c: ' + String(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ Apps Script.')); // String() an to√†n
                            console.error('L·ªói t·ª´ Apps Script:', data.message);
                        }
                    })
                    .catch(error => { // B·∫Øt c√°c l·ªói trong qu√° tr√¨nh fetch ho·∫∑c x·ª≠ l√Ω ph·∫£n h·ªìi
                        alert('‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i. Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                        console.error('L·ªói Fetch ho·∫∑c ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá:', error);
                    })
                    .finally(() => { // Lu√¥n ch·∫°y sau khi fetch ho√†n t·∫•t (th√†nh c√¥ng ho·∫∑c l·ªói)
                        submitButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t g·ª≠i
                        submitButton.textContent = 'üì§ G·ª≠i Th√¥ng Tin'; // ƒê·∫∑t l·∫°i text n√∫t
                    });
                });
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi click n√∫t "In Phi·∫øu"
            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', (event) => {
                    event.preventDefault(); // NgƒÉn h√†nh vi in m·∫∑c ƒë·ªãnh
                    if (!hasSubmitted) { // Y√™u c·∫ßu g·ª≠i form tr∆∞·ªõc khi in
                        alert('Vui l√≤ng nh·∫•n "G·ª≠i Th√¥ng Tin" tr∆∞·ªõc khi in phi·∫øu!');
                        return;
                    }
                    incrementReceiptNumberOnPrint(); // TƒÉng s·ªë phi·∫øu tr∆∞·ªõc khi in
                    window.print(); // K√≠ch ho·∫°t h·ªôp tho·∫°i in
                });
            }

            // X·ª≠ l√Ω s·ª± ki·ªán khi click n√∫t "X√≥a Form"
            const clearFormButton = document.getElementById('clearFormButton');
            if (clearFormButton) {
                clearFormButton.addEventListener('click', () => {
                    // Thay th·∫ø confirm() b·∫±ng modal t√πy ch·ªânh
                    showCustomConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô th√¥ng tin tr√™n form kh√¥ng? (Ch·ªâ x√≥a sau khi ƒë√£ in th√†nh c√¥ng)', () => {
                        resetFormAndLocalStorage(); // G·ªçi h√†m reset form
                    });
                });
            }
        });

        // H√†m thu th·∫≠p d·ªØ li·ªáu form v√† m√£ h√≥a th√†nh URL-encoded string
        function collectFormDataAsUrlEncoded(formElement) {
            const params = new URLSearchParams();

            // Collect all named inputs, textareas, and selects
            const formElements = formElement.querySelectorAll('input[name], textarea[name], select[name]');

            formElements.forEach(element => {
                let name = element.name;
                let value;

                if (element.type === 'checkbox') {
                    value = element.checked ? 'on' : ''; // Mimic FormData behavior for checkboxes
                } else if (element.type === 'radio') {
                    // Only get value if checked, handled by FormData.
                    // We'll handle unselected radio groups later.
                    if (element.checked) {
                        value = element.value;
                    } else {
                        return; // Skip unchecked radios for now, they are handled by the outer loop
                    }
                } else {
                    value = element.value;
                }

                // Ensure 'value' is a string using robust coercion (value + '')
                let safeValue = value + ''; 

                // Apply transformations to 'safeValue'
                if (name.endsWith('_thanhTien')) {
                    console.log(`DEBUG: Processing _thanhTien. Name: ${name}, safeValue before replace: '${safeValue}', typeof safeValue: ${typeof safeValue}, isString: ${typeof safeValue === 'string'}`);
                    // Ensure it's a string before calling replace
                    if (typeof safeValue === 'string') { 
                        safeValue = safeValue.replace(/\./g, '').replace(/,/g, '.');
                    } else {
                        console.error(`ERROR: safeValue for ${name} is not a string (type: ${typeof safeValue}). Falling back to empty string.`);
                        safeValue = ''; 
                    }
                    console.log(`DEBUG: safeValue after replace: '${safeValue}'`);
                }
                else if (name.endsWith('_xacNhan')) {
                    // For checkboxes named service_xacNhan_X, convert 'on' to 'X'
                    safeValue = (element.type === 'checkbox' && element.checked) ? 'X' : '';
                }
                else if (name === 'sokmcu' || name === 'sokmhientai') {
                    console.log(`DEBUG: Processing KM. Name: ${name}, safeValue before replace: '${safeValue}', typeof safeValue: ${typeof safeValue}, isString: ${typeof safeValue === 'string'}`);
                    // Ensure it's a string before calling replace
                    if (typeof safeValue === 'string') { 
                        safeValue = safeValue.replace(/\./g, '');
                    } else {
                        console.error(`ERROR: safeValue for ${name} is not a string (type: ${typeof safeValue}). Falling back to empty string.`);
                        safeValue = ''; 
                    }
                    console.log(`DEBUG: safeValue after replace: '${safeValue}'`);
                }
                params.append(name, safeValue);
            });

            // Ensure unchecked checkboxes are included with empty string values
            formElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked && !params.has(checkbox.name)) {
                    params.append(checkbox.name, '');
                }
            });

            // Ensure unselected radio groups are included with empty string values
            const radioGroupNames = new Set();
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroupNames.add(radio.name));
            radioGroupNames.forEach(groupName => {
                const checkedRadioInGroup = formElement.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (!checkedRadioInGroup && !params.has(groupName)) {
                    params.append(groupName, '');
                }
            });

            // Add static fields (formType, receiptNumber, currentMonthYear)
            params.append('formType', formElement.querySelector('[name="formType"]').value);
            params.append('receiptNumber', document.getElementById('receiptNumber')?.textContent || '');
            params.append('currentMonthYear', document.getElementById('currentMonth')?.textContent || '');

            return params.toString();
        }

        // H√†m hi·ªÉn th·ªã modal x√°c nh·∫≠n t√πy ch·ªânh (thay th·∫ø alert/confirm)
        function showCustomConfirm(message, onConfirm) {
            const modalId = 'customConfirmModal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                    position: fixed;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    font-family: Arial, sans-serif;
                `;
                modal.innerHTML = `
                    <div style="
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        text-align: center;
                        max-width: 400px;
                        width: 90%;
                    ">
                        <p style="margin-bottom: 20px; font-size: 16px;">${message}</p>
                        <button id="confirmYes" style="
                            padding: 10px 20px;
                            margin: 0 10px;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                            background-color: #007bff;
                            color: white;
                        ">ƒê·ªìng √Ω</button>
                        <button id="confirmNo" style="
                            padding: 10px 20px;
                            margin: 0 10px;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                            background-color: #6c757d;
                            color: white;
                        ">H·ªßy</button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    onConfirm();
                    modal.style.display = 'none';
                };
                document.getElementById('confirmNo').onclick = () => {
                    modal.style.display = 'none';
                };
            } else {
                modal.querySelector('p').textContent = message;
                modal.style.display = 'flex';
                document.getElementById('confirmYes').onclick = () => {
                    onConfirm();
                    modal.style.display = 'none';
                };
            }
            modal.style.display = 'flex';
        }
    </script>
</body>
</html>
