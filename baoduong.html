<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));
                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>
	<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu B·∫£o D∆∞·ª°ng - PHI LONG AUTO</title>
    <style>
        * {
            margin: 0; padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif; font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 230mm; margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-content {
            padding: 15mm;
        }
        .header {
            display: flex; justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .header-left h1 {
            font-size: 24px; font-weight: bold;
            font-style: italic;
            margin-bottom: 5px;
        }
        .form-number {
            font-size: 16px; font-weight: bold;
        }
        .header-right {
            text-align: right;
        }
        .logo {
            width: 80px; height: 60px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
        }
        .info-section {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .info-group {
            margin-bottom: 8px; display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .info-group label {
            font-weight: bold; margin-right: 5px;
            white-space: nowrap;
        }
        .info-group .info-input {
            border: none; border-bottom: 1px dotted #000;
            flex-grow: 1;
            padding: 0 5px;
            font-size: 12px;
            min-width: 50px;
        }
        .info-group .info-input.name-input { min-width: 150px; }
        .info-group .info-input.phone-email-input { min-width: 90px; }
        .info-group .info-input.datetime-input { min-width: 130px; }
        .info-group .info-input.car-type-input { min-width: 150px; }
        .info-group .info-input.license-km-input { min-width: 90px; }
        .request-details {
            margin-bottom: 13px; border: 1px solid #000;
            padding: 9px;
        }
        .section-title {
            background: #003366; color: white;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            margin: -10px -10px 10px -10px;
        }
        .request-group {
            margin-bottom: 10px;
        }
        .request-group label {
            font-weight: bold; display: block;
            margin-bottom: 5px;
        }
        .request-group textarea {
            width: 100%; border: 1px dotted #000;
            padding: 5px;
            resize: vertical;
            min-height: 50px;
            font-size: 12px;
        }
        .detailed-service {
            margin-top: 15px; width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
        }
        .detailed-service th,
        .detailed-service td {
            border: 1px solid #000; padding: 5px;
            text-align: center;
            font-size: 11px;
        }
        .detailed-service th {
            background: #003366; color: white;
            font-weight: bold;
        }
        .detailed-service .stt { width: 30px; }
        .detailed-service .hang-muc { width: 120px; text-align: left; font-weight: bold; }
        .detailed-service .dien-giai { width: 180px; }
        .detailed-service .sl { width: 50px; }
        .detailed-service .don-gia, .detailed-service .thanh-tien { width: 90px; }
        .detailed-service .xac-nhan-col { width: 60px; }
        .detailed-service .status-col { width: 60px; }
        .detailed-service input[type="text"],
        .detailed-service input[type="number"] {
            width: 100%; border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }
        .detailed-service input[type="text"].hang-muc-input {
            text-align: left; font-weight: bold;
        }
        .detailed-service input[type="checkbox"] {
            width: 15px; height: 15px;
            margin: 0 auto;
            display: block;
            vertical-align: middle;
        }
        .total-row {
            background: #ccc; font-weight: bold;
        }
        .signature-section {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 20px;
            padding-top: 15px;
        }
        .signature-box { text-align: center; }
        .signature-title {
            font-weight: bold; margin-bottom: 30px;
        }
        .signature-input {
            border: none; border-bottom: 1px dotted #000;
            width: 100%;
            text-align: center;
            padding: 2px 0;
            font-size: 12px;
            margin-top: -20px;
        }
        .signature-subtitle {
            font-size: 10px; font-style: italic;
        }
        .footer {
            margin-top: 15px; font-size: 9px;
            line-height: 1.2;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        .button-group {
            display: flex; justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .app-button {
            padding: 8px 12px; border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
            background: #28a745;
            color: white;
        }
        .app-button:hover { background: #218838; }
        .print-button {
            background: #007bff;
        }
        .print-button:hover { background: #0056b3; }
        .clear-button {
            background: #dc3545;
        }
        .clear-button:hover { background: #c82333; }
        .recommended-option {
            background-color: #e6f7ff;
            font-weight: bold;
            color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button class="app-button print-button" id="printButton">üñ®Ô∏è In Phi·∫øu</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/tracuu.html'">üìÑ Tra c·ª©u th√¥ng tin xe </button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra'">üìÑ Phi·∫øu KT An To√†n </button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/Phieukiemlop2.html'">üìÑ Phi·∫øu KT L·ªëp</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">üìÑ Phi·∫øu Ki·ªÉm G·∫ßm</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieunhandichvu.html'">üìÑ Phi·∫øu Ki·ªÉm Tra Xe</button>
            <button class="app-button" id="submitToSheet">üì§ G·ª≠i Th√¥ng Tin</button>
            <button class="app-button clear-button" id="clearFormButton">üóëÔ∏è X√≥a Form</button>
        </div>
        
        <div class="form-content">
            <form id="serviceReceiptForm" action="https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec" method="POST">
                <input type="hidden" name="formType" value="PhieuNhanDichVu">

                <div class="header">
                    <div class="header-left">
                        <h1>PHI·∫æU B·∫¢O D∆Ø·ª†NG</h1>
                        <div class="form-number">‚Ññ <span id="receiptNumber"></span> / <span id="currentMonth"></span></div>
                    </div>
                    <div class="header-right">
                        <div class="logo">
                            <img src="https://longvt89.github.io/phieukiemtra/logophilong.jpg" alt="Logo Phi Long Auto" style="height: 90px;">
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-left">
                        <div class="info-group">
                            <label for="customerName">H·ªç t√™n kh√°ch h√†ng:</label>
                            <input type="text" id="customerName" name="hoten" class="info-input name-input" required>
                        </div>
                        <div class="info-group">
                            <label for="customerPhone">S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="tel" id="customerPhone" name="dienthoai" class="info-input phone-email-input" required>
                        </div>
                        <div class="info-group">
                            <label for="carModel">H√£ng/ƒê·ªùi xe:</label>
                            <input type="text" id="carModel" name="hangXe" class="info-input car-type-input" required>
                        </div>
                        <div class="info-group">
                            <label for="licensePlate">Bi·ªÉn s·ªë xe:</label>
                            <input type="text" id="licensePlate" name="bienso" class="info-input license-km-input" required>
                        </div>
						<div class="info-group">
                            <label for="branchSelect">Chi nh√°nh:</label>
                            <select id="branchSelect" name="chiNhanh" class="info-input" required>
                                <option value="">-- Ch·ªçn chi nh√°nh --</option>
                                <option value="Chi Nh√°nh 1 - B√¨nh Ph∆∞·ªõc">Chi Nh√°nh 1 - B√¨nh Ph∆∞·ªõc</option>
                                <option value="Chi Nh√°nh 2 - ƒê·ªìng Xo√†i">Chi Nh√°nh 2 - ƒê·ªìng Xo√†i</option>
                                <option value="Chi Nh√°nh 3 - B√¨nh D∆∞∆°ng">Chi Nh√°nh 3 - B√¨nh D∆∞∆°ng</option>
                            </select>
                        </div>
                    </div>
                    <div class="info-right">
                        <div class="info-group">
                            <label for="receptionist">Ng∆∞·ªùi ti·∫øp nh·∫≠n:</label>
                            <input type="text" list="receptionistList" id="receptionist" name="nguoiTiepNhan" class="info-input name-input">
                            <datalist id="receptionistList">
                                <option value="Cao Thanh Duy">
                                <option value="Tr·∫ßn Ng·ªçc H√†o">
                                <option value="Nguy·ªÖn Ph∆∞·ªõc Hi·∫øu">
                                <option value="Nguy·ªÖn Trung Ki√™n">
                            </datalist>
                        </div>
                        <div class="info-group">
                            <label for="receivedDateTime">Ng√†y gi·ªù nh·∫≠n xe:</label>
                            <input type="datetime-local" id="receivedDateTime" name="nhanxe" class="info-input datetime-input" required>
                        </div>
                        <div class="info-group">
                            <label for="expectedDeliveryTime">Ng√†y gi·ªù d·ª± ki·∫øn giao:</label>
                            <input type="datetime-local" id="expectedDeliveryTime" name="duKienGiaoXe" class="info-input datetime-input">
                        </div>
                        <div class="info-group">
                            <label for="oldOdometer">S·ªë KM c≈©:</label>
                            <input type="text" id="oldOdometer" name="sokmcu" class="info-input license-km-input">
                        </div>
                        <div class="info-group">
                            <label for="currentOdometer">S·ªë KM hi·ªán t·∫°i:</label>
                            <input type="text" id="currentOdometer" name="sokmhientai" class="info-input license-km-input">
                        </div>
                        <div class="info-group">
                            <label for="maintenanceLevel">C·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng:</label>
                            <select id="maintenanceLevel" name="capDoBaoDuong" class="info-input">
                                </select>
                        </div>
                        
                    </div>
                </div>

                <div class="request-details">
                    <div class="section-title">Y√äU C·∫¶U C·ª¶A KH√ÅCH H√ÄNG & CH·∫®N ƒêO√ÅN BAN ƒê·∫¶U</div>
                    <div class="request-group">
                        <label for="customerRequest">Y√™u c·∫ßu c·ªßa kh√°ch h√†ng:</label>
                        <textarea id="customerRequest" name="yeuCauKhachHang" placeholder="M√¥ t·∫£ c√°c v·∫•n ƒë·ªÅ ho·∫∑c d·ªãch v·ª• kh√°ch h√†ng y√™u"></textarea>
                    </div>
                    <div class="request-group">
                        <label for="initialDiagnosis">Ch·∫©n ƒëo√°n ban ƒë·∫ßu:</label>
                        <textarea id="initialDiagnosis" name="chanDoanBanDau" placeholder="M√¥ t·∫£ ch·∫©n ƒëo√°n ban ƒë·∫ßu c·ªßa k·ªπ thu·∫≠t vi√™n"></textarea>
                    </div>
                </div>

                <table class="detailed-service">
                    <thead>
                        <tr>
                            <th class="stt">STT</th>
                            <th class="hang-muc">H·∫†NG M·ª§C D·ªäCH V·ª§/V·∫¨T T∆Ø</th>
                            <th class="dien-giai">DI·ªÑN GI·∫¢I</th>
                            <th class="sl">SL</th>
                            <th class="don-gia">ƒê∆†N GI√Å</th>
                            <th class="thanh-tien">TH√ÄNH TI·ªÄN</th>
                            <th class="xac-nhan-col">X√ÅC NH·∫¨N</th>
                            <th class="status-col">TR·∫†NG TH√ÅI</th>
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        </tbody>
                </table>

                <div class="request-details" style="margin-top: 15px;">
                    <div class="section-title">GHI CH√ö</div>
                    <div class="request-group">
                        <label for="generalNotes">Ghi ch√∫ chung:</label>
                        <textarea id="generalNotes" name="ghiChuChung" placeholder="C√°c ghi ch√∫ ho·∫∑c y√™u c·∫ßu ƒë·∫∑c bi·ªát kh√°c"></textarea>
                    </div>
                </div>

                <div class="footer">
                    <p><strong> Th√¥ng tin:</strong></p>
                    <p>"I - Inspection: Ki·ªÉm tra v√† x·ª≠ l√≠ theo t√¨nh tr·∫°ng "</p>
					<p>"R - Replace: Thay th·∫ø  "</p>
					<p>"A - Adjust: V·ªá sinh ho·∫∑c c√¢n ch·ªânh"</p>
                </div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">ƒê·∫°i l√Ω</div>
                        <input type="text" list="receptionistList" class="signature-input" name="daiLyPhuTrach" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p t√™n">
                        <div class="signature-subtitle">(K√Ω t√™n)</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Kh√°ch h√†ng</div>
                        <input type="text" class="signature-input" name="khachHangKyTen" placeholder="K√Ω t√™n">
                        <div class="signature-subtitle">(K√Ω t√™n)</div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const RECEIPT_NUMBER_KEY = 'serviceReceipt_receiptNumber';
        const LAST_MONTH_KEY = 'serviceReceipt_lastMonth';
        const FORM_DATA_KEY = 'serviceReceipt_formData';

        // Constants for branch locations
        const branchLocations = [
            { name: 'Chi Nh√°nh 1 - B√¨nh Ph∆∞·ªõc', lat: 11.5145974, lon: 106.8931262 },
            { name: 'Chi Nh√°nh 2 - ƒê·ªìng Xo√†i', lat: 11.537788, lon: 106.905191 },
            { name: 'Chi Nh√°nh 3 - B√¨nh D∆∞∆°ng', lat: 11.004401, lon: 106.6719367 }
        ];
        const GEOLOCATION_ERROR_RADIUS = 100; // meters

        // --- Utility Functions ---

        /**
         * Calculates the distance between two geographical points using the Haversine formula.
         * @param {number} lat1 - Latitude of point 1 in degrees.
         * @param {number} lon1 - Longitude of point 1 in degrees.
         * @param {number} lat2 - Latitude of point 2 in degrees.
         * @param {number} lon2 - Longitude of point 2 in degrees.
         * @returns {number} Distance in meters.
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const œÜ1 = lat1 * Math.PI / 180; // œÜ, Œª in radians
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // in metres
            return d;
        }

        /**
         * Determines the closest branch based on current geolocation and automatically selects it.
         */
        function getClosestBranch() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        let closestBranch = null;
                        let minDistance = Infinity;

                        branchLocations.forEach(branch => {
                            const distance = getDistance(userLat, userLon, branch.lat, branch.lon);
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestBranch = branch;
                            }
                        });

                        const branchSelect = document.getElementById('branchSelect');
                        if (closestBranch && minDistance <= GEOLOCATION_ERROR_RADIUS) { // Within 100 meters
                            branchSelect.value = closestBranch.name;
                            console.log(`T·ª± ƒë·ªông ch·ªçn chi nh√°nh: ${closestBranch.name} (kho·∫£ng c√°ch: ${minDistance.toFixed(2)}m)`);
                        } else if (closestBranch) {
                            console.log(`Chi nh√°nh g·∫ßn nh·∫•t (${closestBranch.name}) ·ªü ngo√†i b√°n k√≠nh cho ph√©p (${minDistance.toFixed(2)}m > ${GEOLOCATION_ERROR_RADIUS}m). Kh√¥ng t·ª± ƒë·ªông ch·ªçn.`);
                        } else {
                            console.log('Kh√¥ng t√¨m th·∫•y chi nh√°nh n√†o g·∫ßn nh·∫•t.');
                        }
                        saveFormData(); // Save after potentially setting branch
                    },
                    (error) => {
                        console.warn(`L·ªói khi l·∫•y v·ªã tr√≠: ${error.message}`);
                        alert('Kh√¥ng th·ªÉ t·ª± ƒë·ªông x√°c ƒë·ªãnh chi nh√°nh. Vui l√≤ng ch·ªçn th·ªß c√¥ng. L·ªói: ' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.');
                alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã. Vui l√≤ng ch·ªçn chi nh√°nh th·ªß c√¥ng.');
            }
        }


        const maintenanceMilestones = [
            { km: 1000, level: 'KT ƒë·∫ßu ti√™n (1 th√°ng)', items: [
                'KT t·ªïng th·ªÉ xe', 'KT m·ª©c d·∫ßu ƒë·ªông c∆°', 'KT m·ª©c n∆∞·ªõc l√†m m√°t',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n, c√≤i, g·∫°t m∆∞a'
            ]},
            { km: 5000, level: 'C·∫•p 1', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 10000, level: 'C·∫•p 2', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh ho·∫∑c thay l·ªçc gi√≥ ƒë·ªông c∆°',
                'KT t√¨nh tr·∫°ng ·∫Øc quy', 'KT h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'KT l·ªçc gi√≥ ƒëi·ªÅu h√≤a',
                'KT h·ªá th·ªëng treo v√† l√°i', 'KT d·∫ßu h·ªôp s·ªë (n·∫øu c√≥)',
            ]},
            { km: 15000, level: 'C·∫•p 1', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 20000, level: 'C·∫•p 3', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'Thay l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
                'KT h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'Thay l·ªçc gi√≥ ƒëi·ªÅu h√≤a', 'KT h·ªá th·ªëng treo v√† l√°i',
                'KT d·∫ßu h·ªôp s·ªë', 'KT bugi (n·∫øu ƒë·∫øn h·∫°n thay)', 'KT d√¢y ƒëai truy·ªÅn ƒë·ªông',
            ]},
            { km: 25000, level: 'C·∫•p 1', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 30000, level: 'C·∫•p 2', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh ho·∫∑c thay l·ªçc gi√≥ ƒë·ªông c∆°',
                'KT t√¨nh tr·∫°ng ·∫Øc quy', 'KT h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'KT l·ªçc gi√≥ ƒëi·ªÅu h√≤a',
                'KT h·ªá th·ªëng treo v√† l√°i', 'KT d·∫ßu h·ªôp s·ªë (n·∫øu c√≥)',
            ]},
            { km: 35000, level: 'C·∫•p 1', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 40000, level: 'C·∫•p 4', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'Thay l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
                'KT & thay th·∫ø m√° phanh, ƒëƒ©a phanh n·∫øu c·∫ßn', 'Thay l·ªçc gi√≥ ƒëi·ªÅu h√≤a', 'KT h·ªá th·ªëng treo v√† l√°i',
                'Thay d·∫ßu h·ªôp s·ªë', 'Thay bugi', 'KT & thay d√¢y ƒëai truy·ªÅn ƒë·ªông', 'KT h·ªá th·ªëng nhi√™n li·ªáu',
                'KT h·ªá th·ªëng x·∫£', 'V·ªá sinh kim phun', 'KT & thay n∆∞·ªõc l√†m m√°t',
            ]},
            { km: 45000, level: 'C·∫•p 1', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 50000, level: 'C·∫•p 2', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh ho·∫∑c thay l·ªçc gi√≥ ƒë·ªông c∆°',
                'KT t√¨nh tr·∫°ng ·∫Øc quy', 'KT h·ªá th·ªëng phanh (m√° phanh, ƒëƒ©a phanh)', 'KT l·ªçc gi√≥ ƒëi·ªÅu h√≤a',
                'KT h·ªá th·ªëng treo v√† l√°i', 'KT d·∫ßu h·ªôp s·ªë (n·∫øu c√≥)',
            ]},
            { km: 55000, level: 'C·∫•p 1', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'V·ªá sinh l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
            ]},
            { km: 60000, level: 'C·∫•p 4+', items: [
                'KT & thay d·∫ßu ƒë·ªông c∆°', 'KT & thay l·ªçc d·∫ßu', 'KT m·ª±c n∆∞·ªõc l√†m m√°t, d·∫ßu phanh, d·∫ßu tr·ª£ l·ª±c l√°i',
                'KT √°p su·∫•t l·ªëp', 'KT ƒë√®n chi·∫øu s√°ng, c√≤i, g·∫°t m∆∞a', 'Thay l·ªçc gi√≥ ƒë·ªông c∆°', 'KT t√¨nh tr·∫°ng ·∫Øc quy',
                'KT & thay th·∫ø m√° phanh, ƒëƒ©a phanh n·∫øu c·∫ßn', 'Thay l·ªçc gi√≥ ƒëi·ªÅu h√≤a', 'KT h·ªá th·ªëng treo v√† l√°i',
                'Thay d·∫ßu h·ªôp s·ªë', 'Thay bugi', 'KT & thay d√¢y ƒëai truy·ªÅn ƒë·ªông', 'KT h·ªá th·ªëng nhi√™n li·ªáu',
                'KT h·ªá th·ªëng x·∫£', 'V·ªá sinh kim phun', 'KT & thay n∆∞·ªõc l√†m m√°t',
                'KT & thay d·∫ßu phanh', 'KT & thay d·∫ßu tr·ª£ l·ª±c l√°i',
            ]}
        ];
        const predefinedServiceItems = [
            { stt: '01', hangMuc: 'L·ªëp Xe', level: 'C·∫•p 1' },
            { stt: '02', hangMuc: 'ƒê·∫£o l·ªëp', level: 'C·∫•p 1' },
            { stt: '03', hangMuc: 'C√¢n b·∫±ng ƒë·ªông', level: 'C·∫•p 1' },
            { stt: '04', hangMuc: 'Phanh', level: 'C·∫•p 1' },
            { stt: '05', hangMuc: 'D·∫ßu ƒë·ªông c∆°', level: 'C·∫•p 1' },
            { stt: '06', hangMuc: 'L·ªçc d·∫ßu ƒë·ªông c∆°', level: 'C·∫•p 1' },
            { stt: '07', hangMuc: 'L·ªçc gi√≥ ƒë·ªông c∆°', level: 'C·∫•p 1' },
            { stt: '08', hangMuc: 'L·ªçc gi√≥ m√°y l·∫°nh', level: 'C·∫•p 1' },
            { stt: '09', hangMuc: 'D·∫ßu phanh', level: 'C·∫•p 1' },
            { stt: '10', hangMuc: 'N∆∞·ªõc r·ª≠a k√≠nh', level: 'C·∫•p 1' },
            { stt: '11', hangMuc: 'G·∫°t m∆∞a', level: 'C·∫•p 1' },
            { stt: '12', hangMuc: '·∫Æc quy', level: 'C·∫•p 1' },
        ];
        // H√†m g·ªôp danh s√°ch h·∫°ng m·ª•c c·ªë ƒë·ªãnh v√† ƒë·ªông
        function mergeServiceItems(selectedKm = null) {
            const mergedItems = [...predefinedServiceItems]; // Ch·ªâ l·∫•y 12 h·∫°ng m·ª•c c·ªë ƒë·ªãnh

            if (selectedKm !== null) {
                const milestone = maintenanceMilestones.find(m => m.km === selectedKm);
                if (milestone) {
                    milestone.items.forEach(item => {
                        const normalizedItem = normalizeItemName(item);
                        const existingItem = mergedItems.find(m => normalizeItemName(m.hangMuc) === normalizedItem);
                        if (!existingItem) {
                            mergedItems.push({
                                stt: String(mergedItems.length + 1).padStart(2, '0'),
                                hangMuc: item,
                                level: milestone.level
                            });
                        } else {
                            const levels = ['KT ƒë·∫ßu ti√™n (1 th√°ng)', 'C·∫•p 1', 'C·∫•p 2', 'C·∫•p 2+', 'C·∫•p 3', 'C·∫•p 4', 'C·∫•p 4+'];
                            const currentLevelIndex = levels.indexOf(existingItem.level);
                            const newLevelIndex = levels.indexOf(milestone.level);
                            if (newLevelIndex > currentLevelIndex) {
                                existingItem.level = milestone.level;
                            }
                        }
                    });
                }
            }

            // C·∫≠p nh·∫≠t STT
            mergedItems.forEach((item, index) => {
                item.stt = String(index + 1).padStart(2, '0');
            });
            return mergedItems;
        }

        // H√†m chu·∫©n h√≥a t√™n h·∫°ng m·ª•c
        function normalizeItemName(item) {
            return item.toLowerCase().trim().replace(/\s+/g, ' ');
        }

        // H√†m x√°c ƒë·ªãnh tr·∫°ng th√°i I/A/R
        function determineStatus(hangMuc, selectedKm = null) {
            if (!selectedKm) return 'I';
            const milestone = maintenanceMilestones.find(m => m.km === selectedKm);
            if (!milestone) return 'I';

            const item = milestone.items.find(i => normalizeItemName(i) === normalizeItemName(hangMuc));
            if (!item) return 'I';

            if (item.includes('Thay')) return 'R';
            if (item.includes('V·ªá sinh') || item.includes('C√¢n b·∫±ng') || item.includes('C√¢n ch·ªânh')) return 'A';
            return 'I';
        }

        // H√†m t·∫°o m·ªôt h√†ng d·ªãch v·ª•
        function createServiceRow(stt, hangMuc, dienGiai = '', soLuong = '', donGia = '', thanhTien = '', xacNhan = false, status = '') {
            const row = document.createElement('tr');
            const namePrefix = `service_${stt}`;

            row.innerHTML = `
                <td>${stt}</td>
                <td class="hang-muc"><input type="text" class="hang-muc-input" name="${namePrefix}_hangMuc" value="${hangMuc}" readonly></td>
                <td><input type="text" class="dien-giai-input" name="${namePrefix}_dienGiai" value="${dienGiai}"></td>
                <td><input type="number" step="any" class="sl-input" name="${namePrefix}_soLuong" value="${soLuong}" oninput="calculateRowTotal(this)"></td>
                <td><input type="number" step="any" class="don-gia-input" name="${namePrefix}_donGia" value="${donGia}" oninput="calculateRowTotal(this)"></td>
                <td><input type="text" class="thanh-tien-input" name="${namePrefix}_thanhTien" value="${thanhTien}" readonly></td>
                <td class="xac-nhan-col"><input type="checkbox" name="${namePrefix}_xacNhan" value="X" ${xacNhan ? 'checked' : ''}></td>
                <td class="status-col">${status}</td>
            `;
            return row;
        }

        // H√†m populate b·∫£ng d·ªãch v·ª•
        function populateServiceTable(selectedKm = null) {
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = '';

            const mergedItems = mergeServiceItems(selectedKm);
            mergedItems.forEach(item => {
                const status = determineStatus(item.hangMuc, selectedKm);
                const row = createServiceRow(
                    item.stt,
                    item.hangMuc,
                    '',
                    '',
                    '',
                    '',
                    false,
                    status
                );
                tbody.appendChild(row);
            });
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            totalRow.innerHTML = `
                <td colspan="5">T·ªîNG C·ªòNG</td>
                <td><input type="text" id="grand-total" name="tongCong" readonly style="font-weight: bold;"></td>
                <td colspan="2"></td>
            `;
            tbody.appendChild(totalRow);

            loadFormDataForTableInputs();
            updateGrandTotal();
        }

        // H√†m t√≠nh t·ªïng ti·ªÅn
        function calculateRowTotal(inputElement) {
            const row = inputElement.closest('tr');
            const quantity = parseFloat(row.querySelector('.sl-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.don-gia-input').value) || 0;
            const total = quantity * unitPrice;
            row.querySelector('.thanh-tien-input').value = total.toLocaleString('vi-VN');
            updateGrandTotal();
            saveFormData();
        }

        // H√†m c·∫≠p nh·∫≠t t·ªïng c·ªông
        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.thanh-tien-input').forEach(input => {
                const value = parseFloat(input.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
                grandTotal += value;
            });
            document.getElementById('grand-total').value = grandTotal.toLocaleString('vi-VN');
        }

        // H√†m l∆∞u d·ªØ li·ªáu form
        function saveFormData() {
            const form = document.getElementById('serviceReceiptForm');
            if (!form) return;

            const formData = {};
            const inputs = form.querySelectorAll('input:not([readonly]), textarea, select');
            inputs.forEach(input => {
                if (input.name) {
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked;
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value;
                        }
                    } else {
                        formData[input.name] = input.value;
                    }
                }
            });
            localStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData));
        }

        // H√†m t·∫£i d·ªØ li·ªáu form
        function loadFormData() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData);
            const form = document.getElementById('serviceReceiptForm');
            if (!form) return;
            for (const name in formData) {
                const elements = form.querySelectorAll(`[name="${name}"]`);
                elements.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = formData[name];
                    } else if (input.type === 'radio') {
                        if (input.value === formData[name]) {
                            input.checked = true;
                        }
                    } else {
                        input.value = formData[name];
                    }
                });
            }
            updateGrandTotal();
            updateMaintenanceLevelRecommendation();
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            if (maintenanceLevelSelect.value) {
                populateServiceTable(parseInt(maintenanceLevelSelect.value));
            } else {
                populateServiceTable();
            }
        }

        // H√†m t·∫£i d·ªØ li·ªáu b·∫£ng
        function loadFormDataForTableInputs() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;
            const formData = JSON.parse(savedData);

            document.querySelectorAll('.detailed-service input[name], .detailed-service textarea[name]').forEach(input => {
                if (formData[input.name] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = formData[input.name];
                    } else {
                        input.value = formData[input.name];
                    }
                }
            });
        }

        // H√†m kh·ªüi t·∫°o s·ªë phi·∫øu
        function initializeReceiptNumber() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                const parsedMonthData = JSON.parse(storedMonthData);
                lastStoredMonth = parsedMonthData.month;
                lastStoredYear = parsedMonthData.year;
                if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                    receiptNumber = 1;
                    localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                    localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                }
            } else {
                receiptNumber = 1;
                localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
            }

            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // H√†m tƒÉng s·ªë phi·∫øu
        function incrementReceiptNumberOnPrint() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                const parsedMonthData = JSON.parse(storedMonthData);
                lastStoredMonth = parsedMonthData.month;
                lastStoredYear = parsedMonthData.year;
                if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                    receiptNumber = 1;
                } else {
                    receiptNumber++;
                }
            }

            localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
            localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // H√†m reset form
        function resetFormAndLocalStorage() {
            const formElement = document.getElementById('serviceReceiptForm');
            const receivedDateTimeInput = document.getElementById('receivedDateTime');
            const expectedDeliveryTimeInput = document.getElementById('expectedDeliveryTime');
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            const oldOdometerInput = document.getElementById('oldOdometer');
            const currentOdometerInput = document.getElementById('currentOdometer');
            localStorage.removeItem(FORM_DATA_KEY);
            formElement.reset();
            initializeReceiptNumber();
            receivedDateTimeInput.value = getCurrentDateTimeLocal();
            expectedDeliveryTimeInput.value = '';
            oldOdometerInput.value = '';
            currentOdometerInput.value = '';
            populateMaintenanceLevels();
            maintenanceLevelSelect.value = '';
            populateServiceTable();
            updateGrandTotal();
            hasSubmitted = false;
            alert('Form ƒë√£ ƒë∆∞·ª£c x√≥a v√† reset th√†nh c√¥ng!');
        }

        // H√†m l·∫•y ng√†y gi·ªù hi·ªán t·∫°i
        function getCurrentDateTimeLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        }

        // H√†m l·∫•y c·∫•p ƒë·ªô b·∫£o d∆∞·ª°ng khuy·∫øn ngh·ªã
        function getRecommendedMaintenanceLevel(currentKm) {
            if (isNaN(currentKm) || currentKm <= 0) {
                return null;
            }
            let recommendedKm = null;
            for (let i = maintenanceMilestones.length - 1; i >= 0; i--) {
                if (currentKm >= maintenanceMilestones[i].km) {
                    recommendedKm = maintenanceMilestones[i].km;
                    break;
                }
            }
            return recommendedKm;
        }

        // H√†m populate dropdown c·∫•p ƒë·ªô
        function populateMaintenanceLevels(recommendedKm = null, selectedValue = '') {
            const selectElement = document.getElementById('maintenanceLevel');
            selectElement.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Ch·ªçn c·∫•p ƒë·ªô --';
            selectElement.appendChild(defaultOption);
            maintenanceMilestones.forEach(milestone => {
                const option = document.createElement('option');
                option.value = milestone.km;
                option.textContent = `${milestone.level} (${milestone.km} km)`;
                if (milestone.km === recommendedKm) {
                    option.textContent += ' (khuy·∫øn kh√≠ch)';
                    option.classList.add('recommended-option');
                }
                selectElement.appendChild(option);
            });
            if (selectedValue) {
                selectElement.value = selectedValue;
            } else if (recommendedKm) {
                selectElement.value = recommendedKm;
            }
            if (!selectElement.value && selectElement.options.length > 0) {
                selectElement.value = '';
            }
        }

        // H√†m c·∫≠p nh·∫≠t g·ª£i √Ω c·∫•p ƒë·ªô
        function updateMaintenanceLevelRecommendation() {
            const currentOdometerValue = parseFloat(document.getElementById('currentOdometer').value.replace(/\./g, '')) || 0;
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            const currentSelectedLevel = maintenanceLevelSelect.value;

            let recommendedKm = null;
            if (currentOdometerValue > 0) {
                recommendedKm = getRecommendedMaintenanceLevel(currentOdometerValue);
            }
            
            populateMaintenanceLevels(recommendedKm, currentSelectedLevel);
            saveFormData();
        }

        let hasSubmitted = false;
        document.addEventListener('DOMContentLoaded', () => {
            initializeReceiptNumber();
            document.getElementById('receivedDateTime').value = getCurrentDateTimeLocal();
            populateServiceTable();
            populateMaintenanceLevels();
            loadFormData();
            getClosestBranch(); // Attempt to get and set closest branch on load

            const form = document.getElementById('serviceReceiptForm');
            if (form) {
                form.addEventListener('input', saveFormData);
                form.addEventListener('change', saveFormData);
            }

            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            if (maintenanceLevelSelect) {
                maintenanceLevelSelect.addEventListener('change', () => {
                    const selectedKm = maintenanceLevelSelect.value ? parseInt(maintenanceLevelSelect.value) : null;
                    populateServiceTable(selectedKm);
                    saveFormData();
                });
            }

            const oldOdometerInput = document.getElementById('oldOdometer');
            const currentOdometerInput = document.getElementById('currentOdometer');
            if (oldOdometerInput) {
                oldOdometerInput.addEventListener('input', updateMaintenanceLevelRecommendation);
            }
            if (currentOdometerInput) {
                currentOdometerInput.addEventListener('input', updateMaintenanceLevelRecommendation);
            }

            const submitButton = document.getElementById('submitToSheet');
            if (submitButton) {
                submitButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    const scriptURL = form.action;

                    if (!form.checkValidity()) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc tr∆∞·ªõc khi g·ª≠i!');
                        form.reportValidity();
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = 'ƒêang g·ª≠i...';

                    const urlEncodedData = collectFormDataAsUrlEncoded(form);
                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData
                    })
                    .then(response => response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(String(data.message || 'L·ªói t·ª´ m√°y ch·ªß kh√¥ng x√°c ƒë·ªãnh.'));
                        }
                        return data;
                    }))
                    .then(data => {
                        if (data.result === 'success') {
                            alert('‚úÖ G·ª≠i th√¥ng tin th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ in phi·∫øu.');
                            hasSubmitted = true;
                        } else {
                            alert('‚ùå Kh√¥ng g·ª≠i ƒë∆∞·ª£c: ' + String(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ Apps Script.'));
                        }
                    })
                    .catch(error => {
                        alert('‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i. Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                        console.error('L·ªói:', error);
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = 'üì§ G·ª≠i Th√¥ng Tin';
                    });
                });
            }

            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (!hasSubmitted) {
                        alert('Vui l√≤ng nh·∫•n "G·ª≠i Th√¥ng Tin" tr∆∞·ªõc khi in phi·∫øu!');
                        return;
                    }
                    incrementReceiptNumberOnPrint();
                    window.print();
                });
            }

            const clearFormButton = document.getElementById('clearFormButton');
            if (clearFormButton) {
                clearFormButton.addEventListener('click', () => {
                    showCustomConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô th√¥ng tin tr√™n form kh√¥ng? (Ch·ªâ x√≥a sau khi ƒë√£ in th√†nh c√¥ng)', () => {
                        resetFormAndLocalStorage();
                    });
                });
            }
        });

        function collectFormDataAsUrlEncoded(formElement) {
            const params = new URLSearchParams();
            const formElements = formElement.querySelectorAll('input[name], textarea[name], select[name]');
            formElements.forEach(element => {
                let name = element.name;
                let value;
                if (element.type === 'checkbox') {
                    value = element.checked ? 'on' : '';
                } else if (element.type === 'radio') {
                    if (element.checked) {
                        value = element.value;
                    } else {
                        return;
                    }
                } else {
                    value = element.value;
                }
                let safeValue = value + '';
                if (name.endsWith('_thanhTien')) {
                    safeValue = safeValue.replace(/\./g, '').replace(/,/g, '.');
                } else if (name.endsWith('_xacNhan')) {
                    safeValue = (element.type === 'checkbox' && element.checked) ? 'X' : '';
                } else if (name === 'sokmcu' || name === 'sokmhientai') {
                    safeValue = safeValue.replace(/\./g, '');
                }
                params.append(name, safeValue);
            });

            formElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked && !params.has(checkbox.name)) {
                    params.append(checkbox.name, '');
                }
            });
            const radioGroupNames = new Set();
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroupNames.add(radio.name));
            radioGroupNames.forEach(groupName => {
                const checkedRadioInGroup = formElement.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (!checkedRadioInGroup && !params.has(groupName)) {
                    params.append(groupName, '');
                }
            });
            params.append('formType', formElement.querySelector('[name="formType"]').value);
            params.append('receiptNumber', document.getElementById('receiptNumber')?.textContent || '');
            params.append('currentMonthYear', document.getElementById('currentMonth')?.textContent || '');

            return params.toString();
        }

        function showCustomConfirm(message, onConfirm) {
            const modalId = 'customConfirmModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                    position: fixed; left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000; font-family: Arial, sans-serif;
                `;
                modal.innerHTML = `
                    <div style="
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        text-align: center;
                        max-width: 400px;
                        width: 90%;
                    ">
                        <p style="margin-bottom: 20px; font-size: 16px;">${message}</p>
                        <button id="confirmYes" style="
                            padding: 10px 20px;
                            margin: 0 10px;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                            background-color: #007bff;
                            color: white;
                        ">ƒê·ªìng √Ω</button>
                        <button id="confirmNo" style="
                            padding: 10px 20px; margin: 0 10px;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                            background-color: #6c757d;
                            color: white;
                        ">H·ªßy</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('confirmYes').onclick = () => {
                    onConfirm();
                    modal.style.display = 'none';
                };
                document.getElementById('confirmNo').onclick = () => {
                    modal.style.display = 'none';
                };
            } else {
                modal.querySelector('p').textContent = message;
                modal.style.display = 'flex';
                document.getElementById('confirmYes').onclick = () => {
                    onConfirm();
                    modal.style.display = 'none';
                };
            }
            modal.style.display = 'flex';
        }
    </script>
</body>
</html>
