<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Nhận Dịch Vụ - PHI LONG AUTO</title>
    
    <style>
        /* Reset CSS cho tất cả các phần tử */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Định nghĩa font chữ, kích thước chữ, màu sắc và nền cho toàn bộ trang */
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: #f5f5f5;
            padding: 20px;
        }

        /* Container chính của phiếu, giới hạn chiều rộng và tạo bóng đổ */
        .container {
            max-width: 230mm; /* Kích thước A4 theo chiều ngang để chứa đủ các nút */
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* Vùng nội dung chính của form, thiết lập khoảng cách lề */
        .form-content {
            padding: 15mm; /* Khoảng cách lề trong phiếu */
        }

        /* Phần Header của phiếu: Logo, tiêu đề, số phiếu */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        /* Tiêu đề chính của phiếu */
        .header-left h1 {
            font-size: 24px;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 5px;
        }

        /* Định dạng số phiếu */
        .form-number {
            font-size: 16px;
            font-weight: bold;
        }

        /* Phần bên phải header chứa logo */
        .header-right {
            text-align: right;
        }

        /* Định dạng logo */
        .logo {
            width: 80px;
            height: 60px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
        }

        /* Phần thông tin khách hàng và xe: Chia làm 2 cột */
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        /* Nhóm các input field (label và input) */
        .info-group {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Định dạng nhãn (label) của input */
        .info-group label {
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }

        /* Định dạng chung cho các input text */
        .info-group .info-input {
            border: none;
            border-bottom: 1px dotted #000; /* Đường gạch dưới dạng chấm */
            flex-grow: 1; /* Cho phép input mở rộng để lấp đầy không gian */
            padding: 0 5px;
            font-size: 12px;
            min-width: 50px;
        }
        /* Định nghĩa chiều rộng tối thiểu cho các loại input khác nhau */
        .info-group .info-input.name-input { min-width: 150px; }
        .info-group .info-input.phone-email-input { min-width: 90px; }
        .info-group .info-input.datetime-input { min-width: 130px; }
        .info-group .info-input.car-type-input { min-width: 150px; }
        .info-group .info-input.license-km-input { min-width: 90px; }

        /* Phần yêu cầu khách hàng và chẩn đoán ban đầu */
        .request-details {
            margin-bottom: 13px;
            border: 1px solid #000;
            padding: 9px;
        }

        /* Tiêu đề cho các phần con (ví dụ: Yêu cầu khách hàng) */
        .section-title {
            background: #003366;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            margin: -10px -10px 10px -10px; /* Tạo hiệu ứng tràn ra ngoài lề của request-details */
        }

        /* Nhóm các textarea (label và textarea) */
        .request-group {
            margin-bottom: 10px;
        }

        /* Định dạng nhãn (label) của textarea */
        .request-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        /* Định dạng textarea */
        .request-group textarea {
            width: 100%;
            border: 1px dotted #000;
            padding: 5px;
            resize: vertical; /* Cho phép thay đổi kích thước theo chiều dọc */
            min-height: 50px;
            font-size: 12px;
        }

        /* Bảng chi tiết dịch vụ/vật tư */
        .detailed-service {
            margin-top: 15px;
            width: 100%;
            border-collapse: collapse; /* Các đường viền liền nhau */
            border: 2px solid #000;
        }

        /* Định dạng chung cho tiêu đề bảng và ô dữ liệu */
        .detailed-service th,
        .detailed-service td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 11px;
        }

        /* Định dạng tiêu đề bảng chính */
        .detailed-service th {
            background: #003366;
            color: white;
            font-weight: bold;
        }

        /* Chiều rộng cố định cho các cột */
        .detailed-service .stt { width: 30px; }
        .detailed-service .hang-muc { width: 120px; text-align: left; font-weight: bold;}
        .detailed-service .dien-giai { width: 180px; }
        .detailed-service .sl { width: 50px; }
        .detailed-service .don-gia, .detailed-service .thanh-tien { width: 90px; }
        .detailed-service .xac-nhan-col { width: 60px; }
        .detailed-service .cap-do-col { width: 60px; } /* Thêm cột cấp độ */


        /* Định dạng input text và number trong bảng */
        .detailed-service input[type="text"],
        .detailed-service input[type="number"] {
            width: 100%;
            border: none;
            text-align: center;
            padding: 2px 0;
            font-size: 11px;
            background: transparent;
        }
        /* Căn trái và in đậm cho cột hạng mục trong bảng */
        .detailed-service input[type="text"].hang-muc-input {
            text-align: left;
            font-weight: bold;
        }
        /* Định dạng checkbox trong bảng */
        .detailed-service input[type="checkbox"] {
            width: 15px;
            height: 15px;
            margin: 0 auto;
            display: block;
            vertical-align: middle;
        }

        /* Định dạng hàng tổng cộng */
        .total-row {
            background: #ccc;
            font-weight: bold;
        }

        /* Tiêu đề danh mục trong bảng (ví dụ: Level 1, Level 2) */
        .category-header th {
            background: #e0e0e0; /* Màu nền xám nhạt */
            color: #000;
            font-weight: bold;
            text-align: left;
            padding: 5px 10px;
            border: 1px solid #000;
            font-size: 12px;
        }

        /* Phần chữ ký */
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 20px;
            padding-top: 15px;
        }

        /* Khung chứa mỗi chữ ký (Đại lý, Khách hàng) */
        .signature-box { text-align: center; }

        /* Tiêu đề "Đại lý" / "Khách hàng" */
        .signature-title {
            font-weight: bold;
            margin-bottom: 30px;
        }

        /* Input để nhập tên người ký */
        .signature-input {
            border: none;
            border-bottom: 1px dotted #000;
            width: 100%;
            text-align: center;
            padding: 2px 0;
            font-size: 12px;
            margin-top: -20px; /* Điều chỉnh vị trí input lên cao hơn để chữ ký nằm gần dòng */
        }

        /* Chú thích "(Ký tên)" */
        .signature-subtitle {
            font-size: 10px;
            font-style: italic;
        }

        /* Phần chân trang */
        .footer {
            margin-top: 15px;
            font-size: 9px;
            line-height: 1.2;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        /* Nhóm các nút chức năng ở đầu trang */
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Cho phép các nút xuống dòng trên màn hình nhỏ */
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Định dạng chung cho tất cả các nút */
        .app-button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap; /* Ngăn văn bản trong nút bị xuống dòng */
            flex-shrink: 0; /* Ngăn nút bị co lại */
            background: #28a745; /* Màu xanh lá cây */
            color: white;
        }

        /* Hiệu ứng hover cho nút */
        .app-button:hover { background: #218838; }

        /* Màu sắc riêng cho nút In */
        .print-button {
            background: #007bff; /* Màu xanh dương */
        }
        .print-button:hover { background: #0056b3; }

        /* Màu sắc riêng cho nút Xóa Form */
        .clear-button {
            background: #dc3545; /* Màu đỏ */
        }
        .clear-button:hover { background: #c82333; }

        /* Style for recommended option in dropdown */
        .recommended-option {
            background-color: #e6f7ff; /* Light blue background */
            font-weight: bold;
            color: #0056b3; /* Darker blue text */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button class="app-button print-button" id="printButton">🖨️ In Phiếu</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/tracuu.html'">📄 Tra cứu thông tin xe </button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra'">📄 Phiếu Kiểm Tra Xe </button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/phieu_kiem_tra_lop.html'">📄 Phiếu Kiểm Tra Lốp</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/kiemtragam.html'">📄 Phiếu Kiểm Gầm</button>
            <button class="app-button" onclick="window.location.href='https://longvt89.github.io/phieukiemtra/baoduong.html'">📄 Phiếu Bảo Dưỡng</button>
            <button class="app-button" id="submitToSheet">📤 Gửi Thông Tin</button>
            <button class="app-button clear-button" id="clearFormButton">🗑️ Xóa Form</button>
        </div>
        
        <div class="form-content">
            <form id="serviceReceiptForm" action="https://script.google.com/macros/s/AKfycbzE44UQR_Mu1M9vAxnY6SmrHq-2hTPIr1I-0rpTztwPoN-PoEL0psVLvXb8HY746mRz/exec" method="POST">
                <input type="hidden" name="formType" value="PhieuNhanDichVu">

                <div class="header">
                    <div class="header-left">
                        <h1>PHIẾU NHẬN DỊCH VỤ</h1>
                        <div class="form-number">№ <span id="receiptNumber"></span> / <span id="currentMonth"></span></div>
                    </div>
                    <div class="header-right">
                        <div class="logo">
                            <img src="https://longvt89.github.io/phieukiemtra/logophilong.jpg" alt="Logo Phi Long Auto" style="height: 90px;">
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-left">
                        <div class="info-group">
                            <label for="customerName">Họ tên khách hàng:</label>
                            <input type="text" id="customerName" name="hoten" class="info-input name-input" required>
                        </div>
                        <div class="info-group">
                            <label for="customerPhone">Số điện thoại:</label>
                            <input type="tel" id="customerPhone" name="dienthoai" class="info-input phone-email-input" required>
                        </div>
                        <div class="info-group">
                            <label for="carModel">Hãng/Đời xe:</label>
                            <input type="text" id="carModel" name="hangXe" class="info-input car-type-input" required>
                        </div>
                        <div class="info-group">
                            <label for="licensePlate">Biển số xe:</label>
                            <input type="text" id="licensePlate" name="bienso" class="info-input license-km-input" required>
                        </div>
                    </div>
                    <div class="info-right">
                        <div class="info-group">
                            <label for="receptionist">Người tiếp nhận:</label>
                            <input type="text" list="receptionistList" id="receptionist" name="nguoiTiepNhan" class="info-input name-input">
                            <datalist id="receptionistList">
                                <option value="Cao Thanh Duy">
                                <option value="Trần Ngọc Hào">
                                <option value="Nguyễn Phước Hiếu">
                                <option value="Nguyễn Trung Kiên">
                            </datalist>
                        </div>
                        <div class="info-group">
                            <label for="receivedDateTime">Ngày giờ nhận xe:</label>
                            <input type="datetime-local" id="receivedDateTime" name="nhanxe" class="info-input datetime-input" required>
                        </div>
                        <div class="info-group">
                            <label for="expectedDeliveryTime">Ngày giờ dự kiến giao:</label>
                            <input type="datetime-local" id="expectedDeliveryTime" name="duKienGiaoXe" class="info-input datetime-input">
                        </div>
                        <!-- Thêm trường số KM cũ -->
                        <div class="info-group">
                            <label for="oldOdometer">Số KM cũ:</label>
                            <input type="text" id="oldOdometer" name="sokmcu" class="info-input license-km-input">
                        </div>
                        <div class="info-group">
                            <label for="currentOdometer">Số KM hiện tại:</label>
                            <input type="text" id="currentOdometer" name="sokmhientai" class="info-input license-km-input">
                        </div>
                        <!-- Thêm trường chọn cấp độ bảo dưỡng -->
                        <div class="info-group">
                            <label for="maintenanceLevel">Cấp độ bảo dưỡng:</label>
                            <select id="maintenanceLevel" name="capDoBaoDuong" class="info-input">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="request-details">
                    <div class="section-title">YÊU CẦU CỦA KHÁCH HÀNG & CHẨN ĐOÁN BAN ĐẦU</div>
                    <div class="request-group">
                        <label for="customerRequest">Yêu cầu của khách hàng:</label>
                        <textarea id="customerRequest" name="yeuCauKhachHang" placeholder="Mô tả các vấn đề hoặc dịch vụ khách hàng yêu"></textarea>
                    </div>
                    <div class="request-group">
                        <label for="initialDiagnosis">Chẩn đoán ban đầu:</label>
                        <textarea id="initialDiagnosis" name="chanDoanBanDau" placeholder="Mô tả chẩn đoán ban đầu của kỹ thuật viên"></textarea>
                    </div>
                </div>

                <table class="detailed-service">
                    <thead>
                        <tr>
                            <th class="stt">STT</th>
                            <th class="hang-muc">HẠNG MỤC DỊCH VỤ/VẬT TƯ</th>
                            <th class="dien-giai">DIỄN GIẢI</th>
                            <th class="sl">SL</th>
                            <th class="don-gia">ĐƠN GIÁ</th>
                            <th class="thanh-tien">THÀNH TIỀN</th>
                            <th class="xac-nhan-col">XÁC NHẬN</th>
                            <th class="cap-do-col">CẤP ĐỘ</th> <!-- Thêm cột CẤP ĐỘ -->
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        <!-- Các hàng sẽ được tạo bởi JavaScript -->
                    </tbody>
                </table>

                <div class="request-details" style="margin-top: 15px;">
                    <div class="section-title">GHI CHÚ</div>
                    <div class="request-group">
                        <label for="generalNotes">Ghi chú chung:</label>
                        <textarea id="generalNotes" name="ghiChuChung" placeholder="Các ghi chú hoặc yêu cầu đặc biệt khác"></textarea>
                    </div>
                </div>

                <div class="footer">
                    <p><strong>Khuyến nghị:</strong></p>
                    <p>□ "Tôi đồng ý đăng ký số liệu cá nhân được cung cấp theo mẫu này có thể được lưu trữ và sử dụng cho mục đích liên quan đến PHI LONG AUTO (Công Ty), nhằm mục đích truyền thông sản phẩm và dịch vụ của chúng tôi và các đối tác kinh doanh liên quan. Tôi có thể rút lại sự đồng ý của mình bất cứ lúc nào bằng cách liên hệ với Công Ty và yêu cầu loại bỏ thông tin cá nhân của tôi khỏi cơ sở dữ liệu này."</p>
                </div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">Đại lý</div>
                        <input type="text" list="receptionistList" class="signature-input" name="daiLyPhuTrach" placeholder="Chọn hoặc nhập tên">
                        <div class="signature-subtitle">(Ký tên)</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Khách hàng</div>
                        <input type="text" class="signature-input" name="khachHangKyTen" placeholder="Ký tên">
                        <div class="signature-subtitle">(Ký tên)</div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Các hằng số key cho Local Storage để lưu trạng thái form và số phiếu
        const RECEIPT_NUMBER_KEY = 'serviceReceipt_receiptNumber';
        const LAST_MONTH_KEY = 'serviceReceipt_lastMonth';
        const FORM_DATA_KEY = 'serviceReceipt_formData';

        // Cấu trúc dữ liệu quy định bảo dưỡng dựa trên hình ảnh bạn đã cung cấp
        const maintenanceMilestones = [
            { km: 1000, level: 'Kiểm tra đầu tiên (1 tháng)', items: [
                'Kiểm tra tổng thể xe', 'Kiểm tra mức dầu động cơ', 'Kiểm tra mức nước làm mát',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn, còi, gạt mưa'
            ]},
            { km: 5000, level: 'Cấp 1', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
            ]},
            { km: 10000, level: 'Cấp 2', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh hoặc thay lọc gió động cơ',
                'Kiểm tra tình trạng ắc quy', 'Kiểm tra hệ thống phanh (má phanh, đĩa phanh)', 'Kiểm tra lọc gió điều hòa',
                'Kiểm tra hệ thống treo và lái', 'Kiểm tra dầu hộp số (nếu có)',
            ]},
            { km: 15000, level: 'Cấp 1', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
            ]},
            { km: 20000, level: 'Cấp 3', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Thay lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
                'Kiểm tra hệ thống phanh (má phanh, đĩa phanh)', 'Thay lọc gió điều hòa', 'Kiểm tra hệ thống treo và lái',
                'Kiểm tra dầu hộp số', 'Kiểm tra bugi (nếu đến hạn thay)', 'Kiểm tra dây đai truyền động',
            ]},
            { km: 25000, level: 'Cấp 1', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
            ]},
            { km: 30000, level: 'Cấp 2', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh hoặc thay lọc gió động cơ',
                'Kiểm tra tình trạng ắc quy', 'Kiểm tra hệ thống phanh (má phanh, đĩa phanh)', 'Kiểm tra lọc gió điều hòa',
                'Kiểm tra hệ thống treo và lái', 'Kiểm tra dầu hộp số (nếu có)',
            ]},
            { km: 35000, level: 'Cấp 1', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
            ]},
            { km: 40000, level: 'Cấp 4', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Thay lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
                'Kiểm tra và thay thế má phanh, đĩa phanh nếu cần', 'Thay lọc gió điều hòa', 'Kiểm tra hệ thống treo và lái',
                'Thay dầu hộp số', 'Thay bugi', 'Kiểm tra và thay dây đai truyền động', 'Kiểm tra hệ thống nhiên liệu',
                'Kiểm tra hệ thống xả', 'Vệ sinh kim phun', 'Kiểm tra và thay nước làm mát',
            ]},
            { km: 45000, level: 'Cấp 1', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
            ]},
            { km: 50000, level: 'Cấp 2', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh hoặc thay lọc gió động cơ',
                'Kiểm tra tình trạng ắc quy', 'Kiểm tra hệ thống phanh (má phanh, đĩa phanh)', 'Kiểm tra lọc gió điều hòa',
                'Kiểm tra hệ thống treo và lái', 'Kiểm tra dầu hộp số (nếu có)',
            ]},
            { km: 55000, level: 'Cấp 1', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Vệ sinh lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
            ]},
            { km: 60000, level: 'Cấp 4+', items: [
                'Kiểm tra và thay dầu động cơ', 'Kiểm tra và thay lọc dầu', 'Kiểm tra mực nước làm mát, dầu phanh, dầu trợ lực lái',
                'Kiểm tra áp suất lốp', 'Kiểm tra đèn chiếu sáng, còi, gạt mưa', 'Thay lọc gió động cơ', 'Kiểm tra tình trạng ắc quy',
                'Kiểm tra và thay thế má phanh, đĩa phanh nếu cần', 'Thay lọc gió điều hòa', 'Kiểm tra hệ thống treo và lái',
                'Thay dầu hộp số', 'Thay bugi', 'Kiểm tra và thay dây đai truyền động', 'Kiểm tra hệ thống nhiên liệu',
                'Kiểm tra hệ thống xả', 'Vệ sinh kim phun', 'Kiểm tra và thay nước làm mát',
                'Kiểm tra và thay dầu phanh', 'Kiểm tra và thay dầu trợ lực lái',
            ]}
        ];

        // Định nghĩa các hạng mục dịch vụ có sẵn và cấp độ mặc định của chúng
        const predefinedServiceItems = [
            // Level 1 - Dịch vụ cơ bản
            { stt: '01', hangMuc: 'Lốp Xe', level: 'Cấp 1' },
            { stt: '02', hangMuc: 'Đảo lốp', level: 'Cấp 1' },
            { stt: '03', hangMuc: 'Cân bằng động', level: 'Cấp 1' },
            { stt: '04', hangMuc: 'Phanh', level: 'Cấp 1' },
            { stt: '05', hangMuc: 'Dầu động cơ', level: 'Cấp 1' },
            { stt: '06', hangMuc: 'Lọc dầu động cơ', level: 'Cấp 1' },
            { stt: '07', hangMuc: 'Lọc gió động cơ', level: 'Cấp 1' },
            { stt: '08', hangMuc: 'Lọc gió máy lạnh', level: 'Cấp 1' },
            { stt: '09', hangMuc: 'Dầu phanh', level: 'Cấp 1' },
            { stt: '10', hangMuc: 'Nước rửa kính', level: 'Cấp 1' },
            { stt: '11', hangMuc: 'Gạt mưa', level: 'Cấp 1' },
            { stt: '12', hangMuc: 'Ắc quy', level: 'Cấp 1' },
            { stt: '13', hangMuc: 'Góc đặt bánh xe / Cân chỉnh lái', level: 'Cấp 1' },
            // Level 2 - Dịch vụ mở rộng
            { stt: '14', hangMuc: 'Rotuyn (lái, trụ)', level: 'Cấp 2' },
            { stt: '15', hangMuc: 'Phuộc', level: 'Cấp 2' },
            { stt: '16', hangMuc: 'Bạc đạn bánh xe', level: 'Cấp 2' },
            { stt: '17', hangMuc: 'Dầu hộp số tự động', level: 'Cấp 2' },
            { stt: '18', hangMuc: 'Dầu vi sai / cầu', level: 'Cấp 2' },
            { stt: '19', hangMuc: 'V-belt / Dây curoa ngoài', level: 'Cấp 2' },
            { stt: '20', hangMuc: 'Bugi R: mỗi 40.000 km với loại thường và 100.000 km với loại điện cực hợp kim', level: 'Cấp 2' },
            { stt: '21', hangMuc: 'Dầu trợ lực lái', level: 'Cấp 2' },
            { stt: '22', hangMuc: 'Lọc nhiên liệu (diesel)', level: 'Cấp 2' },
            { stt: '23', hangMuc: 'Lọc nhiên liệu động cơ xăng', level: 'Cấp 2' },
            { stt: '24', hangMuc: 'Bóng đèn', level: 'Cấp 2' },
            // Level 2 Dịch vụ gia tăng giá trị - tăng Trải nghiệm. Khách hàng
            { stt: '25', hangMuc: 'Vệ sinh giàn lạnh', level: 'Cấp 2+' },
            { stt: '26', hangMuc: 'Vệ sinh hệ thống nhiên liệu', level: 'Cấp 2+' },
            { stt: '27', hangMuc: 'Vệ sinh kim phun trực tiếp', level: 'Cấp 2+' },
            { stt: '28', hangMuc: 'Súc rửa động cơ A', level: 'Cấp 2+' },
            { stt: '29', hangMuc: 'Phụ gia nâng cấp nhớt', level: 'Cấp 2+' },
            { stt: '30', hangMuc: 'Vệ sinh họng ga', level: 'Cấp 2+' },
        ];


        // Hàm tính tổng tiền cho một hàng và cập nhật tổng cộng
        function calculateRowTotal(inputElement) {
            const row = inputElement.closest('tr'); // Tìm hàng chứa input
            const quantity = parseFloat(row.querySelector('.sl-input').value) || 0; // Lấy số lượng
            const unitPrice = parseFloat(row.querySelector('.don-gia-input').value) || 0; // Lấy đơn giá
            const total = quantity * unitPrice; // Tính thành tiền
            row.querySelector('.thanh-tien-input').value = total.toLocaleString('vi-VN'); // Hiển thị thành tiền với định dạng VN
            updateGrandTotal(); // Cập nhật tổng cộng
            saveFormData(); // Lưu dữ liệu form vào Local Storage
        }

        // Hàm cập nhật tổng cộng của toàn bộ bảng
        function updateGrandTotal() {
            let grandTotal = 0;
            // Duyệt qua tất cả các input thành tiền
            document.querySelectorAll('.thanh-tien-input').forEach(input => {
                // Parse giá trị đã định dạng (ví dụ: "1.000.000" thành 1000000)
                const value = parseFloat(input.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
                grandTotal += value;
            });
            // Hiển thị tổng cộng cuối cùng với định dạng VN
            document.getElementById('grand-total').value = grandTotal.toLocaleString('vi-VN');
        }

        // Hàm lấy ngày giờ hiện tại theo định dạng local cho input datetime-local
        function getCurrentDateTimeLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Điều chỉnh múi giờ
            return now.toISOString().slice(0, 16); // Trả về định dạng "YYYY-MM-DDTHH:MM"
        }

        // Hàm reset toàn bộ form và xóa dữ liệu đã lưu trong Local Storage
        function resetFormAndLocalStorage() {
            const formElement = document.getElementById('serviceReceiptForm');
            const receivedDateTimeInput = document.getElementById('receivedDateTime');
            const expectedDeliveryTimeInput = document.getElementById('expectedDeliveryTime');
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            const oldOdometerInput = document.getElementById('oldOdometer');
            const currentOdometerInput = document.getElementById('currentOdometer');


            localStorage.removeItem(FORM_DATA_KEY); // Xóa dữ liệu form đã lưu
            formElement.reset(); // Reset tất cả các trường trong form
            initializeReceiptNumber(); // Khởi tạo lại số phiếu
            receivedDateTimeInput.value = getCurrentDateTimeLocal(); // Đặt lại ngày giờ nhận xe hiện tại
            expectedDeliveryTimeInput.value = ''; // Xóa ngày giờ dự kiến giao
            oldOdometerInput.value = ''; // Reset số KM cũ
            currentOdometerInput.value = ''; // Reset số KM hiện tại

            populateMaintenanceLevels(); // Populate lại dropdown cấp độ bảo dưỡng (không có khuyến khích ban đầu)
            maintenanceLevelSelect.value = ''; // Reset cấp độ bảo dưỡng
            populateServiceTable(); // Tải lại bảng dịch vụ (chỉ hiển thị các hạng mục mặc định)
            updateGrandTotal(); // Cập nhật tổng cộng về 0
            hasSubmitted = false; // Đặt lại trạng thái gửi form
            alert('Form đã được xóa và reset thành công!');
        }

        // Hàm khởi tạo số phiếu và cập nhật tháng/năm
        function initializeReceiptNumber() {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;

                    // Nếu tháng hoặc năm thay đổi, reset số phiếu về 1
                    if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                        receiptNumber = 1;
                        localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                        localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                    }
                } catch (e) {
                    console.error("Lỗi khi đọc dữ liệu tháng từ localStorage:", e);
                    // Trường hợp lỗi parse, cũng reset về 1
                    receiptNumber = 1;
                    localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                    localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
                }
            } else {
                // Lần đầu tiên chạy hoặc không có dữ liệu cũ, đặt số phiếu là 1
                receiptNumber = 1;
                localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
                localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));
            }

            // Hiển thị số phiếu và tháng/năm với định dạng 6 chữ số (000001) và MM/YYYY
            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // Hàm tăng số phiếu khi in (giả định mỗi lần in là một phiếu mới)
        function incrementReceiptNumberOnPrint() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let receiptNumber = parseInt(localStorage.getItem(RECEIPT_NUMBER_KEY)) || 0;
            const storedMonthData = localStorage.getItem(LAST_MONTH_KEY);
            let lastStoredMonth = null;
            let lastStoredYear = null;

            if (storedMonthData) {
                try {
                    const parsedMonthData = JSON.parse(storedMonthData);
                    lastStoredMonth = parsedMonthData.month;
                    lastStoredYear = parsedMonthData.year;
                } catch (e) {
                    console.error("Lỗi khi đọc dữ liệu tháng từ localStorage:", e);
                }
            }

            // Nếu tháng hoặc năm thay đổi, reset số phiếu về 1 trước khi tăng
            if (currentMonth !== lastStoredMonth || currentYear !== lastStoredYear) {
                receiptNumber = 1;
            } else {
                receiptNumber++;
            }

            // Lưu lại số phiếu và thông tin tháng/năm mới
            localStorage.setItem(RECEIPT_NUMBER_KEY, receiptNumber);
            localStorage.setItem(LAST_MONTH_KEY, JSON.stringify({ month: currentMonth, year: currentYear }));

            // Cập nhật hiển thị số phiếu trên giao diện
            document.getElementById('receiptNumber').textContent = String(receiptNumber).padStart(6, '0');
            document.getElementById('currentMonth').textContent = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
        }

        // Hàm lưu dữ liệu form vào Local Storage để giữ trạng thái khi tải lại trang
        function saveFormData() {
            const form = document.getElementById('serviceReceiptForm');
            if (!form) return;

            const formData = {};
            // Lấy tất cả input, textarea, select ngoại trừ các input readonly
            const inputs = form.querySelectorAll('input:not([readonly]), textarea, select');

            inputs.forEach(input => {
                if (input.name) { // Chỉ xử lý các phần tử có thuộc tính 'name'
                    if (input.type === 'checkbox') {
                        formData[input.name] = input.checked; // Lưu trạng thái true/false của checkbox
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value; // Lưu giá trị của radio được chọn
                        }
                    } else {
                        formData[input.name] = input.value; // Lưu giá trị của các input khác
                    }
                }
            });
            localStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData)); // Lưu dưới dạng chuỗi JSON
        }

        // Hàm tải dữ liệu đã lưu từ Local Storage và điền vào form
        function loadFormData() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;

            const formData = JSON.parse(savedData); // Parse chuỗi JSON thành đối tượng
            const form = document.getElementById('serviceReceiptForm');
            if (!form) return;

            for (const name in formData) { // Duyệt qua từng trường dữ liệu đã lưu
                const elements = form.querySelectorAll(`[name="${name}"]`);
                if (elements.length > 0) {
                    elements.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = formData[name]; // Khôi phục trạng thái checkbox
                        } else if (input.type === 'radio') {
                            if (input.value === formData[name]) {
                                input.checked = true; // Khôi phục trạng thái radio
                            }
                        } else {
                            input.value = formData[name]; // Khôi phục giá trị input khác
                        }
                    });
                }
            }
            // Sau khi tải dữ liệu, cần cập nhật lại bảng dịch vụ và tổng cộng
            updateGrandTotal();
            
            // Tải giá trị cho oldOdometer và currentOdometer
            const oldOdometerValue = document.getElementById('oldOdometer').value;
            const currentOdometerValue = document.getElementById('currentOdometer').value;

            // Cập nhật gợi ý cấp độ bảo dưỡng sau khi tải dữ liệu
            updateMaintenanceLevelRecommendation(oldOdometerValue, currentOdometerValue);

            // Nếu có cấp độ bảo dưỡng đã chọn, gọi populateServiceTable để hiển thị các hạng mục động
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            if (maintenanceLevelSelect.value) {
                populateServiceTable(parseInt(maintenanceLevelSelect.value));
            } else {
                populateServiceTable(); // Tải bảng mặc định
            }
        }

        // Hàm tạo một hàng dịch vụ trong bảng
        function createServiceRow(stt, hangMuc, dienGiai = '', soLuong = '', donGia = '', thanhTien = '', xacNhan = false, level = '', isDynamic = false) {
            const row = document.createElement('tr');
            const namePrefix = isDynamic ? `dynamic_service_${stt}` : `service_${stt}`; // Tên duy nhất cho các hàng động

            row.innerHTML = `
                <td>${stt}</td>
                <td class="hang-muc"><input type="text" class="hang-muc-input" name="${namePrefix}_hangMuc" value="${hangMuc}" ${isDynamic ? '' : 'readonly'}></td>
                <td><input type="text" class="dien-giai-input" name="${namePrefix}_dienGiai" value="${dienGiai}"></td>
                <td><input type="number" step="any" class="sl-input" name="${namePrefix}_soLuong" value="${soLuong}" oninput="calculateRowTotal(this)"></td>
                <td><input type="number" step="any" class="don-gia-input" name="${namePrefix}_donGia" value="${donGia}" oninput="calculateRowTotal(this)"></td>
                <td><input type="text" class="thanh-tien-input" name="${namePrefix}_thanhTien" value="${thanhTien}" readonly></td>
                <td class="xac-nhan-col"><input type="checkbox" name="${namePrefix}_xacNhan" value="X" ${xacNhan ? 'checked' : ''}></td>
                <td class="cap-do-col">${level}</td>
            `;
            if (isDynamic) {
                row.classList.add('dynamic-row'); // Đánh dấu hàng động để dễ dàng xóa
            }
            return row;
        }

        // Hàm populate bảng dịch vụ với các hạng mục mặc định và hạng mục động (nếu có cấp độ được chọn)
        function populateServiceTable(selectedKm = null) {
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = ''; // Xóa tất cả các hàng hiện có

            let currentStt = 1; // Biến đếm STT

            // Thêm các hạng mục dịch vụ mặc định
            predefinedServiceItems.forEach(item => {
                const row = createServiceRow(
                    String(currentStt++).padStart(2, '0'),
                    item.hangMuc,
                    '', '', '', '', false, item.level, false // isDynamic = false cho các hàng mặc định
                );
                tbody.appendChild(row);
            });

            // Thêm hàng tổng cộng vào cuối các hạng mục mặc định
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            totalRow.innerHTML = `
                <td colspan="5">TỔNG CỘNG</td>
                <td><input type="text" id="grand-total" name="tongCong" readonly style="font-weight: bold;"></td>
                <td colspan="2"></td> <!-- Cập nhật colspan cho cột CẤP ĐỘ -->
            `;
            tbody.appendChild(totalRow);


            // Thêm các hạng mục bảo dưỡng động nếu có cấp độ được chọn
            if (selectedKm !== null) {
                const milestone = maintenanceMilestones.find(m => m.km === selectedKm);
                if (milestone) {
                    // Thêm một tiêu đề cho các hạng mục động
                    const categoryHeaderRow = document.createElement('tr');
                    categoryHeaderRow.classList.add('category-header');
                    categoryHeaderRow.innerHTML = `<th colspan="8">Các hạng mục bảo dưỡng theo cấp độ: ${milestone.level} (${milestone.km} km)</th>`; // Cập nhật colspan
                    tbody.insertBefore(categoryHeaderRow, totalRow); // Chèn trước hàng tổng cộng

                    milestone.items.forEach(item => {
                        const row = createServiceRow(
                            String(currentStt++).padStart(2, '0'),
                            item, // Hạng mục
                            '', '', '', '', false, milestone.level, true // isDynamic = true cho các hàng động
                        );
                        tbody.insertBefore(row, totalRow); // Chèn trước hàng tổng cộng
                    });
                }
            }

            // Sau khi tạo lại bảng, cần tải lại dữ liệu đã lưu cho các trường input
            loadFormDataForTableInputs();
            updateGrandTotal(); // Cập nhật tổng cộng
        }

        // Hàm tải dữ liệu đã lưu đặc biệt cho các input trong bảng
        function loadFormDataForTableInputs() {
            const savedData = localStorage.getItem(FORM_DATA_KEY);
            if (!savedData) return;
            const formData = JSON.parse(savedData);

            document.querySelectorAll('.detailed-service input[name], .detailed-service textarea[name]').forEach(input => {
                if (formData[input.name] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = formData[input.name];
                    } else {
                        input.value = formData[input.name];
                    }
                }
            });
        }

        /**
         * Hàm lấy cấp độ bảo dưỡng khuyến nghị dựa trên số KM hiện tại.
         * Tìm mốc bảo dưỡng lớn nhất nhỏ hơn hoặc bằng số KM hiện tại.
         * @param {number} currentKm - Số kilomet hiện tại của xe.
         * @returns {number|null} KM của mốc bảo dưỡng khuyến nghị, hoặc null nếu không tìm thấy.
         */
        function getRecommendedMaintenanceLevel(currentKm) {
            if (isNaN(currentKm) || currentKm <= 0) {
                return null;
            }
            let recommendedKm = null;
            // Duyệt từ các mốc KM lớn nhất xuống để tìm mốc gần nhất và nhỏ hơn hoặc bằng currentKm
            for (let i = maintenanceMilestones.length - 1; i >= 0; i--) {
                if (currentKm >= maintenanceMilestones[i].km) {
                    recommendedKm = maintenanceMilestones[i].km;
                    break;
                }
            }
            return recommendedKm;
        }

        /**
         * Hàm populate các tùy chọn cho dropdown Cấp độ bảo dưỡng, bao gồm gợi ý "khuyến khích".
         * @param {number|null} recommendedKm - KM của mốc bảo dưỡng được khuyến nghị.
         * @param {string} selectedValue - Giá trị hiện tại đang được chọn trong dropdown.
         */
        function populateMaintenanceLevels(recommendedKm = null, selectedValue = '') {
            const selectElement = document.getElementById('maintenanceLevel');
            selectElement.innerHTML = ''; // Xóa các tùy chọn hiện có

            // Thêm tùy chọn mặc định
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Chọn cấp độ --';
            selectElement.appendChild(defaultOption);

            // Thêm các tùy chọn từ maintenanceMilestones
            maintenanceMilestones.forEach(milestone => {
                const option = document.createElement('option');
                option.value = milestone.km;
                option.textContent = `${milestone.level} (${milestone.km} km)`;
                if (milestone.km === recommendedKm) {
                    option.textContent += ' (khuyến khích)';
                    // Thêm class để bôi sáng/làm nổi bật option này
                    option.classList.add('recommended-option');
                }
                selectElement.appendChild(option);
            });

            // Đặt lại giá trị đã chọn nếu có
            if (selectedValue) {
                selectElement.value = selectedValue;
            } else if (recommendedKm) {
                selectElement.value = recommendedKm; // Tự động chọn khuyến nghị nếu không có giá trị cũ
            }
            // Nếu sau khi đặt giá trị, dropdown vẫn không có giá trị nào được chọn (ví dụ: recommendedKm là null hoặc không tìm thấy trong danh sách)
            // thì đảm bảo tùy chọn mặc định '-- Chọn cấp độ --' được chọn.
            if (!selectElement.value && selectElement.options.length > 0) {
                 selectElement.value = ''; // Đảm bảo tùy chọn mặc định được chọn
            }
        }

        /**
         * Hàm cập nhật gợi ý cấp độ bảo dưỡng khi có thay đổi ở KM cũ hoặc KM hiện tại.
         */
        function updateMaintenanceLevelRecommendation() {
            // Lấy giá trị KM hiện tại và loại bỏ dấu chấm phân cách hàng nghìn
            const currentOdometerValue = parseFloat(document.getElementById('currentOdometer').value.replace(/\./g, '')) || 0;
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            const currentSelectedLevel = maintenanceLevelSelect.value; // Giữ giá trị hiện tại đang được chọn

            let recommendedKm = null;
            if (currentOdometerValue > 0) {
                recommendedKm = getRecommendedMaintenanceLevel(currentOdometerValue);
            }
            
            // Populate lại dropdown với gợi ý mới, giữ nguyên lựa chọn của người dùng nếu có
            populateMaintenanceLevels(recommendedKm, currentSelectedLevel);
            saveFormData(); // Lưu trạng thái form sau khi cập nhật gợi ý
        }


        let hasSubmitted = false; // Biến cờ kiểm tra trạng thái gửi form thành công

        // Chạy khi toàn bộ DOM đã được tải
        document.addEventListener('DOMContentLoaded', () => {
            initializeReceiptNumber(); // Khởi tạo số phiếu khi tải trang
            document.getElementById('receivedDateTime').value = getCurrentDateTimeLocal(); // Đặt ngày giờ nhận xe mặc định

            // Populating the table with predefined items first
            populateServiceTable();
            
            // Khởi tạo và populate dropdown cấp độ bảo dưỡng
            // Gọi populateMaintenanceLevels lần đầu mà không có recommendedKm để nó hiển thị tất cả các tùy chọn
            // và sau đó loadFormData sẽ xử lý việc chọn lại nếu có dữ liệu đã lưu.
            populateMaintenanceLevels(); 
            
            loadFormData(); // Tải dữ liệu form nếu có (sẽ gọi populateServiceTable lại nếu có cấp độ đã chọn)


            const form = document.getElementById('serviceReceiptForm');
            if (form) {
                // Gán sự kiện 'input' và 'change' để lưu form tự động
                form.addEventListener('input', saveFormData);
                form.addEventListener('change', saveFormData);
            }

            // Xử lý sự kiện khi chọn cấp độ bảo dưỡng
            const maintenanceLevelSelect = document.getElementById('maintenanceLevel');
            if (maintenanceLevelSelect) {
                maintenanceLevelSelect.addEventListener('change', () => {
                    const selectedKm = maintenanceLevelSelect.value ? parseInt(maintenanceLevelSelect.value) : null;
                    populateServiceTable(selectedKm);
                    saveFormData(); // Lưu trạng thái cấp độ bảo dưỡng đã chọn
                });
            }

            // Thêm sự kiện input cho trường KM cũ và KM hiện tại để cập nhật gợi ý
            const oldOdometerInput = document.getElementById('oldOdometer');
            const currentOdometerInput = document.getElementById('currentOdometer');

            if (oldOdometerInput) {
                oldOdometerInput.addEventListener('input', updateMaintenanceLevelRecommendation);
            }
            if (currentOdometerInput) {
                currentOdometerInput.addEventListener('input', updateMaintenanceLevelRecommendation);
            }


            // Xử lý sự kiện khi click nút "Gửi Thông Tin"
            const submitButton = document.getElementById('submitToSheet');
            if (submitButton) {
                submitButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Ngăn hành vi gửi form mặc định
                    const scriptURL = form.action; // Lấy URL Apps Script từ thuộc tính 'action' của form

                    // Kiểm tra validation của form
                    if (!form.checkValidity()) {
                        alert('Vui lòng điền đầy đủ các trường bắt buộc trước khi gửi!');
                        form.reportValidity(); // Hiển thị lỗi validation của trình duyệt
                        return;
                    }

                    // Vô hiệu hóa nút gửi và thay đổi text để tránh gửi nhiều lần
                    submitButton.disabled = true;
                    submitButton.textContent = 'Đang gửi...';

                    // Thu thập dữ liệu form dưới dạng URL-encoded
                    const urlEncodedData = collectFormDataAsUrlEncoded(form);

                    // Gửi dữ liệu đến Apps Script bằng Fetch API (POST request)
                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: urlEncodedData
                    })
                    .then(response => response.json().then(data => {
                        if (!response.ok) { // Kiểm tra nếu phản hồi không thành công (HTTP status code >= 400)
                            // Sử dụng String() để đảm bảo data.message là chuỗi
                            throw new Error(String(data.message || 'Lỗi từ máy chủ không xác định.'));
                        }
                        return data; // Trả về dữ liệu JSON
                    }))
                    .then(data => {
                        if (data.result === 'success') {
                            alert('✅ Gửi thông tin thành công! Bạn có thể in phiếu.');
                            console.log('Dữ liệu đã gửi:', data.data); // Log dữ liệu trả về từ Apps Script
                            hasSubmitted = true; // Đặt cờ đã gửi thành công
                        } else {
                            alert('❌ Không gửi được: ' + String(data.message || 'Lỗi không xác định từ Apps Script.')); // String() an toàn
                            console.error('Lỗi từ Apps Script:', data.message);
                        }
                    })
                    .catch(error => { // Bắt các lỗi trong quá trình fetch hoặc xử lý phản hồi
                        alert('❌ Có lỗi xảy ra khi gửi. Vui lòng kiểm tra console (F12) để biết chi tiết.');
                        console.error('Lỗi Fetch hoặc phản hồi không hợp lệ:', error);
                    })
                    .finally(() => { // Luôn chạy sau khi fetch hoàn tất (thành công hoặc lỗi)
                        submitButton.disabled = false; // Kích hoạt lại nút gửi
                        submitButton.textContent = '📤 Gửi Thông Tin'; // Đặt lại text nút
                    });
                });
            }

            // Xử lý sự kiện khi click nút "In Phiếu"
            const printButton = document.getElementById('printButton');
            if (printButton) {
                printButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Ngăn hành vi in mặc định
                    if (!hasSubmitted) { // Yêu cầu gửi form trước khi in
                        alert('Vui lòng nhấn "Gửi Thông Tin" trước khi in phiếu!');
                        return;
                    }
                    incrementReceiptNumberOnPrint(); // Tăng số phiếu trước khi in
                    window.print(); // Kích hoạt hộp thoại in
                });
            }

            // Xử lý sự kiện khi click nút "Xóa Form"
            const clearFormButton = document.getElementById('clearFormButton');
            if (clearFormButton) {
                clearFormButton.addEventListener('click', () => {
                    // Thay thế confirm() bằng modal tùy chỉnh
                    showCustomConfirm('Bạn có chắc chắn muốn xóa toàn bộ thông tin trên form không? (Chỉ xóa sau khi đã in thành công)', () => {
                        resetFormAndLocalStorage(); // Gọi hàm reset form
                    });
                });
            }
        });

        // Hàm thu thập dữ liệu form và mã hóa thành URL-encoded string
        function collectFormDataAsUrlEncoded(formElement) {
            const params = new URLSearchParams();

            // Collect all named inputs, textareas, and selects
            const formElements = formElement.querySelectorAll('input[name], textarea[name], select[name]');

            formElements.forEach(element => {
                let name = element.name;
                let value;

                if (element.type === 'checkbox') {
                    value = element.checked ? 'on' : ''; // Mimic FormData behavior for checkboxes
                } else if (element.type === 'radio') {
                    // Only get value if checked, handled by FormData.
                    // We'll handle unselected radio groups later.
                    if (element.checked) {
                        value = element.value;
                    } else {
                        return; // Skip unchecked radios for now, they are handled by the outer loop
                    }
                } else {
                    value = element.value;
                }

                // Ensure 'value' is a string using robust coercion (value + '')
                let safeValue = value + ''; 

                // Apply transformations to 'safeValue'
                if (name.endsWith('_thanhTien')) {
                    console.log(`DEBUG: Processing _thanhTien. Name: ${name}, safeValue before replace: '${safeValue}', typeof safeValue: ${typeof safeValue}, isString: ${typeof safeValue === 'string'}`);
                    // Ensure it's a string before calling replace
                    if (typeof safeValue === 'string') { 
                        safeValue = safeValue.replace(/\./g, '').replace(/,/g, '.');
                    } else {
                        console.error(`ERROR: safeValue for ${name} is not a string (type: ${typeof safeValue}). Falling back to empty string.`);
                        safeValue = ''; 
                    }
                    console.log(`DEBUG: safeValue after replace: '${safeValue}'`);
                }
                else if (name.endsWith('_xacNhan')) {
                    // For checkboxes named service_xacNhan_X, convert 'on' to 'X'
                    safeValue = (element.type === 'checkbox' && element.checked) ? 'X' : '';
                }
                else if (name === 'sokmcu' || name === 'sokmhientai') {
                    console.log(`DEBUG: Processing KM. Name: ${name}, safeValue before replace: '${safeValue}', typeof safeValue: ${typeof safeValue}, isString: ${typeof safeValue === 'string'}`);
                    // Ensure it's a string before calling replace
                    if (typeof safeValue === 'string') { 
                        safeValue = safeValue.replace(/\./g, '');
                    } else {
                        console.error(`ERROR: safeValue for ${name} is not a string (type: ${typeof safeValue}). Falling back to empty string.`);
                        safeValue = ''; 
                    }
                    console.log(`DEBUG: safeValue after replace: '${safeValue}'`);
                }
                params.append(name, safeValue);
            });

            // Ensure unchecked checkboxes are included with empty string values
            formElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked && !params.has(checkbox.name)) {
                    params.append(checkbox.name, '');
                }
            });

            // Ensure unselected radio groups are included with empty string values
            const radioGroupNames = new Set();
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroupNames.add(radio.name));
            radioGroupNames.forEach(groupName => {
                const checkedRadioInGroup = formElement.querySelector(`input[type="radio"][name="${groupName}"]:checked`);
                if (!checkedRadioInGroup && !params.has(groupName)) {
                    params.append(groupName, '');
                }
            });

            // Add static fields (formType, receiptNumber, currentMonthYear)
            params.append('formType', formElement.querySelector('[name="formType"]').value);
            params.append('receiptNumber', document.getElementById('receiptNumber')?.textContent || '');
            params.append('currentMonthYear', document.getElementById('currentMonth')?.textContent || '');

            return params.toString();
        }

        // Hàm hiển thị modal xác nhận tùy chỉnh (thay thế alert/confirm)
        function showCustomConfirm(message, onConfirm) {
            const modalId = 'customConfirmModal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                    position: fixed;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    font-family: Arial, sans-serif;
                `;
                modal.innerHTML = `
                    <div style="
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        text-align: center;
                        max-width: 400px;
                        width: 90%;
                    ">
                        <p style="margin-bottom: 20px; font-size: 16px;">${message}</p>
                        <button id="confirmYes" style="
                            padding: 10px 20px;
                            margin: 0 10px;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                            background-color: #007bff;
                            color: white;
                        ">Đồng ý</button>
                        <button id="confirmNo" style="
                            padding: 10px 20px;
                            margin: 0 10px;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                            background-color: #6c757d;
                            color: white;
                        ">Hủy</button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    onConfirm();
                    modal.style.display = 'none';
                };
                document.getElementById('confirmNo').onclick = () => {
                    modal.style.display = 'none';
                };
            } else {
                modal.querySelector('p').textContent = message;
                modal.style.display = 'flex';
                document.getElementById('confirmYes').onclick = () => {
                    onConfirm();
                    modal.style.display = 'none';
                };
            }
            modal.style.display = 'flex';
        }
    </script>
</body>
</html>
